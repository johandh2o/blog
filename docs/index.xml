<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Johan de Aguas</title>
<link>https://johandh2o.github.io/index.html</link>
<atom:link href="https://johandh2o.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.353</generator>
<lastBuildDate>Sun, 07 Jan 2024 23:00:00 GMT</lastBuildDate>
<item>
  <title>A semi-formal presentation of targeted minimum loss estimation (TMLE)</title>
  <link>https://johandh2o.github.io/posts/2024-01-08_EIFTMLE/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="what-is-tmle" class="level2">
<h2 class="anchored" data-anchor-id="what-is-tmle">What is TMLE?</h2>
<p><em>Targeted minimum loss estimation</em> (TMLE) is a flexible and powerful framework, introduced by <strong>Susan Gruber</strong> and <strong>Mark van der Laan</strong>, for estimating statistical and causal parameters from data. It combines the benefits of multiply-robustness estimation via influence functions with an optimal targeting approach, making it well-suited for causal inference with observational data, where the treatment or outcome models might be misspecified <span class="citation" data-cites="gruber2009targeted">(Gruber and Laan 2009)</span>.</p>
<p>Let us present the TMLE framework at two levels:</p>
<ol type="1">
<li>A methodological recipe for the ATE in an observational study, with no detailed explanations</li>
<li>A semi-formal motivation and presentation of the efficient influence function (EIF) and the TMLE</li>
</ol>
<p>Despite EFI-based and TMLE-based inference having rich and very useful properties for semiparametric causal inference, it’s not until recently they have been adopted more broadly. These methods tend to be perceived as too abstract, too technical or too esoteric for more applied research. Here some resources to start approaching the subject:</p>
<ul>
<li><em>Visually communicating and teaching intuition for influence functions</em>, <span class="citation" data-cites="fisher2021visually">Fisher and Kennedy (2021)</span></li>
<li><em>Demystifying statistical learning based on efficient influence functions</em>, <span class="citation" data-cites="hines2022demystifying">Hines et al. (2022)</span></li>
<li><em>An illustrated guide to TMLE</em>, <span class="citation" data-cites="ilustrated">Hoffman (2020)</span></li>
<li><em>Targeted maximum likelihood estimation: A gentle introduction</em> (<strong>seminal paper</strong>), <span class="citation" data-cites="gruber2009targeted">Gruber and Laan (2009)</span></li>
</ul>
</section>
<section id="a-tmle-recipe-for-the-ate-in-an-observational-study" class="level2">
<h2 class="anchored" data-anchor-id="a-tmle-recipe-for-the-ate-in-an-observational-study">A TMLE recipe for the ATE in an observational study</h2>
<p>We want to estimate the average treatment effect (ATE) of a binary treatment <img src="https://latex.codecogs.com/png.latex?A"> on a continuous outcome <img src="https://latex.codecogs.com/png.latex?Y"> in a system with confounders <img src="https://latex.codecogs.com/png.latex?W">. The ATE is a causal parameter <img src="https://latex.codecogs.com/png.latex?%5Cpsi">, that can be seen as a <em>functional</em> <img src="https://latex.codecogs.com/png.latex?%5CPsi"> of the observational distribution <img src="https://latex.codecogs.com/png.latex?P_0"> induced by a structural causal model (SCM).</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20%20=%20%5Cunderbrace%7B%5CDelta_a%5Cmathbb%7BE%7D%5BY%5Cmid%5Coperatorname%7Bdo%7D(A=a)%5D%7D_%7B%5Ctext%7Bcausal%20parameter%7D%7D%20=%20%5Cunderbrace%7B%5CPsi%5BP_0%5D%7D_%7B%5Ctext%7Bidentification%7D%7D%20=%20%5Cunderbrace%7B%5Cmathbb%7BE%7D_W%5CDelta_a%5Cmathbb%7BE%7D%5BY%5Cmid%20W,%20A=a%5D%7D_%7B%5Ctext%7Bstatistical%20parameter%7D%7D%0A"> Then, a simple TMLE-based recipe to construct a consistent and efficient estimator <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D_%7B%5Cstar%7D"> consist of six steps:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 1: Fit initial models for the conditional outcome expectation and for the propensity score
</div>
</div>
<div class="callout-body-container callout-body">
<p>Such models can be fitted by any parametric or semiparametric procedure, provided no overfitting*. <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Chat%7BQ%7D(A,W)%20&amp;=%20%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20W,%20A%5D%5C%5C%0A%5Chat%7BG%7D(W)%20&amp;=%20%5Chat%7B%5Cmathbb%7BP%7D%7D(A=1%5Cmid%20W)%0A%5Cend%7Baligned%7D%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 2: Derive the efficient influence function (EIF)
</div>
</div>
<div class="callout-body-container callout-body">
<p>The efficient influence function (EIF) of <img src="https://latex.codecogs.com/png.latex?%5CPsi"> at <img src="https://latex.codecogs.com/png.latex?P_0"> for observation <img src="https://latex.codecogs.com/png.latex?(W_i,A_i,Y_i)"> is just the sum of two (orthogonal) components:</p>
<ol type="1">
<li>The “error” of the outcome model (conditional expectation / CATE) with respect to the true ATE</li>
<li>The “error” of the outcome model multiplied by <em>inverse probability of treatment</em> (IPW) weight</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BEIF%7D_%7B%5CPsi,P_0%7D(W_i,A_i,Y_i)%20=%20%5Cunderbrace%7B%5CDelta_aQ(a,W_i)-%5Cpsi%7D_%7B%5Ctext%7BCATE%20-%20ATE%7D%7D%20+%20%5Cunderbrace%7B(Y_i-Q(A_i,W_i))%7D_%7B%5Ctext%7B%22error%22%20of%20outcome%20model%7D%7D%5Ccdot%5Cunderbrace%7B%5Cleft%5B%5Cfrac%7BA_i%7D%7BG(W_i)%7D-%5Cfrac%7B1-A_i%7D%7B1-G(W_i)%7D%20%5Cright%5D%7D_%7B%5Ctext%7BIPW%7D%7D%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 3: Create the clever covariates
</div>
</div>
<div class="callout-body-container callout-body">
<p>The coefficient of the error of the outcome model in the EIF, based on the IPW weights, defines the <em>clever covariate</em> <img src="https://latex.codecogs.com/png.latex?H_i">. Using the treatment model fitted in step 1, such covariate can be computed for unit <img src="https://latex.codecogs.com/png.latex?i"> in three scenarios: observed, under treatment and under control:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Chat%7BH%7D_i%20&amp;=%20%5Cfrac%7BA_i%7D%7B%5Chat%7BG%7D(W_i)%7D-%5Cfrac%7B1-A_i%7D%7B1-%5Chat%7BG%7D(W_i)%7D%5C%5C%0A%5Chat%7BH%7D_i%5E1%20&amp;=%20%5Cfrac%7B1%7D%7B%5Chat%7BG%7D(W_i)%7D%5C%5C%0A%5Chat%7BH%7D_i%5E0%20&amp;=%20%5Cfrac%7B-1%7D%7B1-%5Chat%7BG%7D(W_i)%7D%0A%5Cend%7Baligned%7D%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 4: Find the optimal fluctuation parameter
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fit a linear regression model <strong>with no intercept</strong>, where the dependent variable is the residuals by the fitted initial outcome model, and the only predictor is the computed <em>observed</em> clever covariate <img src="https://latex.codecogs.com/png.latex?%5Chat%7BH%7D_i">. Let us call with <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> the coefficient of <img src="https://latex.codecogs.com/png.latex?%5Chat%7BH%7D_i"> in this regression.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY_i%20-%20%5Chat%7BQ%7D(W_i,A_i)%5Csim%20%5Cepsilon%5Chat%7BH%7D_i%0A"></p>
<p>Then, the value of <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cepsilon%7D"> is the estimated optimal fluctuation parameter.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 5: Update the conditional outcome expectation model
</div>
</div>
<div class="callout-body-container callout-body">
<p>Update the initial outcome model using the estimated optimal fluctuation parameter <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cepsilon%7D"> for two scenarios: under treatment and under control, using the respective clever covariate</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctilde%7BQ%7D%5E1_i%20&amp;=%20%5Chat%7BQ%7D(W_i,1)%20+%20%5Chat%7B%5Cepsilon%7D%5Chat%7BH%7D_i%5E1%5C%5C%0A%5Ctilde%7BQ%7D%5E0_i%20&amp;=%20%5Chat%7BQ%7D(W_i,0)%20+%20%5Chat%7B%5Cepsilon%7D%5Chat%7BH%7D_i%5E0%0A%5Cend%7Baligned%7D%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Step 6: Compute the updated estimator
</div>
</div>
<div class="callout-body-container callout-body">
<p>The average contrast (treatment vs control) of the updated predictions of mean outcome, across all the i.i.d-sampled units, is the TMLE estimator.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Cpsi%7D_%7B%5Cstar%7D%20=%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20(%5Ctilde%7BQ%7D%5E1_i-%5Ctilde%7BQ%7D%5E0_i)%0A"> To do inference and compute confidence intervals, an estimator of its standard error can be computed directly from the unit-level estimates of the EIF, as <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Csigma%7D%20=%20%5Csqrt%7B%5Chat%7B%5Coperatorname%7Bvar%7D%7D(%5Coperatorname%7BEIF%7D_i)/n%7D"></p>
</div>
</div>
</section>
<section id="a-semi-formal-motivation-and-presentation" class="level2">
<h2 class="anchored" data-anchor-id="a-semi-formal-motivation-and-presentation">A semi-formal motivation and presentation</h2>
<section id="the-influence-function-if" class="level3">
<h3 class="anchored" data-anchor-id="the-influence-function-if">The influence function (IF)</h3>
<blockquote class="blockquote">
<p>The influence function of a parameter measures its sensitivity to small perturbations in the underlying distribution. It is very important for inference, as it gives all the information to describe the assymptotic bias and variance of certain kind of estimators (RAL).</p>
</blockquote>
<p>To motivate the use of the influence function (IF) of a <em>functional</em>, let us first consider the more common case of <em>function approximation</em>.</p>
<p>Consider that we have a smooth function <img src="https://latex.codecogs.com/png.latex?L:%5Cmathbb%7BR%7D%5Ed%5Crightarrow%5Cmathbb%7BR%7D">. A <strong>Taylor series expansion</strong> allows us to express the value of <img src="https://latex.codecogs.com/png.latex?f"> at <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> in terms of another value <img src="https://latex.codecogs.com/png.latex?%5Ctheta_0">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20f(%5Ctheta_1)%20&amp;=%20f(%5Ctheta_0)%20+%20%5Cgrad%7Bf(%5Ctheta_0)%7D%5E%5Ctop%20(%5Ctheta_1-%5Ctheta_0)+%20%5Cfrac%7B1%7D%7B2%7D(%5Ctheta_1-%5Ctheta_0)%5E%5Ctop%20%5Cgrad%5E2%20f(%5Ctheta_0)%5Ccdot%20(%5Ctheta_1-%5Ctheta_0)%20+%5Ccdots%5C%5C%0A%20%20%20%20&amp;=%20f(%5Ctheta_0)%20+%20%5Cgrad%7Bf(%5Ctheta_0)%7D%5E%5Ctop%20(%5Ctheta_1-%5Ctheta_0)+%20R_2,%5Cquad%20%5Ctext%7B%20with%20%7D%20R_2%20=%20O(%5Cnorm%7B%5Ctheta_1-%5Ctheta_0%7D%5E2)%5C%5C%0A%20%20%20%20%20%5Cunderbrace%7Bf(%5Ctheta_1)%20-%20f(%5Ctheta_0)%7D_%7B%5Ctext%7Bbias%7D%7D%20&amp;=%20%5Cunderbrace%7B%5Cgrad%7Bf(%5Ctheta_0)%7D%5E%5Ctop%20(%5Ctheta_1-%5Ctheta_0)%7D_%7B%5Ctext%7Bdirectional%20derivative%7D%7D+%20%5Cunderbrace%7BR_2%7D_%7B%5Ctext%7B2nd%20order%7D%7D%0A%5Cend%7Baligned%7D%0A"> This is, we can compute the bias of <em>approximating <img src="https://latex.codecogs.com/png.latex?f(%5Ctheta_1)"> with <img src="https://latex.codecogs.com/png.latex?f(%5Ctheta_0)"></em> as the inner product of the <strong>gradient at <img src="https://latex.codecogs.com/png.latex?%5Ctheta_0"></strong> with the differential <img src="https://latex.codecogs.com/png.latex?(%5Ctheta_1-%5Ctheta_0)"> plus a <strong>second-order remainder</strong>.</p>
<p>When <img src="https://latex.codecogs.com/png.latex?L"> is the log-likelihood function of parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> in a statistical model, such an expansion allows us to approximate the asymptotic distribution of the MLE estimator <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1=%5Chat%7B%5Ctheta%7D">. This is known as the <strong>delta method</strong> <span class="citation" data-cites="deltaMethod">(Doob 1935)</span>.</p>
<blockquote class="blockquote">
<p>What if <img src="https://latex.codecogs.com/png.latex?f"> is not a function, but a <em>functional</em>? Can we do a similar kind of approximation?</p>
</blockquote>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Functionals
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the most general sense, a functional is a function that takes another function as an input and returns a “value”, usually numeric, as an output. For instance:</p>
<ul>
<li>The expected value of a real random variable <img src="https://latex.codecogs.com/png.latex?X">, <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BX%5D">, is a functional: it takes its CDF <img src="https://latex.codecogs.com/png.latex?P_X"> and returns a value <img src="https://latex.codecogs.com/png.latex?%5Cmu%5Cin%5Cmathbb%7BR%7D"></li>
<li>The ATE of a binary treatment <img src="https://latex.codecogs.com/png.latex?A"> on a real outcome <img src="https://latex.codecogs.com/png.latex?Y">, <img src="https://latex.codecogs.com/png.latex?%5CDelta_a%5Cmathbb%7BE%7D%5BY%5Cmid%5Coperatorname%7Bdo%7D(A=a)%5D">, is a functional: it takes the interventional distribution <img src="https://latex.codecogs.com/png.latex?P(Y%5Cmid%5Coperatorname%7Bdo%7D(A=a))"> (or the SCM-induced observational distribution <img src="https://latex.codecogs.com/png.latex?P_0">) and returns a value <img src="https://latex.codecogs.com/png.latex?%5Cpsi%5Cin%5Cmathbb%7BR%7D"></li>
</ul>
</div>
</div>
<p>There are, in fact, <strong>functional Taylor series expansion</strong> and <strong>functional delta method</strong> as extensions to variational calculus <span class="citation" data-cites="asymptotic">(Vaart 2000)</span>. However, to apply it, <img src="https://latex.codecogs.com/png.latex?%5CPsi"> has to be <em>pathwise differentiable</em> (its ‘derivative’ has to exist). Then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20%5CPsi%5BP_1%5D%20-%20%5CPsi%5BP_0%5D%20&amp;=%20%5Cunderbrace%7B%5Cdv%7B%5Cepsilon%7D%5Ceval%7B%5CPsi%5BP_0+%5Cepsilon(P_1-P_0)%5D%7D_%7B%5Cepsilon=0%7D%7D_%7B%5Ctext%7BG%C3%A2teaux%20derivative%7D%7D%20+%20%5Cunderbrace%7BR_2%7D_%7B%5Ctext%7B2nd%20order%7D%7D%5C%5C%0A%20%20%20%20&amp;=%20%5Cint%20%5Cunderbrace%7B%5Cdv%7B%5Cepsilon%7D%5Ceval%7B%5CPsi%5BP_0+%5Cepsilon%5Cdelta_x%5D%7D_%7B%5Cepsilon=0%7D%7D_%7B%5Ctext%7Bfunctional%20derivative%7D%7D%20%5Cdd(P_1-P_0)(x)%20+%20R_2%0A%5Cend%7Baligned%7D%0A"> Where <img src="https://latex.codecogs.com/png.latex?R_2"> is a second-order term, measured using an appropiate distance between distributions, <img src="https://latex.codecogs.com/png.latex?R_2=O(%5Cnorm%7BP_1-P_0%7D%5E2)">.</p>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Cdv%7B%5Cepsilon%7D%5Ceval%7B%5CPsi%5BP_0+%5Cepsilon%5Cdelta_x%5D%7D_%7B%5Cepsilon=0%7D"> exists, <img src="https://latex.codecogs.com/png.latex?%5CPsi"> is said to be pathwise differentiable and such derivative is named <strong>influence function</strong> of <img src="https://latex.codecogs.com/png.latex?%5CPsi"> at <img src="https://latex.codecogs.com/png.latex?(P_0,x)">.</p>
<blockquote class="blockquote">
<p>The IF quantifies the sensitivity of <img src="https://latex.codecogs.com/png.latex?%5CPsi"> to a mixture of <img src="https://latex.codecogs.com/png.latex?P_0"> with a point mass at <img src="https://latex.codecogs.com/png.latex?x"> by an infinitessimal amount. In other words, it measures how much the target changes when we perturb the distribution by adding a tiny more of the observation <img src="https://latex.codecogs.com/png.latex?x">.</p>
</blockquote>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20%5CPsi%5BP_1%5D%20-%20%5CPsi%5BP_0%5D%20&amp;=%20%5Cint%20%5Ctext%7BIF%7D_%7B%5CPsi,P_0%7D(x)%5C,%5Cdd(P_1-P_0)(x)%20+%20R_2%0A%5Cend%7Baligned%7D%0A"> An important property of the IF, which is consequence of the Fundamental Theorem of Calculus (and the properties of Dirac distributions), is that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cint%20%5Ctext%7BIF%7D_%7B%5CPsi,P_0%7D(x)%5C,%5Cdd%20P_0(x)%20=%20%5Cmathbb%7BE%7D_%7BX%5Csim%20P_0%7D%5Ctext%7BIF%7D_%7B%5CPsi,P_0%7D(X)%20=%200%0A"></p>
<blockquote class="blockquote">
<p>If we contaminate the true distribution with perturbations coming from <em>the same</em> distribution, there should be no expected change in the target.</p>
</blockquote>
<p>Now consider the case where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?P_0"> is the true distribution, which is unknown. This is, <img src="https://latex.codecogs.com/png.latex?%5Cpsi=%5CPsi%5BP_0%5D"> is the true value of the target.</li>
<li>We live in a fully nonparametric world and have access to a fully nonparametric estimate of <img src="https://latex.codecogs.com/png.latex?P_0">, denoted <img src="https://latex.codecogs.com/png.latex?P_1=%5Chat%7BP%7D_n"> and computed with <img src="https://latex.codecogs.com/png.latex?n"> samples and an empirical average in the outer-most submodel. Thus, a natural estimator of <img src="https://latex.codecogs.com/png.latex?%5Cpsi"> is the <strong>plug-in</strong> <img src="https://latex.codecogs.com/png.latex?%5CPsi%5B%5Chat%7BP%7D_n%5D">.</li>
</ul>
<blockquote class="blockquote">
<p>It turns out that if the world-model is fully nonparametric/saturated, the influence function is unique and then it’s called <em>efficient influence function</em> (EIF) or <em>canonical gradient</em>.</p>
</blockquote>
<p>Then, by all the above: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20%5CPsi%5B%5Chat%7BP%7D_n%5D%20-%20%5CPsi%5BP_0%5D%20&amp;=%20%5Cint%20%5Ctext%7BEIF%7D_%7B%5CPsi,P_0%7D(x)%5C,%5Cdd(%5Chat%7BP%7D_n-P_0)(x)%20+%20R_2%5C%5C%0A%20%20%20%20&amp;=%20%5Cmathbb%7BE%7D_%7BX%5Csim%20%5Chat%7BP%7D_n%7D%5Ctext%7BEIF%7D_%7B%5CPsi,P_0%7D(X)-0%20+%20R_2%5C%5C%0A%20%20%20%20&amp;=%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20%5Ctext%7BEIF%7D_%7B%5CPsi,P_0%7D(X_i)%20+%20R_2%0A%5Cend%7Baligned%7D%0A"></p>
<blockquote class="blockquote">
<p>Why is the EIF importat?</p>
</blockquote>
<p>Using heavily technical tools from the theory of empirical processes (regularity, Hadamard differentiability, von Mises calculus, Gaussian process convergence, etc) it can be shown that, if the models used to construct <img src="https://latex.codecogs.com/png.latex?%5Chat%7BP%7D_n"> are in a <img src="https://latex.codecogs.com/png.latex?P_0">-Donsker class; i.e., <strong>these models do not overfit the data</strong>; then <img src="https://latex.codecogs.com/png.latex?R_2"> goes to zero very quickly.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5CPsi%5B%5Chat%7BP%7D_n%5D%20-%20%5CPsi%5BP_0%5D%20=%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20%5Ctext%7BEIF%7D_%7B%5CPsi,P_0%7D(X_i)%20+%20o_p(n%5E%7B-1/2%7D)%0A"> This means that:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5CPsi%5B%5Chat%7BP%7D_n%5D"> is a <em>regular asymptotic linear</em> estimator (RAL). The best kind!</li>
<li>In large samples, the second-order bias does not matter. <strong>Most of the bias is contained in the EIF</strong>!</li>
<li>We can do inference, as the <em>central limit theorem</em> (CLT) allows us to use a Gaussian approximation. Even if we used fancy machine learning methods to construct <img src="https://latex.codecogs.com/png.latex?%5Chat%7BP%7D_n">, provided the Donsker class condition.</li>
</ul>
</section>
</section>
<section id="back-to-tmle" class="level2">
<h2 class="anchored" data-anchor-id="back-to-tmle">Back to TMLE</h2>
<section id="why-the-eif-is-important-then" class="level3">
<h3 class="anchored" data-anchor-id="why-the-eif-is-important-then">Why the EIF is important then?</h3>
<blockquote class="blockquote">
<p>Under some conditions the EIF, it helps us remove a big chunk of bias from an estimator of the target parameter, and allows us to do valid inference even when using machine learning methods.</p>
</blockquote>
<p>The idea of TMLE is to update <img src="https://latex.codecogs.com/png.latex?%5Chat%7BP%7D_n"> to <img src="https://latex.codecogs.com/png.latex?%5Chat%7BP%7D_n%5E*"> such that the approximate bias, given by an estimated-perturbed EIF, is zero <span class="citation" data-cites="TMLEbook1">(van der Laan and Rose 2011)</span>. <img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5CPsi%5B%5Chat%7BP%7D%5E*_n%5D%20-%20%5CPsi%5BP_0%5D%20%5Capprox%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20%5Ctext%7BEIF%7D_%7B%5CPsi,%5Chat%7BP%7D%5E*_n%7D(X_i)%20=%200%0A"></p>
</section>
<section id="where-is-the-loss-function" class="level3">
<h3 class="anchored" data-anchor-id="where-is-the-loss-function">Where is the loss function?</h3>
<blockquote class="blockquote">
<p>Making the estimated-perturbed EIF equals zero can be achieved via minimizing an empirical risk based on an appropriate loss function over a fluctuation parameter (defining the perturbed models).</p>
</blockquote>
<p>Let us go back to the simple example on the TMLE recipe for the ATE in an observational study. We want to estimate the ATE using TMLE, and we consider perturbations <strong>only on the conditional expectation of the outcome</strong>, so we do not update the treatment model. Let us work backward and consider a linear-in-means perturbation using an unknown clever covariate, so that <img src="https://latex.codecogs.com/png.latex?%5Cepsilon=0"> means <em>“no update”</em>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AQ_%5Cepsilon(A,W)%20=%20Q(A,W)%20+%20%5Cepsilon%20H%0A"> The estimated EFI under such perturbation is then: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%5Coperatorname%7BEIF%7D_%7B%5CPsi,%5Chat%7BQ%7D_%5Cepsilon%7D(W_i,A_i,Y_i)%20&amp;=%20%5Cunderbrace%7B%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%5CDelta_a%5Chat%7BQ%7D_%5Cepsilon(a,W_i)-%5Cpsi%7D_%7B%5Ctext%7Bgoes%20to%20zero%7D%7D%20+%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%5Cunderbrace%7B(Y_i-%5Chat%7BQ%7D_%5Cepsilon(A_i,W_i))%7D_%7B%5Ctext%7B%22error%22%20of%20outcome%20model%7D%7D%5Ccdot%5Cunderbrace%7B%5Cleft%5B%5Cfrac%7BA_i%7D%7B%5Chat%7BG%7D(W_i)%7D-%5Cfrac%7B1-A_i%7D%7B1-%5Chat%7BG%7D(W_i)%7D%20%5Cright%5D%7D_%7B%5Ctext%7BIPW%7D%7D%5C%5C%0A&amp;%5Capprox%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20(Y_i-%5Chat%7BQ%7D_%5Cepsilon(A_i,W_i))%5Ccdot%5Cleft%5B%5Cfrac%7BA_i%7D%7B%5Chat%7BG%7D(W_i)%7D-%5Cfrac%7B1-A_i%7D%7B1-%5Chat%7BG%7D(W_i)%7D%20%5Cright%5D%5C%5C%0A&amp;%5Capprox%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En(Y_i-%5Chat%7BQ%7D(A_i,W_i)-%5Cepsilon%20H_i)%5Ccdot%5Cleft%5B%5Cfrac%7BA_i%7D%7B%5Chat%7BG%7D(W_i)%7D-%5Cfrac%7B1-A_i%7D%7B1-%5Chat%7BG%7D(W_i)%7D%20%5Cright%5D%0A%5Cend%7Baligned%7D%5C%5C%0A"> Now consider the <strong>square loss</strong> <img src="https://latex.codecogs.com/png.latex?L(y,%5Chat%7By%7D)=%5Cfrac%7B1%7D%7B2%7D(y-%5Chat%7By%7D)%5E2"> and the associated empirical risk <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D=%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5E%7Bn%7DL(y_i,%5Chat%7By%7D_i)">. If we apply it for the perturbed outcome model, and compute its derivative with respect to <img src="https://latex.codecogs.com/png.latex?%5Cepsilon">, we get: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cmathcal%7BR%7D%20&amp;=%20%5Cfrac%7B1%7D%7B2n%7D%5Csum_%7Bi=1%7D%5En(Y_i-%5Chat%7BQ%7D(A_i,W_i)-%5Cepsilon%20H_i)%5E2%5C%5C%0A%5Cdv%7B%5Cmathcal%7BR%7D%7D%7B%5Cepsilon%7D%20&amp;=%20%5Cfrac%7B-1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En(Y_i-%5Chat%7BQ%7D(A_i,W_i)-%5Cepsilon%20H_i)%5Ccdot%20H_i%0A%5Cend%7Baligned%7D%0A"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Voilà
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <img src="https://latex.codecogs.com/png.latex?%5Cepsilon">-minimizer of this risk/loss is the value <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cepsilon%7D"> that makes the derivative equals zero. <strong>Notice this is the same value of <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> that would make the estimated-perturbed EIF equals zero, when <img src="https://latex.codecogs.com/png.latex?H=%5Ctext%7BIPW%7D"></strong>. So this is why it is a <strong>clever</strong> covariate!</p>
<p>As a consequence, we just need to regress the errors of the initial outcome model against such clever covariate (with no intercepts), and its estimated regression coefficient would give us exactly the value <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cepsilon%7D"> required to update the outcome model such that the estimated plug-in bias is zero.</p>
<p>The TMLE estimator is, as shown before, constructed as: <img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Cpsi%7D_%7B%5Cstar%7D%20=%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%20(%5Ctilde%7BQ%7D%5E1_i-%5Ctilde%7BQ%7D%5E0_i)%20=%20%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5EN%20%5Cleft%5B%5Chat%7BQ%7D(W_i,1)-%5Chat%7BQ%7D(W_i,0)+%5Chat%7B%5Cepsilon%7D%5Cleft(%5Cfrac%7B1%7D%7B%5Chat%7BG%7D(W_i)%7D-%5Cfrac%7B1%7D%7B1-%5Chat%7BG%7D(W_i)%7D%20%5Cright)%5Cright%5D%0A"></p>
</div>
</div>
</section>
<section id="what-are-actually-the-clever-covariates" class="level3">
<h3 class="anchored" data-anchor-id="what-are-actually-the-clever-covariates">What are actually the clever covariates?</h3>
<blockquote class="blockquote">
<p>The clever covariates are the projection, in a Hilbert space sense, of the orthogonal components of the canonical gradient onto the nuisance tangent space</p>
</blockquote>
<p>Yuck!</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-deltaMethod" class="csl-entry">
Doob, Joseph L. 1935. <span>“The Limiting Distributions of Certain Statistics.”</span> <em>Annals of Mathematical Statistics</em> 6 (3): 160–69. <a href="https://www.jstor.org/stable/2957546">https://www.jstor.org/stable/2957546</a>.
</div>
<div id="ref-fisher2021visually" class="csl-entry">
Fisher, Aaron, and Edward H Kennedy. 2021. <span>“Visually Communicating and Teaching Intuition for Influence Functions.”</span> <em>The American Statistician</em> 75 (2): 162–72.
</div>
<div id="ref-gruber2009targeted" class="csl-entry">
Gruber, Susan, and Mark J van der Laan. 2009. <span>“Targeted Maximum Likelihood Estimation: A Gentle Introduction.”</span> <em>The American Statistician</em> 63 (4): 1–38.
</div>
<div id="ref-hines2022demystifying" class="csl-entry">
Hines, Oliver, Oliver Dukes, Karla Diaz-Ordaz, and Stijn Vansteelandt. 2022. <span>“Demystifying Statistical Learning Based on Efficient Influence Functions.”</span> <em>The American Statistician</em> 76 (3): 292–304.
</div>
<div id="ref-ilustrated" class="csl-entry">
Hoffman, Katherine. 2020. <span>“An Illustrated Guide to TMLE, Part i: Introduction and Motivation.”</span> <em>Kat’s Stats</em>. <a href="https://www.khstats.com/blog/tmle/tutorial">https://www.khstats.com/blog/tmle/tutorial</a>.
</div>
<div id="ref-asymptotic" class="csl-entry">
Vaart, A. W. van der. 2000. <em>Asymptotic Statistics</em>. Cambridge University Press. <a href="https://EconPapers.repec.org/RePEc:cup:cbooks:9780521784504">https://EconPapers.repec.org/RePEc:cup:cbooks:9780521784504</a>.
</div>
<div id="ref-TMLEbook1" class="csl-entry">
van der Laan, Mark J., and S. Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.no/books?id=RGnSX5aCAgQC">https://books.google.no/books?id=RGnSX5aCAgQC</a>.
</div>
</div></section></div> ]]></description>
  <category>semiparametric</category>
  <category>nonparametric</category>
  <category>IPW</category>
  <category>TMLE</category>
  <guid>https://johandh2o.github.io/posts/2024-01-08_EIFTMLE/index.html</guid>
  <pubDate>Sun, 07 Jan 2024 23:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2024-01-08_EIFTMLE/logo.png" medium="image" type="image/png" height="132" width="144"/>
</item>
<item>
  <title>Simulation task: recovering causal effects from post-treatment selection induced by missing outcome data</title>
  <link>https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>The goal is to estimate the <strong>average treatment effect (ATE)</strong> of a binary treatment on a continuous outcome, from <strong>observational data</strong> where <strong>the outcome is subject to a missingness/selection mechanism</strong>.</p>
<p>For this task, we employ:</p>
<ul>
<li>The structural causal models (SCM) framework <span class="citation" data-cites="PearlCausality">(Pearl 2009)</span></li>
<li>A generated observational dataset</li>
<li>A back-door admissible set of pre-treatment variables; i.e., the assumption of no latent confounding</li>
<li>A missing-outcome mechanism that allows recoverability via IPW and regression adjustment</li>
<li>The targeted minimum-loss estimation (TMLE) framework <span class="citation" data-cites="TMLEbook1">(van der Laan and Rose 2011)</span></li>
</ul>
</section>
<section id="generated-data-from-substantive-model-and-missingness-mechanism" class="level2">
<h2 class="anchored" data-anchor-id="generated-data-from-substantive-model-and-missingness-mechanism">Generated data from substantive model and missingness mechanism</h2>
<p>We build a directed acyclic graph (DAG) <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, involving the exposure <img src="https://latex.codecogs.com/png.latex?A">, the outcome <img src="https://latex.codecogs.com/png.latex?Y">, a confounder variable <img src="https://latex.codecogs.com/png.latex?W">, mediators of the effect <img src="https://latex.codecogs.com/png.latex?M,Z">, and missingness mechanism for the outcome <img src="https://latex.codecogs.com/png.latex?R"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DAG visualization</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dagitty)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdag)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb1-7">  A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W,</span>
<span id="cb1-8">  M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A,</span>
<span id="cb1-9">  Z <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M,</span>
<span id="cb1-10">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z,</span>
<span id="cb1-11">  R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z</span>
<span id="cb1-12">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layout =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kk"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>A fixed set of causal mechanisms <img src="https://latex.codecogs.com/png.latex?%7Bf%7D_V:%5Ctext%7Bsupp%7D%5C,%20%5Ctext%7Bpa%7D(V;%5Cmathcal%7BG%7D)%5Ctimes%20%5Ctext%7Bsupp%7D%5C,%20U_V%5Crightarrow%5Ctext%7Bsupp%7D%5C,%20V"> allows us to generate fake data from seeds (noises and exogenous variables) in a controlled environment, along with all necessary counterfactual variables.</p>
<p>Generated substantive variables are:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?W%5Cin%5Cmathbb%7BR%7D"> = confounder</li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Cin%5C%7B0,1%5C%7D"> = binary treatment</li>
<li><img src="https://latex.codecogs.com/png.latex?Y%5Cin%5Cmathbb%7BR%7D"> = outcome</li>
<li><img src="https://latex.codecogs.com/png.latex?M,Z%5Cin%5Cmathbb%7BR%7D"> = mediators of the effect of treatment on the outcome</li>
</ul>
<p>Counterfactual variables are:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?M%5EA,Z%5EA"> = value of mediators <img src="https://latex.codecogs.com/png.latex?M,Z"> <em>had the individual taken treatment</em> <img src="https://latex.codecogs.com/png.latex?A"></li>
<li><img src="https://latex.codecogs.com/png.latex?Y%5E%7BA%7D"> = value of the outcome <em>had the individual taken treatment</em> <img src="https://latex.codecogs.com/png.latex?A"></li>
<li><img src="https://latex.codecogs.com/png.latex?ITE"> = <img src="https://latex.codecogs.com/png.latex?Y%5E%7B1%7D-Y%5E%7B0%7D"> = individual treatment effect</li>
</ul>
<p>We employ the following nonlinear specifications for the causal mechanisms: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AW%20&amp;=%20U_W%20%5Cquad%20&amp;%20U_W%5Csim%20N(0,1)%5C%5C%0AA%20&amp;=%20%5Cmathbb%7BI%7D%5B0.9W%20-0.09%5C,%5Ctext%7Bsign%7D(W)%5C,W%5E2%20+%20U_A%20%3E%200%5D,%5Cquad%20&amp;%20U_A%5Csim%20N(0,1)%5C%5C%0AM%20&amp;=%20-0.50%20+%20A%20+%20U_M,%5Cquad%20&amp;%20U_M%5Csim%20N(0,1)%5C%5C%0AZ%20&amp;=%20%200.12%5C,%5B4.2%20+%200.25%5C,(2A-1)%20+%200.30M%20+%200.05%5C,(2A-1)%5C,%20M%20+%20U_Z%5D%5E2,%5Cquad%20&amp;%20U_Z%5Csim%20N(0,1)%5C%5C%0AY%20&amp;=%20%201.80W+%200.20W%5E3%20+%200.75%5C,(2A-1)%20+%200.50%5C,(2A-1)%5C,%20W%20%20%20&amp;%20%5C%5C%0A&amp;%5Cqquad%20+%202.00M%20+%200.50%5C,(2A-1)%5C,%20M%20+%200.80%5C,(2A-1)%5C,%20Z+%20U_Y,%5Cquad%20&amp;%20U_Y%5Csim%20N(0,11)%5C%5C%0A%5Cend%7Baligned%7D%0A"></p>
<section id="missingness-mechanism" class="level3">
<h3 class="anchored" data-anchor-id="missingness-mechanism">Missingness mechanism</h3>
<p>We run the analysis under three different scenarios for the missingness mechanism of the outcome, the final one with two scenarios of misspecification on <img src="https://latex.codecogs.com/png.latex?Q_1"> and <img src="https://latex.codecogs.com/png.latex?(Q_2,R_3)">. Such <img src="https://latex.codecogs.com/png.latex?R">-mechanisms share a simple logit specification on the mediators <img src="https://latex.codecogs.com/png.latex?M,Z">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%20=%20%5Cmathbb%7BI%7D%5B%5Ctheta%20+%200.29%20M%20+%200.54%20Z%20%20+%20U_R%20%3E%200%5D,%5Cquad%20U_R%5Csim%20N(0,1)%0A"></p>
<p>Different configurations of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> generate missingness mechanisms of different strength.</p>
<ul>
<li><strong>Case 1: severe selection</strong>: by setting <img src="https://latex.codecogs.com/png.latex?%5Ctheta=-1.20">, we obtain around 50% of missing cases</li>
<li><strong>Case 2: medium selection</strong>: by setting <img src="https://latex.codecogs.com/png.latex?%5Ctheta=-0.35">, we obtain around 25% of missing cases</li>
<li><strong>Case 3: low selection</strong>: by setting <img src="https://latex.codecogs.com/png.latex?%5Ctheta=0.40">, we obtain around 10% of missing cases</li>
</ul>
</section>
</section>
<section id="generating-the-data" class="level2">
<h2 class="anchored" data-anchor-id="generating-the-data">Generating the data</h2>
<p>Packages and auxiliary functions required:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load packages --------------------------------------------------------------</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Processes dataframes</span></span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Processes dataframes</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(kableExtra)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Styles tables</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(speedglm)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs fast fitting for GLM</span></span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(nnls)         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs non-negative least squares</span></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Rsolnp)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Augmented Lagrange optimizer</span></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sl3)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs super-learning</span></span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tmle3)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs TMLE</span></span>
<span id="cb2-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tmle3mediate) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs TMLE for mediation analysis</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plots</span></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pracma)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs dot product</span></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(estimatr)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs robust standard errors</span></span></code></pre></div>
</details>
</div>
<p>A dataset (<code>full.data</code>) of <img src="https://latex.codecogs.com/png.latex?N=10%5C,000"> samples was generated:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanisms ------------------------------------------------------------</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanism for treatment assignment</span></span>
<span id="cb3-4">coef.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.09</span>)</span>
<span id="cb3-5">fun.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(w, u){</span>
<span id="cb3-6">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, w, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sign</span>(w)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-7">  lo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(coef.A, dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u</span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(lo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb3-9">}</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanism for mediator 1</span></span>
<span id="cb3-12">coef.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>)</span>
<span id="cb3-13">fun.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(a, u){</span>
<span id="cb3-14">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, a))</span>
<span id="cb3-15">  li <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(coef.M, dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u</span>
<span id="cb3-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(li)</span>
<span id="cb3-17">}</span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanism for mediator 2</span></span>
<span id="cb3-20">coef.Z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.30</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb3-21">fun.Z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(a, m, u){</span>
<span id="cb3-22">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>, m, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>m))</span>
<span id="cb3-23">  li <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(coef.Z, dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(li)</span>
<span id="cb3-25">}</span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanism for outcome</span></span>
<span id="cb3-28">coef.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.80</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.80</span>)</span>
<span id="cb3-29">fun.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(w, a, m, z, u){</span>
<span id="cb3-30">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, w, w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w, m, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>m, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>z))</span>
<span id="cb3-31">  li <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(coef.Y, dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u</span>
<span id="cb3-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(li)</span>
<span id="cb3-33">}</span>
<span id="cb3-34"></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal mechanism for missingness mechanisms. R</span></span>
<span id="cb3-36">coef.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.29</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.54</span>) </span>
<span id="cb3-37">fun.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m, z, u){</span>
<span id="cb3-38">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(m, z))</span>
<span id="cb3-39">  lo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> r.bias <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dot</span>(coef.R, dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u</span>
<span id="cb3-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(lo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb3-41">}</span>
<span id="cb3-42"></span>
<span id="cb3-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the data ------------------------------------------------------------</span></span>
<span id="cb3-44"></span>
<span id="cb3-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb3-46">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e4</span></span>
<span id="cb3-47"></span>
<span id="cb3-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Seed </span></span>
<span id="cb3-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span>)</span>
<span id="cb3-50"></span>
<span id="cb3-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate exogenous variables: independent confounders and noises, </span></span>
<span id="cb3-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plus fixed treatment assignments A.1 and A.0</span></span>
<span id="cb3-53">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.A =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-54">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.M =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-55">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.Z =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-56">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.Y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>),</span>
<span id="cb3-57">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.R1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-58">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.R2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-59">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noise.R3 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-60">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb3-61">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A.1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A.0 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-62"></span>
<span id="cb3-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate observations</span></span>
<span id="cb3-64">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.A, W, noise.A)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-65">  .[, M<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.M, A, noise.M)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-66">  .[, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.M, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, noise.M)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-67">  .[, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.M, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, noise.M)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-68">  .[, Z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Z, A, M, noise.Z)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-69">  .[, Z<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Z, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, noise.Z)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-70">  .[, Z<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Z, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, noise.Z)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-71">  .[, Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Y, W, A, M, Z, noise.Y)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-72">  .[, Y<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Y, W, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, Z<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, noise.Y)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-73">  .[, Y<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.Y, W, A<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, M<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, Z<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>, noise.Y)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-74">  .[, ITE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>Y<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Y<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] </span>
<span id="cb3-75"></span>
<span id="cb3-76"></span>
<span id="cb3-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate missingness indicator, case 1: R1</span></span>
<span id="cb3-78">r.bias <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.20</span></span>
<span id="cb3-79">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.R, M, Z, noise.R1)]</span>
<span id="cb3-80"></span>
<span id="cb3-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate missingness indicator, case 2: R2</span></span>
<span id="cb3-82">r.bias <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span></span>
<span id="cb3-83">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.R, M, Z, noise.R2)]</span>
<span id="cb3-84"></span>
<span id="cb3-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate missingness indicator, case 2: R3 y R4</span></span>
<span id="cb3-86">r.bias <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.40</span></span>
<span id="cb3-87">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapply</span>(fun.R, M, Z, noise.R3)]</span>
<span id="cb3-88"></span>
<span id="cb3-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A glimpse of the data</span></span>
<span id="cb3-90">full.data[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table 1: A glimpse at the generated data"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table 1: A glimpse at the generated data</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">W</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">A.1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">A.0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">A</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">M</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">M.1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">M.0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Z</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Z.1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Z.0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y.1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y.0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ITE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">R1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">R2</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">R3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.6598987</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.1125637</td>
<td style="text-align: right;">-1.1125637</td>
<td style="text-align: right;">-2.1125637</td>
<td style="text-align: right;">2.862417</td>
<td style="text-align: right;">2.862417</td>
<td style="text-align: right;">2.1626663</td>
<td style="text-align: right;">-9.889348</td>
<td style="text-align: right;">-9.889348</td>
<td style="text-align: right;">-16.45675</td>
<td style="text-align: right;">6.567402</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.2561566</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.0083732</td>
<td style="text-align: right;">1.0083732</td>
<td style="text-align: right;">0.0083732</td>
<td style="text-align: right;">1.112559</td>
<td style="text-align: right;">1.112559</td>
<td style="text-align: right;">0.5776615</td>
<td style="text-align: right;">19.453696</td>
<td style="text-align: right;">19.453696</td>
<td style="text-align: right;">14.34930</td>
<td style="text-align: right;">5.104393</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.3617037</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.2945485</td>
<td style="text-align: right;">-0.2945485</td>
<td style="text-align: right;">-1.2945485</td>
<td style="text-align: right;">5.422882</td>
<td style="text-align: right;">5.422882</td>
<td style="text-align: right;">4.3226736</td>
<td style="text-align: right;">22.147969</td>
<td style="text-align: right;">22.147969</td>
<td style="text-align: right;">12.00778</td>
<td style="text-align: right;">10.140192</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.4995301</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2.3817717</td>
<td style="text-align: right;">2.3817717</td>
<td style="text-align: right;">1.3817717</td>
<td style="text-align: right;">3.136195</td>
<td style="text-align: right;">3.136195</td>
<td style="text-align: right;">2.0409439</td>
<td style="text-align: right;">23.088961</td>
<td style="text-align: right;">23.088961</td>
<td style="text-align: right;">14.06501</td>
<td style="text-align: right;">9.023953</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-1.5825305</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-1.1021504</td>
<td style="text-align: right;">-0.1021504</td>
<td style="text-align: right;">-1.1021504</td>
<td style="text-align: right;">1.300471</td>
<td style="text-align: right;">1.950634</td>
<td style="text-align: right;">1.3004709</td>
<td style="text-align: right;">21.726949</td>
<td style="text-align: right;">25.643152</td>
<td style="text-align: right;">21.72695</td>
<td style="text-align: right;">3.916203</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.7978039</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.0289140</td>
<td style="text-align: right;">-0.0289140</td>
<td style="text-align: right;">-1.0289140</td>
<td style="text-align: right;">2.196055</td>
<td style="text-align: right;">2.196055</td>
<td style="text-align: right;">1.4959814</td>
<td style="text-align: right;">-6.400891</td>
<td style="text-align: right;">-6.400891</td>
<td style="text-align: right;">-11.52780</td>
<td style="text-align: right;">5.126911</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="estimators-to-compare" class="level2">
<h2 class="anchored" data-anchor-id="estimators-to-compare">Estimators to compare</h2>
<table class="table">
<caption>Table 1: estimators to be compared in simulations</caption>
<colgroup>
<col style="width: 25%">
<col style="width: 35%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>Estimator</th>
<th>Method</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Oracle PATE sample-based</td>
<td>Average of ITE in the whole sample</td>
<td>Impossible to compute, we do not observe both counterfactuals nor missing outcome</td>
</tr>
<tr class="even">
<td>Oracle SATE sample-based</td>
<td>Average of ITE in the selected sample</td>
<td>Impossible to compute, we do not observe both counterfactuals</td>
</tr>
<tr class="odd">
<td>Student’s t-test</td>
<td>Mean difference of observed outcomes treated vs control</td>
<td>It suffers from confounding and selection biases</td>
</tr>
<tr class="even">
<td>TML CCA</td>
<td>TMLE using only selected units: <img src="https://latex.codecogs.com/png.latex?R_Y=1"></td>
<td>It is not consistent in our DAG</td>
</tr>
<tr class="odd">
<td>TML pre-processing</td>
<td>TMLE using pre-processing tool for missing data in <code>tmle</code> package</td>
<td>It is not based on graphical criteria</td>
</tr>
<tr class="even">
<td>TML pre-exposure</td>
<td>TMLE adjusting only for pre-exposure <img src="https://latex.codecogs.com/png.latex?W"></td>
<td>It is not consistent in our DAG</td>
</tr>
<tr class="odd">
<td>Doubly-inverse weighted</td>
<td>Outcome difference weighted by propensity score and selection prob.</td>
<td>It is consistent in our DAG if models are correctly specified</td>
</tr>
<tr class="even">
<td><span style="color:blue;">Nested regressions</span></td>
<td><span style="color:blue;">Paper proposal 1</span></td>
<td><span style="color:blue;">It is consistent in our DAG if models are correctly specified</span></td>
</tr>
<tr class="odd">
<td><span style="color:blue;">TML 2-steps</span></td>
<td><span style="color:blue;">Paper proposal 2</span></td>
<td><span style="color:blue;">It is consistent in our DAG with multiple robusness conditions for models</span></td>
</tr>
</tbody>
</table>
</section>
<section id="super-learning-procedure" class="level2">
<h2 class="anchored" data-anchor-id="super-learning-procedure">Super-learning procedure</h2>
<p>Some estimators are produced under a super-learning scheme. They are based on weighted stacks of a library of base estimators: i) <em>saple mean</em>, ii) <em>generalized linear model</em> (GLM), and iii) <em>spline regression model</em> (<code>earth</code> package).</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning algorithms employed to learn treatment/outcome mechanisms -----------</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean model</span></span>
<span id="cb4-4">lrnr_me <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_mean) </span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GLM</span></span>
<span id="cb4-6">lrnr_lm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_glm_fast)</span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Spline regression</span></span>
<span id="cb4-8">lrnr_sp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_earth)  </span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Meta-learners: to stack together predictions from the learners ---------------</span></span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine continuous predictions with non-negative least squares</span></span>
<span id="cb4-13">meta_C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_nnls)   </span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine binary predictions with logit likelihood (augmented Lagrange optimizer)</span></span>
<span id="cb4-16">meta_B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_solnp,                     </span>
<span id="cb4-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_function =</span> loss_loglik_binomial,              </span>
<span id="cb4-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_function =</span> metalearner_logistic_binomial)   </span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners: learners + meta-learners together ----------------------------</span></span>
<span id="cb4-21"></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Continuous super-learning</span></span>
<span id="cb4-23">super_C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(lrnr_me, lrnr_lm, lrnr_sp), </span>
<span id="cb4-24">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metalearner =</span> meta_C)</span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Binary super-learning</span></span>
<span id="cb4-26">super_B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(lrnr_me, lrnr_lm, lrnr_sp), </span>
<span id="cb4-27">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metalearner =</span> meta_B)</span>
<span id="cb4-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners put together</span></span>
<span id="cb4-29">super_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> super_B,</span>
<span id="cb4-30">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> super_C)              </span></code></pre></div>
</details>
</div>
</section>
<section id="case-1-severe-missingnessselection" class="level2">
<h2 class="anchored" data-anchor-id="case-1-severe-missingnessselection">Case 1: severe missingness/selection</h2>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator A: Oracle PATE -----------------------------------------------------</span></span>
<span id="cb5-3"></span>
<span id="cb5-4">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ITE)</span>
<span id="cb5-5">pate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-6">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-7">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator B: Oracle SATE -----------------------------------------------------</span></span>
<span id="cb5-11"></span>
<span id="cb5-12">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ITE])</span>
<span id="cb5-13">sate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-14">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-15">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb5-16"></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 1: Unadjusted t-test -----------------------------------------------</span></span>
<span id="cb5-19"></span>
<span id="cb5-20">unadj.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb5-21"></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-23">unadj.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-24">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-25">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb5-26"></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 2: TMLE with only pre-treatment variables --------------------------</span></span>
<span id="cb5-29"></span>
<span id="cb5-30">tmle.pret <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb5-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb5-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb5-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,],                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb5-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb5-35"></span>
<span id="cb5-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-37">tmle.ptest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb5-38">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb5-39">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb5-40"></span>
<span id="cb5-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 3: TMLE with pre-processing tool for missingness -------------------</span></span>
<span id="cb5-43"></span>
<span id="cb5-44">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb5-45">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y)</span>
<span id="cb5-46"></span>
<span id="cb5-47">processed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">process_missing</span>(temp.dt[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>)],                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data</span></span>
<span id="cb5-48">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confounders</span></span>
<span id="cb5-49">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exposure</span></span>
<span id="cb5-50">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outcome</span></span>
<span id="cb5-51">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">complete_nodes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>),</span>
<span id="cb5-52">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">impute_nodes =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb5-53">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_p_missing =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)  </span>
<span id="cb5-54"></span>
<span id="cb5-55">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb5-56">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb5-57">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta_Y'</span>),</span>
<span id="cb5-58">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb5-59">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> processed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data,                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb5-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb5-61"></span>
<span id="cb5-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-63">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb5-64">               tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb5-65">               tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb5-66"></span>
<span id="cb5-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 4: Doubly-inverse weighted estimator -------------------------------</span></span>
<span id="cb5-69"></span>
<span id="cb5-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for treatment assignment</span></span>
<span id="cb5-71">train.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-72">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>)</span>
<span id="cb5-73"></span>
<span id="cb5-74">A_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb5-75">A_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb5-76"></span>
<span id="cb5-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb5-78">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-79">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-80"></span>
<span id="cb5-81">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb5-82">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb5-83"></span>
<span id="cb5-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LM with doubly inverse weights</span></span>
<span id="cb5-85">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, DIW <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))]</span>
<span id="cb5-86"></span>
<span id="cb5-87">diw.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> DIW)</span>
<span id="cb5-88"></span>
<span id="cb5-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-90">diw.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-91">            diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-92">            diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb5-93"></span>
<span id="cb5-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 5: Nested regressions, T-learner -----------------------------------</span></span>
<span id="cb5-96"></span>
<span id="cb5-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb5-98">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-99">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-100"></span>
<span id="cb5-101">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb5-102"></span>
<span id="cb5-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb5-104">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-105">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-106"></span>
<span id="cb5-107">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-108"></span>
<span id="cb5-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1 </span></span>
<span id="cb5-110">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-111">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-112"></span>
<span id="cb5-113">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-114"></span>
<span id="cb5-115">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-116">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-117"></span>
<span id="cb5-118">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-119"></span>
<span id="cb5-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb5-121">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-122">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-123"></span>
<span id="cb5-124">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb5-125"></span>
<span id="cb5-126">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-127">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-128"></span>
<span id="cb5-129">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb5-130"></span>
<span id="cb5-131"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predicted difference Q2.1 - Q2.0</span></span>
<span id="cb5-132"></span>
<span id="cb5-133">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span></span>
<span id="cb5-134"></span>
<span id="cb5-135"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bootstrap procedure to compute the standard deviation</span></span>
<span id="cb5-136"></span>
<span id="cb5-137">bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb5-138"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>){</span>
<span id="cb5-139">  </span>
<span id="cb5-140">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boostraped data</span></span>
<span id="cb5-141">  ind <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N,N,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb5-142">  bs.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[ind,])</span>
<span id="cb5-143">  </span>
<span id="cb5-144">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb5-145">  train.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-146">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-147">  </span>
<span id="cb5-148">  bs.Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q1)</span>
<span id="cb5-149">  </span>
<span id="cb5-150">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb5-151">  pred.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-152">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-153">  </span>
<span id="cb5-154">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q1)</span>
<span id="cb5-155">  </span>
<span id="cb5-156">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1.</span></span>
<span id="cb5-157">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-158">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-159">  </span>
<span id="cb5-160">  bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-161">  </span>
<span id="cb5-162">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-163">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-164">  </span>
<span id="cb5-165">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-166">  </span>
<span id="cb5-167">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb5-168">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-169">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-170">  </span>
<span id="cb5-171">  bsQ2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb5-172">  </span>
<span id="cb5-173">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-174">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-175">  </span>
<span id="cb5-176">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb5-177">  </span>
<span id="cb5-178">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add predicted difference Q2.1 - Q2.0 to boostrap vessel</span></span>
<span id="cb5-179">  bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bsamples, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>))</span>
<span id="cb5-180">}</span>
<span id="cb5-181"></span>
<span id="cb5-182"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-183">nesreg.T <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb5-184">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb5-185">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta))</span>
<span id="cb5-186"></span>
<span id="cb5-187"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-188"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 6: 2-step TMLE  ----------------------------------------------------</span></span>
<span id="cb5-189"></span>
<span id="cb5-190"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 1 ------------------</span></span>
<span id="cb5-191"></span>
<span id="cb5-192"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb5-193">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb5-194"></span>
<span id="cb5-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb5-196">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb5-197"></span>
<span id="cb5-198"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb5-199">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb5-200"></span>
<span id="cb5-201"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb5-202">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-203">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-204">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-205">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-206"></span>
<span id="cb5-207">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb5-208">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb5-209">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb5-210"></span>
<span id="cb5-211"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb5-212">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-213">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-214">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb5-215">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-216"></span>
<span id="cb5-217">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb5-218">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb5-219">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb5-220"></span>
<span id="cb5-221"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.1 from up.Q1.1, using A=1 cases</span></span>
<span id="cb5-222">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb5-223"></span>
<span id="cb5-224">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-225">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-226"></span>
<span id="cb5-227">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb5-228"></span>
<span id="cb5-229">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-230">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-231"></span>
<span id="cb5-232">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb5-233"></span>
<span id="cb5-234"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.0 from up.Q1.0, using A=0 cases</span></span>
<span id="cb5-235">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb5-236"></span>
<span id="cb5-237">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-238">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-239"></span>
<span id="cb5-240">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb5-241"></span>
<span id="cb5-242">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-243">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-244"></span>
<span id="cb5-245">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb5-246"></span>
<span id="cb5-247"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 2 ------------------</span></span>
<span id="cb5-248"></span>
<span id="cb5-249"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed values for up.Q1 and Q2</span></span>
<span id="cb5-250"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb5-251">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-252">  .[, Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-253">  .[, clever.H2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> ((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb5-254"></span>
<span id="cb5-255"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb5-256">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data)</span>
<span id="cb5-257"></span>
<span id="cb5-258"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.1</span></span>
<span id="cb5-259">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb5-260">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb5-261">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre))</span>
<span id="cb5-262"></span>
<span id="cb5-263"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.0</span></span>
<span id="cb5-264">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb5-265">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb5-266">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre)))</span>
<span id="cb5-267"></span>
<span id="cb5-268"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q2.1 - Q2.0</span></span>
<span id="cb5-269"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q2</span></span>
<span id="cb5-270"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb5-271">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-272">  .[, up.Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-273">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R1]</span>
<span id="cb5-274"></span>
<span id="cb5-275"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb5-276">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb5-277"></span>
<span id="cb5-278"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-279">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb5-280">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb5-281">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2))</span>
<span id="cb5-282"></span>
<span id="cb5-283"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-284"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 7: pre-exp TMLE  ---------------------------------------------------</span></span>
<span id="cb5-285"></span>
<span id="cb5-286"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update R-predictions</span></span>
<span id="cb5-287"></span>
<span id="cb5-288"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb5-289">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-290">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb5-291"></span>
<span id="cb5-292">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb5-293">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb5-294"></span>
<span id="cb5-295"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-predictions</span></span>
<span id="cb5-296"></span>
<span id="cb5-297"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb5-298">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-299">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb5-300"></span>
<span id="cb5-301">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb5-302"></span>
<span id="cb5-303"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb5-304">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-305">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb5-306"></span>
<span id="cb5-307">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-308"></span>
<span id="cb5-309"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb5-310">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb5-311"></span>
<span id="cb5-312"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb5-313">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb5-314"></span>
<span id="cb5-315"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb5-316">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb5-317"></span>
<span id="cb5-318"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb5-319">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-320">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-321">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb5-322">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-323"></span>
<span id="cb5-324">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb5-325">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb5-326">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb5-327"></span>
<span id="cb5-328"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb5-329">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-330">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb5-331">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb5-332">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb5-333"></span>
<span id="cb5-334">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb5-335">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb5-336">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb5-337"></span>
<span id="cb5-338"></span>
<span id="cb5-339"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q1.1 - Q1.0</span></span>
<span id="cb5-340"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q1</span></span>
<span id="cb5-341"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb5-342">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-343">  .[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-344">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R1]</span>
<span id="cb5-345"></span>
<span id="cb5-346"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb5-347">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb5-348"></span>
<span id="cb5-349"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb5-350">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb5-351">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb5-352">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1))</span>
<span id="cb5-353"></span>
<span id="cb5-354"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb5-355"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualization of results -----------------------------------------------------</span></span>
<span id="cb5-356"></span>
<span id="cb5-357"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PUT ALL TOGETHER</span></span>
<span id="cb5-358">estimators <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(pate,sate,unadj.est,tmle.ptest,tmle.proc,</span>
<span id="cb5-359">                              tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step,diw.est,nesreg.T,tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step))</span>
<span id="cb5-360"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(estimators) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'point.est'</span>)</span>
<span id="cb5-361">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle PATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle SATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Student's t-test"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML CCA'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreProc'</span>,</span>
<span id="cb5-362">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreExp'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DIW'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Nested Reg'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML 2-Step'</span>)</span>
<span id="cb5-363"></span>
<span id="cb5-364">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type))</span>
<span id="cb5-365"></span>
<span id="cb5-366"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate and CI plot </span></span>
<span id="cb5-367"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(estimators, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>point.est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-368">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-369">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span>lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span>upper, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type),</span>
<span id="cb5-370">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-371">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimator'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-372">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_linedraw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> pate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="case-2-moderate-missingnessselection" class="level2">
<h2 class="anchored" data-anchor-id="case-2-moderate-missingnessselection">Case 2: moderate missingness/selection</h2>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator A: Oracle PATE -----------------------------------------------------</span></span>
<span id="cb6-3"></span>
<span id="cb6-4">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ITE)</span>
<span id="cb6-5">pate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb6-6">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-7">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator B: Oracle SATE -----------------------------------------------------</span></span>
<span id="cb6-11"></span>
<span id="cb6-12">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ITE])</span>
<span id="cb6-13">sate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb6-14">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-15">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 1: Unadjusted t-test -----------------------------------------------</span></span>
<span id="cb6-19"></span>
<span id="cb6-20">unadj.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb6-21"></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-23">unadj.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-24">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-25">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb6-26"></span>
<span id="cb6-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 2: TMLE with only pre-treatment variables --------------------------</span></span>
<span id="cb6-29"></span>
<span id="cb6-30">tmle.pret <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb6-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb6-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb6-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,],                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb6-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb6-35"></span>
<span id="cb6-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-37">tmle.ptest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb6-38">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb6-39">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb6-40"></span>
<span id="cb6-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 3: TMLE with pre-processing tool for missingness -------------------</span></span>
<span id="cb6-43"></span>
<span id="cb6-44">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb6-45">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y)</span>
<span id="cb6-46"></span>
<span id="cb6-47">processed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">process_missing</span>(temp.dt[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>)],                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data</span></span>
<span id="cb6-48">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confounders</span></span>
<span id="cb6-49">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exposure</span></span>
<span id="cb6-50">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outcome</span></span>
<span id="cb6-51">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">complete_nodes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>),</span>
<span id="cb6-52">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">impute_nodes =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb6-53">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_p_missing =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)  </span>
<span id="cb6-54"></span>
<span id="cb6-55">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb6-56">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb6-57">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta_Y'</span>),</span>
<span id="cb6-58">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb6-59">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> processed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data,                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb6-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb6-61"></span>
<span id="cb6-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-63">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb6-64">              tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb6-65">              tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb6-66"></span>
<span id="cb6-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 4: Doubly-inverse weighted estimator -------------------------------</span></span>
<span id="cb6-69"></span>
<span id="cb6-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for treatment assignment</span></span>
<span id="cb6-71">train.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-72">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>)</span>
<span id="cb6-73"></span>
<span id="cb6-74">A_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb6-75">A_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb6-76"></span>
<span id="cb6-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb6-78">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-79">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R2'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-80"></span>
<span id="cb6-81">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb6-82">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb6-83"></span>
<span id="cb6-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LM with doubly inverse weights</span></span>
<span id="cb6-85">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, DIW <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))]</span>
<span id="cb6-86"></span>
<span id="cb6-87">diw.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> DIW)</span>
<span id="cb6-88"></span>
<span id="cb6-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-90">diw.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-91">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb6-92">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb6-93"></span>
<span id="cb6-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 5: Nested regressions, T-learner -----------------------------------</span></span>
<span id="cb6-96"></span>
<span id="cb6-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb6-98">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-99">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-100"></span>
<span id="cb6-101">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb6-102"></span>
<span id="cb6-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb6-104">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-105">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-106"></span>
<span id="cb6-107">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-108"></span>
<span id="cb6-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1 </span></span>
<span id="cb6-110">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-111">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-112"></span>
<span id="cb6-113">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb6-114"></span>
<span id="cb6-115">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-116">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-117"></span>
<span id="cb6-118">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb6-119"></span>
<span id="cb6-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb6-121">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-122">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-123"></span>
<span id="cb6-124">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb6-125"></span>
<span id="cb6-126">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-127">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-128"></span>
<span id="cb6-129">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb6-130"></span>
<span id="cb6-131"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predicted difference Q2.1 - Q2.0</span></span>
<span id="cb6-132"></span>
<span id="cb6-133">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span></span>
<span id="cb6-134"></span>
<span id="cb6-135"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bootstrap procedure to compute the standard deviation</span></span>
<span id="cb6-136"></span>
<span id="cb6-137">bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb6-138"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>){</span>
<span id="cb6-139">  </span>
<span id="cb6-140">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boostraped data</span></span>
<span id="cb6-141">  ind <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N,N,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb6-142">  bs.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[ind,])</span>
<span id="cb6-143">  </span>
<span id="cb6-144">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb6-145">  train.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-146">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-147">  </span>
<span id="cb6-148">  bs.Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q1)</span>
<span id="cb6-149">  </span>
<span id="cb6-150">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb6-151">  pred.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-152">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-153">  </span>
<span id="cb6-154">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q1)</span>
<span id="cb6-155">  </span>
<span id="cb6-156">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1.</span></span>
<span id="cb6-157">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-158">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-159">  </span>
<span id="cb6-160">  bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb6-161">  </span>
<span id="cb6-162">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-163">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-164">  </span>
<span id="cb6-165">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb6-166">  </span>
<span id="cb6-167">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb6-168">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-169">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-170">  </span>
<span id="cb6-171">  bsQ2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb6-172">  </span>
<span id="cb6-173">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-174">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-175">  </span>
<span id="cb6-176">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb6-177">  </span>
<span id="cb6-178">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add predicted difference Q2.1 - Q2.0 to boostrap vessel</span></span>
<span id="cb6-179">  bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bsamples, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>))</span>
<span id="cb6-180">}</span>
<span id="cb6-181"></span>
<span id="cb6-182"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-183">nesreg.T <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb6-184">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb6-185">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta))</span>
<span id="cb6-186"></span>
<span id="cb6-187"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-188"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 6: 2-step TMLE  ----------------------------------------------------</span></span>
<span id="cb6-189"></span>
<span id="cb6-190"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 1 ------------------</span></span>
<span id="cb6-191"></span>
<span id="cb6-192"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb6-193">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb6-194"></span>
<span id="cb6-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb6-196">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb6-197"></span>
<span id="cb6-198"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb6-199">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb6-200"></span>
<span id="cb6-201"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb6-202">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-203">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-204">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-205">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-206"></span>
<span id="cb6-207">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb6-208">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb6-209">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb6-210"></span>
<span id="cb6-211"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb6-212">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-213">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-214">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb6-215">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-216"></span>
<span id="cb6-217">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb6-218">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb6-219">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb6-220"></span>
<span id="cb6-221"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.1 from up.Q1.1, using A=1 cases</span></span>
<span id="cb6-222">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb6-223"></span>
<span id="cb6-224">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-225">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-226"></span>
<span id="cb6-227">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb6-228"></span>
<span id="cb6-229">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-230">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-231"></span>
<span id="cb6-232">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb6-233"></span>
<span id="cb6-234"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.0 from up.Q1.0, using A=0 cases</span></span>
<span id="cb6-235">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb6-236"></span>
<span id="cb6-237">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-238">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-239"></span>
<span id="cb6-240">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb6-241"></span>
<span id="cb6-242">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-243">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-244"></span>
<span id="cb6-245">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb6-246"></span>
<span id="cb6-247"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 2 ------------------</span></span>
<span id="cb6-248"></span>
<span id="cb6-249"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed values for up.Q1 and Q2</span></span>
<span id="cb6-250"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb6-251">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-252">  .[, Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-253">  .[, clever.H2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> ((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb6-254"></span>
<span id="cb6-255"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb6-256">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data)</span>
<span id="cb6-257"></span>
<span id="cb6-258"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.1</span></span>
<span id="cb6-259">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb6-260">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb6-261">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre))</span>
<span id="cb6-262"></span>
<span id="cb6-263"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.0</span></span>
<span id="cb6-264">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb6-265">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb6-266">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre)))</span>
<span id="cb6-267"></span>
<span id="cb6-268"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q2.1 - Q2.0</span></span>
<span id="cb6-269"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q2</span></span>
<span id="cb6-270"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb6-271">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-272">  .[, up.Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-273">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R2]</span>
<span id="cb6-274"></span>
<span id="cb6-275"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb6-276">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb6-277"></span>
<span id="cb6-278"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-279">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb6-280">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb6-281">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2))</span>
<span id="cb6-282"></span>
<span id="cb6-283"></span>
<span id="cb6-284"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-285"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 7: pre-exp TMLE  ---------------------------------------------------</span></span>
<span id="cb6-286"></span>
<span id="cb6-287"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update R-predictions</span></span>
<span id="cb6-288"></span>
<span id="cb6-289"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb6-290">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-291">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R2'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb6-292"></span>
<span id="cb6-293">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb6-294">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb6-295"></span>
<span id="cb6-296"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-predictions</span></span>
<span id="cb6-297"></span>
<span id="cb6-298"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb6-299">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-300">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb6-301"></span>
<span id="cb6-302">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb6-303"></span>
<span id="cb6-304"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb6-305">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-306">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb6-307"></span>
<span id="cb6-308">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-309"></span>
<span id="cb6-310"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb6-311">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb6-312"></span>
<span id="cb6-313"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb6-314">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb6-315"></span>
<span id="cb6-316"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb6-317">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb6-318"></span>
<span id="cb6-319"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb6-320">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-321">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-322">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb6-323">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-324"></span>
<span id="cb6-325">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb6-326">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb6-327">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb6-328"></span>
<span id="cb6-329"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb6-330">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-331">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb6-332">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb6-333">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb6-334"></span>
<span id="cb6-335">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb6-336">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb6-337">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb6-338"></span>
<span id="cb6-339"></span>
<span id="cb6-340"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q1.1 - Q1.0</span></span>
<span id="cb6-341"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q1</span></span>
<span id="cb6-342"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb6-343">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-344">  .[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-345">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R2]</span>
<span id="cb6-346"></span>
<span id="cb6-347"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb6-348">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb6-349"></span>
<span id="cb6-350"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb6-351">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb6-352">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb6-353">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1))</span>
<span id="cb6-354"></span>
<span id="cb6-355"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb6-356"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualization of results -----------------------------------------------------</span></span>
<span id="cb6-357"></span>
<span id="cb6-358"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PUT ALL TOGETHER</span></span>
<span id="cb6-359">estimators <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(pate,sate,unadj.est,tmle.ptest,tmle.proc,</span>
<span id="cb6-360">                              tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step,diw.est,nesreg.T,tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step))</span>
<span id="cb6-361"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(estimators) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'point.est'</span>)</span>
<span id="cb6-362">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle PATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle SATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Student's t-test"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML CCA'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreProc'</span>,</span>
<span id="cb6-363">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreExp'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DIW'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Nested Reg'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML 2-Step'</span>)</span>
<span id="cb6-364"></span>
<span id="cb6-365">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type))</span>
<span id="cb6-366"></span>
<span id="cb6-367"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate and CI plot</span></span>
<span id="cb6-368"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(estimators, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>point.est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-369">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-370">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span>lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span>upper, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type),</span>
<span id="cb6-371">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-372">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimator'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-373">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_linedraw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> pate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="case-3a-low-missingnessselection-with-misspecification-of-q_1" class="level2">
<h2 class="anchored" data-anchor-id="case-3a-low-missingnessselection-with-misspecification-of-q_1">Case 3A: low missingness/selection with misspecification of <img src="https://latex.codecogs.com/png.latex?Q_1"></h2>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator A: Oracle PATE -----------------------------------------------------</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ITE)</span>
<span id="cb7-5">pate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb7-6">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-7">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator B: Oracle SATE -----------------------------------------------------</span></span>
<span id="cb7-11"></span>
<span id="cb7-12">oracle.ttest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ITE])</span>
<span id="cb7-13">sate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb7-14">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-15">                oracle.ttest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate))</span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 1: Unadjusted t-test -----------------------------------------------</span></span>
<span id="cb7-19"></span>
<span id="cb7-20">unadj.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-21"></span>
<span id="cb7-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-23">unadj.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-24">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-25">                     unadj.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb7-26"></span>
<span id="cb7-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 2: TMLE with only pre-treatment variables --------------------------</span></span>
<span id="cb7-29"></span>
<span id="cb7-30">tmle.pret <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb7-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb7-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb7-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,],                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb7-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb7-35"></span>
<span id="cb7-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-37">tmle.ptest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb7-38">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb7-39">               tmle.pret<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb7-40"></span>
<span id="cb7-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 3: TMLE with pre-processing tool for missingness -------------------</span></span>
<span id="cb7-43"></span>
<span id="cb7-44">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb7-45">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y)</span>
<span id="cb7-46"></span>
<span id="cb7-47">processed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">process_missing</span>(temp.dt[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>)],                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data</span></span>
<span id="cb7-48">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confounders</span></span>
<span id="cb7-49">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exposure</span></span>
<span id="cb7-50">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outcome</span></span>
<span id="cb7-51">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">complete_nodes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>),</span>
<span id="cb7-52">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">impute_nodes =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb7-53">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_p_missing =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)  </span>
<span id="cb7-54"></span>
<span id="cb7-55">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb7-56">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Targeting the ATE</span></span>
<span id="cb7-57">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delta_Y'</span>),</span>
<span id="cb7-58">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>),            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved                         </span></span>
<span id="cb7-59">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> processed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data,                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data                                  </span></span>
<span id="cb7-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners  </span></span>
<span id="cb7-61"></span>
<span id="cb7-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-63">tmle.proc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lower,</span>
<span id="cb7-64">              tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upper,</span>
<span id="cb7-65">              tmle.proc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmle_est)</span>
<span id="cb7-66"></span>
<span id="cb7-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 4: Doubly-inverse weighted estimator -------------------------------</span></span>
<span id="cb7-69"></span>
<span id="cb7-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for treatment assignment</span></span>
<span id="cb7-71">train.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-72">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>)</span>
<span id="cb7-73"></span>
<span id="cb7-74">A_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb7-75">A_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb7-76"></span>
<span id="cb7-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb7-78">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-79">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R3'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb7-80"></span>
<span id="cb7-81">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-82">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-83"></span>
<span id="cb7-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LM with doubly inverse weights</span></span>
<span id="cb7-85">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, DIW <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))]</span>
<span id="cb7-86"></span>
<span id="cb7-87">diw.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> DIW)</span>
<span id="cb7-88"></span>
<span id="cb7-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-90">diw.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-91">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb7-92">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb7-93"></span>
<span id="cb7-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 5: Nested regressions, T-learner -----------------------------------</span></span>
<span id="cb7-96"></span>
<span id="cb7-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1: MISSPECIFIED</span></span>
<span id="cb7-98">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>M<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(Z)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-99"></span>
<span id="cb7-100">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> full.data)</span>
<span id="cb7-101"></span>
<span id="cb7-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1 </span></span>
<span id="cb7-103">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-104">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-105"></span>
<span id="cb7-106">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb7-107"></span>
<span id="cb7-108">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-109">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-110"></span>
<span id="cb7-111">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb7-112"></span>
<span id="cb7-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb7-114">train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-115">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-116"></span>
<span id="cb7-117">Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb7-118"></span>
<span id="cb7-119">pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-120">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-121"></span>
<span id="cb7-122">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb7-123"></span>
<span id="cb7-124"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predicted difference Q2.1 - Q2.0</span></span>
<span id="cb7-125"></span>
<span id="cb7-126">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span></span>
<span id="cb7-127"></span>
<span id="cb7-128"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bootstrap procedure to compute the standard deviation</span></span>
<span id="cb7-129"></span>
<span id="cb7-130">bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb7-131"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>){</span>
<span id="cb7-132">  </span>
<span id="cb7-133">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boostraped data</span></span>
<span id="cb7-134">  ind <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N,N,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb7-135">  bs.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[ind,])</span>
<span id="cb7-136">  </span>
<span id="cb7-137">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1: MISSPECIFIED</span></span>
<span id="cb7-138">  train.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>M<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>Z, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-139"></span>
<span id="cb7-140">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.bs.Q1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> bs.data)</span>
<span id="cb7-141">  </span>
<span id="cb7-142">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.1.</span></span>
<span id="cb7-143">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-144">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-145">  </span>
<span id="cb7-146">  bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb7-147">  </span>
<span id="cb7-148">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-149">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-150">  </span>
<span id="cb7-151">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb7-152">  </span>
<span id="cb7-153">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2.0</span></span>
<span id="cb7-154">  train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-155">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-156">  </span>
<span id="cb7-157">  bsQ2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb7-158">  </span>
<span id="cb7-159">  pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-160">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-161">  </span>
<span id="cb7-162">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb7-163">  </span>
<span id="cb7-164">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add predicted difference Q2.1 - Q2.0 to boostrap vessel</span></span>
<span id="cb7-165">  bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bsamples, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>))</span>
<span id="cb7-166">}</span>
<span id="cb7-167"></span>
<span id="cb7-168"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-169">nesreg.T <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb7-170">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb7-171">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta))</span>
<span id="cb7-172"></span>
<span id="cb7-173"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-174"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 6: 2-step TMLE  ----------------------------------------------------</span></span>
<span id="cb7-175"></span>
<span id="cb7-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 1 ------------------</span></span>
<span id="cb7-177"></span>
<span id="cb7-178"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb7-179">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb7-180"></span>
<span id="cb7-181"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb7-182">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-183"></span>
<span id="cb7-184"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb7-185">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb7-186"></span>
<span id="cb7-187"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb7-188">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-189">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> temp.dt)</span>
<span id="cb7-190"></span>
<span id="cb7-191">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb7-192">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb7-193">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb7-194"></span>
<span id="cb7-195"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb7-196">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-197">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> temp.dt)</span>
<span id="cb7-198"></span>
<span id="cb7-199">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb7-200">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb7-201">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb7-202"></span>
<span id="cb7-203"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.1 from up.Q1.1, using A=1 cases</span></span>
<span id="cb7-204">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-205"></span>
<span id="cb7-206">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-207">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-208"></span>
<span id="cb7-209">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb7-210"></span>
<span id="cb7-211">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-212">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.1'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-213"></span>
<span id="cb7-214">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb7-215"></span>
<span id="cb7-216"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.0 from up.Q1.0, using A=0 cases</span></span>
<span id="cb7-217">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb7-218"></span>
<span id="cb7-219">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-220">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-221"></span>
<span id="cb7-222">Q2_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q2)</span>
<span id="cb7-223"></span>
<span id="cb7-224">pred.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-225">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up.Q1.0'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-226"></span>
<span id="cb7-227">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q2_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q2)</span>
<span id="cb7-228"></span>
<span id="cb7-229"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 2 ------------------</span></span>
<span id="cb7-230"></span>
<span id="cb7-231"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed values for up.Q1 and Q2</span></span>
<span id="cb7-232"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb7-233">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-234">  .[, Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb7-235">  .[, clever.H2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> ((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb7-236"></span>
<span id="cb7-237"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb7-238">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data)</span>
<span id="cb7-239"></span>
<span id="cb7-240"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.1</span></span>
<span id="cb7-241">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb7-242">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb7-243">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre))</span>
<span id="cb7-244"></span>
<span id="cb7-245"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.0</span></span>
<span id="cb7-246">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb7-247">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb7-248">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre)))</span>
<span id="cb7-249"></span>
<span id="cb7-250"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q2.1 - Q2.0</span></span>
<span id="cb7-251"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q2</span></span>
<span id="cb7-252"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb7-253">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-254">  .[, up.Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-255">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R3]</span>
<span id="cb7-256"></span>
<span id="cb7-257"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb7-258">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb7-259"></span>
<span id="cb7-260"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-261">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb7-262">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb7-263">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2))</span>
<span id="cb7-264"></span>
<span id="cb7-265"></span>
<span id="cb7-266"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-267"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 7: pre-exp TMLE  ---------------------------------------------------</span></span>
<span id="cb7-268"></span>
<span id="cb7-269"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update R-predictions</span></span>
<span id="cb7-270"></span>
<span id="cb7-271"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb7-272">train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-273">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R3'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>))</span>
<span id="cb7-274"></span>
<span id="cb7-275">R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-276">R_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-277"></span>
<span id="cb7-278"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-predictions</span></span>
<span id="cb7-279"></span>
<span id="cb7-280"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1: MISSPECIFIED</span></span>
<span id="cb7-281">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-282"></span>
<span id="cb7-283">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> full.data)</span>
<span id="cb7-284"></span>
<span id="cb7-285"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb7-286">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb7-287"></span>
<span id="cb7-288"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb7-289">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-290"></span>
<span id="cb7-291"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb7-292">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb7-293"></span>
<span id="cb7-294"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb7-295">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-296">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-297">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb7-298">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb7-299"></span>
<span id="cb7-300">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb7-301">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb7-302">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb7-303"></span>
<span id="cb7-304"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb7-305">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-306">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-307">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb7-308">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb7-309"></span>
<span id="cb7-310">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb7-311">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb7-312">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb7-313"></span>
<span id="cb7-314"></span>
<span id="cb7-315"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q1.1 - Q1.0</span></span>
<span id="cb7-316"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q1</span></span>
<span id="cb7-317"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb7-318">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-319">  .[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-320">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R3]</span>
<span id="cb7-321"></span>
<span id="cb7-322"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb7-323">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb7-324"></span>
<span id="cb7-325"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb7-326">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb7-327">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb7-328">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1))</span>
<span id="cb7-329"></span>
<span id="cb7-330"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb7-331"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualization of results -----------------------------------------------------</span></span>
<span id="cb7-332"></span>
<span id="cb7-333"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PUT ALL TOGETHER</span></span>
<span id="cb7-334">estimators <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(pate,sate,unadj.est,tmle.ptest,tmle.proc,</span>
<span id="cb7-335">                              tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step,diw.est,nesreg.T,tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step))</span>
<span id="cb7-336"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(estimators) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'point.est'</span>)</span>
<span id="cb7-337">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle PATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle SATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Student's t-test"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML CCA'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreProc'</span>,</span>
<span id="cb7-338">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreExp'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DIW'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Nested Reg'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML 2-Step'</span>)</span>
<span id="cb7-339"></span>
<span id="cb7-340">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type))</span>
<span id="cb7-341"></span>
<span id="cb7-342">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type))</span>
<span id="cb7-343"></span>
<span id="cb7-344"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate and CI plot</span></span>
<span id="cb7-345"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(estimators, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>point.est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-346">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-347">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span>lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span>upper, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type),</span>
<span id="cb7-348">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-349">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimator'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-350">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_linedraw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> pate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="case-3b-low-missingnessselection-with-misspecification-of-q_2-and-r" class="level2">
<h2 class="anchored" data-anchor-id="case-3b-low-missingnessselection-with-misspecification-of-q_2-and-r">Case 3B: low missingness/selection with misspecification of <img src="https://latex.codecogs.com/png.latex?Q_2"> and <img src="https://latex.codecogs.com/png.latex?r"></h2>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Misspecified prob of selection -----------------------------------------------</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb8-5">R_mis <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(R3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">poly</span>(M,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(Z)),</span>
<span id="cb8-6">                    full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logit'</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 4: Doubly-inverse weighted estimator -------------------------------</span></span>
<span id="cb8-10"></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LM with doubly inverse weights</span></span>
<span id="cb8-12">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, DIW <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))]</span>
<span id="cb8-13"></span>
<span id="cb8-14">diw.mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_robust</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>A,full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> DIW)</span>
<span id="cb8-15"></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb8-17">diw.est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.low[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb8-18">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.high[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb8-19">                   diw.mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb8-20"></span>
<span id="cb8-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 5: Nested regressions, T-learner -----------------------------------</span></span>
<span id="cb8-23"></span>
<span id="cb8-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb8-25">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-27"></span>
<span id="cb8-28">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb8-29"></span>
<span id="cb8-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb8-31">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-33"></span>
<span id="cb8-34">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-35"></span>
<span id="cb8-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2 misspecified</span></span>
<span id="cb8-37">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>W))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), full.data)</span>
<span id="cb8-38"></span>
<span id="cb8-39">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb8-40"></span>
<span id="cb8-41">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-42"></span>
<span id="cb8-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predicted difference Q2.1 - Q2.0</span></span>
<span id="cb8-44"></span>
<span id="cb8-45">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span></span>
<span id="cb8-46"></span>
<span id="cb8-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bootstrap procedure to compute the standard deviation</span></span>
<span id="cb8-48"></span>
<span id="cb8-49">bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb8-50"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>){</span>
<span id="cb8-51">  </span>
<span id="cb8-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boostraped data</span></span>
<span id="cb8-53">  ind <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N,N,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb8-54">  bs.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data[ind,])</span>
<span id="cb8-55">  </span>
<span id="cb8-56">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb8-57">  train.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-59">  </span>
<span id="cb8-60">  bs.Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.bs.Q1)</span>
<span id="cb8-61">  </span>
<span id="cb8-62">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb8-63">  pred.bs.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> bs.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-65">  </span>
<span id="cb8-66">  bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> bs.Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.bs.Q1)</span>
<span id="cb8-67">  </span>
<span id="cb8-68">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q2</span></span>
<span id="cb8-69">  train.bs.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>W))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), bs.data)</span>
<span id="cb8-70"></span>
<span id="cb8-71">  full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.bs.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb8-72"></span>
<span id="cb8-73">  full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.bs.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-74">  </span>
<span id="cb8-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add predicted difference Q2.1 - Q2.0 to boostrap vessel</span></span>
<span id="cb8-76">  bsamples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(bsamples, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>bs.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>))</span>
<span id="cb8-77">}</span>
<span id="cb8-78"></span>
<span id="cb8-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb8-80">nesreg.T <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb8-81">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(bsamples),</span>
<span id="cb8-82">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta))</span>
<span id="cb8-83"></span>
<span id="cb8-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 6: 2-step TMLE  ----------------------------------------------------</span></span>
<span id="cb8-86"></span>
<span id="cb8-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 1 ------------------</span></span>
<span id="cb8-88"></span>
<span id="cb8-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb8-90">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb8-91"></span>
<span id="cb8-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb8-93">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb8-94"></span>
<span id="cb8-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb8-96">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb8-97"></span>
<span id="cb8-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb8-99">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-100">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-101">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-102">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-103"></span>
<span id="cb8-104">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb8-105">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb8-106">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb8-107"></span>
<span id="cb8-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb8-109">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-110">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-111">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z'</span>))</span>
<span id="cb8-112">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-113"></span>
<span id="cb8-114">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb8-115">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb8-116">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb8-117"></span>
<span id="cb8-118">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ]</span>
<span id="cb8-119"></span>
<span id="cb8-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learn Q2.1,0 from up.Q1.1,0</span></span>
<span id="cb8-121">train.Q2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>W))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(W<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), full.data)</span>
<span id="cb8-122"></span>
<span id="cb8-123">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb8-124"></span>
<span id="cb8-125">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(train.Q2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>W,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-126"></span>
<span id="cb8-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># STEP 2 ------------------</span></span>
<span id="cb8-128"></span>
<span id="cb8-129"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed values for up.Q1 and Q2</span></span>
<span id="cb8-130"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb8-131">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-132">  .[, clever.H2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> ((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb8-133"></span>
<span id="cb8-134"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb8-135">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data)</span>
<span id="cb8-136"></span>
<span id="cb8-137"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.1</span></span>
<span id="cb8-138">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb8-139">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb8-140">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre))</span>
<span id="cb8-141"></span>
<span id="cb8-142"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q2.0</span></span>
<span id="cb8-143">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, </span>
<span id="cb8-144">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q2.A=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb8-145">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H2=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre)))</span>
<span id="cb8-146"></span>
<span id="cb8-147"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q2.1 - Q2.0</span></span>
<span id="cb8-148"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q2</span></span>
<span id="cb8-149"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb8-150">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-151">  .[, up.Q2.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-152">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q2.A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R3]</span>
<span id="cb8-153"></span>
<span id="cb8-154"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb8-155">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb8-156"></span>
<span id="cb8-157"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb8-158">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb8-159">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb8-160">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q2))</span>
<span id="cb8-161"></span>
<span id="cb8-162"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-163"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimator 7: pre-exp TMLE  ---------------------------------------------------</span></span>
<span id="cb8-164"></span>
<span id="cb8-165"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update R-predictions</span></span>
<span id="cb8-166"></span>
<span id="cb8-167"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for missingness mechanism</span></span>
<span id="cb8-168">R_mis <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(R3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> W,</span>
<span id="cb8-169">                    full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logit'</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb8-170"></span>
<span id="cb8-171"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-predictions</span></span>
<span id="cb8-172"></span>
<span id="cb8-173"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Q1</span></span>
<span id="cb8-174">train.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-175">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb8-176"></span>
<span id="cb8-177">Q1_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> super_C<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q1)</span>
<span id="cb8-178"></span>
<span id="cb8-179"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for Q1</span></span>
<span id="cb8-180">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-181">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> full.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb8-182"></span>
<span id="cb8-183">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-184"></span>
<span id="cb8-185"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define clever variable</span></span>
<span id="cb8-186">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, clever.H1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))] </span>
<span id="cb8-187"></span>
<span id="cb8-188"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define fluctuation model</span></span>
<span id="cb8-189">fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>full.data[R3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb8-190"></span>
<span id="cb8-191"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Auxiliary data frame for prediction</span></span>
<span id="cb8-192">temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(full.data)</span>
<span id="cb8-193"></span>
<span id="cb8-194"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.1</span></span>
<span id="cb8-195">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-196">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-197">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb8-198">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-199"></span>
<span id="cb8-200">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb8-201">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>,</span>
<span id="cb8-202">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>A_pre)))</span>
<span id="cb8-203"></span>
<span id="cb8-204"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using estimated fluctuation parameter, update Q1.0</span></span>
<span id="cb8-205">temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-206">pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-207">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb8-208">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q1_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-209"></span>
<span id="cb8-210">full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fluct.model<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, </span>
<span id="cb8-211">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1=</span>full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>,</span>
<span id="cb8-212">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clever.H1=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_mis)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_pre))))</span>
<span id="cb8-213"></span>
<span id="cb8-214"></span>
<span id="cb8-215"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the updated difference Q1.1 - Q1.0</span></span>
<span id="cb8-216"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the observed value for up.Q1</span></span>
<span id="cb8-217"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the value of the efficient influence function</span></span>
<span id="cb8-218">full.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> full.data[, delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-219">  .[, up.Q1.A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>up.Q1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-220">  .[, EIF <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> delta.up.Q1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> clever.H1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> up.Q1.A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R3]</span>
<span id="cb8-221"></span>
<span id="cb8-222"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the EIF, compute the asymptotic error</span></span>
<span id="cb8-223">asymp.sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>EIF)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(N)</span>
<span id="cb8-224"></span>
<span id="cb8-225"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save estimate and CI</span></span>
<span id="cb8-226">tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb8-227">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>asymp.sd,</span>
<span id="cb8-228">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(full.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>delta.up.Q1))</span>
<span id="cb8-229"></span>
<span id="cb8-230"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-------------------------------------------------------------------------------</span></span>
<span id="cb8-231"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualization of results -----------------------------------------------------</span></span>
<span id="cb8-232"></span>
<span id="cb8-233"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PUT ALL TOGETHER</span></span>
<span id="cb8-234">estimators <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(pate,sate,unadj.est,tmle.ptest,tmle.proc,</span>
<span id="cb8-235">                              tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>step,diw.est,nesreg.T,tmle<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>step))</span>
<span id="cb8-236"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(estimators) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'point.est'</span>)</span>
<span id="cb8-237">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle PATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Oracle SATE'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Student's t-test"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML CCA'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreProc'</span>,</span>
<span id="cb8-238">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML PreExp'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DIW'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Nested Reg'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TML 2-Step'</span>)</span>
<span id="cb8-239"></span>
<span id="cb8-240">estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(estimators<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type))</span>
<span id="cb8-241"></span>
<span id="cb8-242"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#j=8</span></span>
<span id="cb8-243"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#glue('lower whisker={estimators[j,1]}, median={estimators[j,3]}, upper whisker={estimators[j,2]}')</span></span>
<span id="cb8-244"></span>
<span id="cb8-245"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate and CI plot</span></span>
<span id="cb8-246"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(estimators, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>point.est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-247">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-248">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span>lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span>upper, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type),</span>
<span id="cb8-249">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.78</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-250">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimator'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-251">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_linedraw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> pate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<ul>
<li><p><strong>Nested regression estimator</strong> provides the best alternative under the assumption of correct models specifications. It can consistently recover the ATE from confounding and selection bias (under conditional ignorability and recoverability conditions), and it presents narrower confidence interval relative to the DIW and TML 2-steps estimators, which are also consistent in this scenario. Yet, it requires a bootstrap procedure to compute standard errors, which might be costly in complex models/datasets, and <strong>it fails to be consistent when one the outcome models are not correctly specified</strong>.</p></li>
<li><p><strong>TML 2-step estimator</strong> is less efficient than nested regression estimator, producing wider confidence intervals, but it is more efficient than the DIW estimator. Moreover, it remains consistent even when the outcome models are not correctly specified, provided the treatment assignment and missingness mechanisms are both correct.</p></li>
</ul>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-PearlCausality" class="csl-entry">
Pearl, Judea. 2009. <em>Causality: Models, Reasoning, and Inference</em>. 2nd ed. Cambridge, UK: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511803161">https://doi.org/10.1017/CBO9780511803161</a>.
</div>
<div id="ref-TMLEbook1" class="csl-entry">
van der Laan, M. J., and S. Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.no/books?id=RGnSX5aCAgQC">https://books.google.no/books?id=RGnSX5aCAgQC</a>.
</div>
</div></section></div> ]]></description>
  <category>selection bias</category>
  <category>mediation</category>
  <category>regression</category>
  <category>IPW</category>
  <category>doubly-robust</category>
  <category>TMLE</category>
  <guid>https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/index.html</guid>
  <pubDate>Sat, 14 Oct 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-10-15_grapeSimulation/logo.png" medium="image" type="image/png" height="131" width="144"/>
</item>
<item>
  <title>Structure learning for downstream causal inference with missing outcome data</title>
  <link>https://johandh2o.github.io/posts/2023-09-15_structureUQ/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="structural-causal-models" class="level2">
<h2 class="anchored" data-anchor-id="structural-causal-models">Structural causal models</h2>
<p>The most complete and versatile axiomatic treatment of causal inference is given by the <em>structural causal model</em> (SCM) framework, developed by celebrated computer scientist and philosopher Dr.&nbsp;Judea Pearl <span class="citation" data-cites="PearlCausality">(Pearl 2009)</span>. A brief introduction of SCM is given in a <a href="https://johandh2o.github.io/blog/posts/2023-09-01_UQcausality/">previous blog post</a>.</p>
</section>
<section id="structure-uncertainty-and-causal-inference" class="level2">
<h2 class="anchored" data-anchor-id="structure-uncertainty-and-causal-inference">Structure uncertainty and causal inference</h2>
<p>Consider the case of a data-generating process (DGP) consisting of a set of pre-treatment variables <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D">, a binary exposure <img src="https://latex.codecogs.com/png.latex?A">, and a continuous outcome <img src="https://latex.codecogs.com/png.latex?Y">. We are interested in estimating the <em>average treatment effect</em> (ATE), given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5Cpsi%20=%20%5CDelta_a%20%5Cmathbb%7BE%7D%5Cleft%5BY%5Cmid%20do(A=a)%20%5Cright%5D%0A"> To estimate such a parameter from observational data on <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D=%5C%7B%5Cmathcal%7BW%7D,A,Y%5C%7D">, <strong>identification</strong> must be established beforehand. A causal estimand is <em>nonparametrically</em> identified from the joint distribution <img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BV%7D)"> if it can uniquely computed as a functional of it. In other words, <img src="https://latex.codecogs.com/png.latex?Q"> is identified if there exists a <strong>functional/algorithm</strong> <img src="https://latex.codecogs.com/png.latex?%5CPsi_%5Cmathcal%7BG%7D:P(%5Cmathcal%7BV%7D)%5Cmapsto%20Q">, such that such that it returns a unique value up to some equivalent relation.</p>
<p>Under the graphical assumption of <em>back-door admissibility</em> of <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> (meaning that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D"> blocks <strong>all paths</strong> between <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> that start with an arrow pointing to <img src="https://latex.codecogs.com/png.latex?A">) we get <em>conditional ignorability</em> and thus identification of <img src="https://latex.codecogs.com/png.latex?%5Cpsi">, which now can be expressed as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5Cpsi%20=%20%5CPsi_%5Cmathcal%7BG%7D%5BP(%5Cmathcal%7BV%7D)%5D%20=%20%5Cmathbb%7BE%7D_%5Cmathcal%7BW%7D%5CDelta_a%20%5Cmathbb%7BE%7D%5Cleft%5BY%5Cmid%5Cmathcal%7BW%7D,A=a%20%5Cright%5D%0A"></p>
<p>Such a graphical assumption validates other identification functionals, such as those given by <em>inverse probability weighting</em> (IPW) and doubly-robust approaches (AIPW, TMLE, DML). With finite samples, and a consistent estimator for the inner regression, a valid estimator is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5Chat%7B%5Cpsi%7D%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5CDelta_a%20%5Chat%7B%5Cmathbb%7BE%7D%7D%5Cleft%5BY%5Cmid%5Cmathcal%7BW%7D%5Ei,A=a%20%5Cright%5D%0A"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Under ignorability, the structure <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> is not required, i.e., if <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> is unknown, <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D"> can still be constructed and will be consistent. The set <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D"> might contain variables that are not confounders, and other unimportant variables, so <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D"> might be statistically inefficient. Removing apparent unimportant variables from <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D"> might increase precision, but would potentially introduce confounding bias, if the eliminated variable is a weak confounding. <strong>Causal inferece is a bias-conservative endeavor, so we are more willing to sacrifice precision instead of introducing confounding bias</strong>.</p>
</div>
</div>
</section>
<section id="post-treatment-selection-induced-by-missing-outcome-data-justification-for-structure-learning" class="level2">
<h2 class="anchored" data-anchor-id="post-treatment-selection-induced-by-missing-outcome-data-justification-for-structure-learning">Post-treatment selection induced by missing outcome data: justification for structure learning</h2>
<p>Now consider the inclusion of a set of post-treatment (pre-outcome) variables <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BZ%7D_0"> in the data. Besides, there is a unknown missingness mechanisms <img src="https://latex.codecogs.com/png.latex?R_Y"> at play that dictates which observations of <img src="https://latex.codecogs.com/png.latex?Y"> are selected (<img src="https://latex.codecogs.com/png.latex?R_Y=1">) and which are missing (<img src="https://latex.codecogs.com/png.latex?R_Y=0">). In this setting, the ATE is identified under the following graphical criteria:</p>
<ul>
<li>All non-causal paths between <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> are blocked by <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D"> in the substantive model: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20A%5Cmid%20%5Cmathcal%7BW%7D"> in <img src="https://latex.codecogs.com/png.latex?(%5Cmathcal%7BG%7D%5Cominus%20R_Y)%5BA%5C!-%5C!Y%5D"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BW%7D%5Ccup%5Cmathcal%7BZ%7D"> <img src="https://latex.codecogs.com/png.latex?d">-separates <img src="https://latex.codecogs.com/png.latex?Y"> from <img src="https://latex.codecogs.com/png.latex?R_Y"> in the proper back-door graph: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20R_Y%5Cmid%20%5Cmathcal%7BW%7D,%5Cmathcal%7BZ%7D"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D%5BA%5C!-%5C!Y%5D"></li>
</ul>
<p>Then, the ATE and its regression estimator, can be expressed as:</p>
<p><span id="eq-1"><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cpsi_1%20&amp;=%20%5Cmathbb%7BE%7D_%5Cmathcal%7BW%7D%5C,%5CDelta_a%5Cmathbb%7BE%7D_%7B%5Cmathcal%7BZ%7D%5Cmid%20%5Cmathcal%7BW%7D,A=a%7D%5C,%20%5Cmathbb%7BE%7D%5BY%5Cmid%20%5Cmathcal%7BW%7D,%5Cmathcal%7BZ%7D,A=a,R_Y=1%5D%5C%5C%0A%5Chat%7B%5Cpsi%7D_1%20&amp;=%20%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5CDelta_a%5Chat%7B%5Cmathbb%7BE%7D%7D_%7B%5Cmathcal%7BZ%7D%5Cmid%20%5Cmathcal%7BW%7D,A=a%7D%5C,%20%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20%5Cmathcal%7BW%7D%5Ei,%5Cmathcal%7BZ%7D%5Ei,A=a,R_Y=1%5D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B1%7D"></span></p>
<p>However, “weaker” graphical conditions can also lead to identification. For instance, if there exist <img src="https://latex.codecogs.com/png.latex?W%5Csubseteq%5Cmathcal%7BW%7D"> and <img src="https://latex.codecogs.com/png.latex?Z_0,Z_1%5Csubseteq%5Cmathcal%7BZ%7D">, such that:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?W%5Ccup%20Z_0%5Ccup%20Z_1"> <img src="https://latex.codecogs.com/png.latex?d">-separates <img src="https://latex.codecogs.com/png.latex?Y"> from <img src="https://latex.codecogs.com/png.latex?R_Y"> in the proper back-door graph: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20R_Y%5Cmid%20W,Z_1,Z_2"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D%5BA%5C!-%5C!Y%5D"></li>
<li>All non-causal paths between <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> are blocked by <img src="https://latex.codecogs.com/png.latex?W"> in the substantive model: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20A%5Cmid%20W"> in <img src="https://latex.codecogs.com/png.latex?(%5Cmathcal%7BG%7D%5Cominus%20R_Y)%5BA%5C!-%5C!Y%5D"></li>
<li><img src="https://latex.codecogs.com/png.latex?Z_0"> does not contain forbidden nodes (mediators or their descendants) (nor descendants of A) and <img src="https://latex.codecogs.com/png.latex?Z_1"> contains only forbidden nodes</li>
</ul>
<p>Then, the ATE and its regression estimator can be expressed as:</p>
<p><span id="eq-2"><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cpsi_2%20&amp;=%20%5Cmathbb%7BE%7D_%7BW,Z_0%7D%5C,%5CDelta_a%5Cmathbb%7BE%7D_%7BZ_1%5Cmid%20W,Z_0,A=a%7D%5C,%20%5Cmathbb%7BE%7D%5BY%5Cmid%20W,Z_0,Z_1,A=a,R_Y=1%5D%5C%5C%0A%5Chat%7B%5Cpsi%7D_2%20&amp;=%20%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5CDelta_a%5Chat%7B%5Cmathbb%7BE%7D%7D_%7BZ_1%5Cmid%20W,Z_0,A=a%7D%5C,%20%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20W%5Ei,Z_0%5Ei,Z_1%5Ei,A=a,R_Y=1%5D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B2%7D"></span></p>
<p>Moreover, if in the true graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> the first condition is met with only <img src="https://latex.codecogs.com/png.latex?W%5Ccup%20Z_0"> (<img src="https://latex.codecogs.com/png.latex?Z_1"> not required), the final estimator requires <strong>only one</strong> regression model:</p>
<p><span id="eq-3"><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%5Cpsi_3%20&amp;=%20%5Cmathbb%7BE%7D_%7BW,Z_0%7D%5C,%5CDelta_a%20%5Cmathbb%7BE%7D%5BY%5Cmid%20W,Z_0,A=a,R_Y=1%5D%5C%5C%0A%5Chat%7B%5Cpsi%7D_3%20&amp;=%20%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5CDelta_a%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20W%5Ei,Z_0%5Ei,A=a,R_Y=1%5D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B3%7D"></span></p>
<p>It is expected that, in this case, <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D_3"> is is asymptotically more efficient than <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D_1"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cpsi%7D_2">. An even more efficient estimator can leverage more information fom <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, such as conditioning on the remaining <img src="https://latex.codecogs.com/png.latex?pa(Y;%5Cmathcal%7BG%7D)"></p>
<p><span id="eq-4"><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Cpsi%7D_4%20=%20%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5CDelta_a%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20W%5Ei,Z_0%5Ei,T%5Ei,A=a,R_Y=1%5D%0A%5Ctag%7B4%7D"></span></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?T=pa(Y;%5Cmathcal%7BG%7D)%5C,%5Csetminus%5C%20de(A;%5Cmathcal%7BG%7D)%5C,%5Csetminus%20(W%5Ccup%20Z_0%5Ccup%20A%5Ccup%20R_Y)"></p>
<div class="callout callout-style-default callout-tip callout-titled" title="Justification for structure learning">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Justification for structure learning
</div>
</div>
<div class="callout-body-container callout-body">
<p>In conclusion, recovery of the ATE from post-treatment selection induced by missing outcome data requires more information from the causal graph, not only to gain statistical efficiency but to inform modeling decisions, i.e., the number and type of regression models needed, the dimension of fluctuation parameter is targeted learning, and more.</p>
</div>
</div>
</section>
<section id="constrained-structure-learning" class="level2">
<h2 class="anchored" data-anchor-id="constrained-structure-learning">Constrained structure learning</h2>
<p>Bayesian structure learning is a type of Bayesian inverse problem that aims to infer the posterior distribution of <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> given data <img src="https://latex.codecogs.com/png.latex?%5Cboldsymbol%7BO%7D">, i.e., <img src="https://latex.codecogs.com/png.latex?p(%5Cmathcal%7BG%7D%5Cmid%5Cboldsymbol%7BO%7D)">. Many MCMC, VI, and particle-based algorithms have been designed for this purpose, each with its sets of assumptions, strengths and weaknesses.</p>
<p>In our motivated case, structure learning should be constrain to respect the known topological partial order induced by time. This is, future variables cannot influence past variables. This implies adjacency matrix <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> can be expressed in block form as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BG%7D=%5Cleft(%5Cbegin%7Barray%7D%7Bc%7Cccccc%7D%20%20%0A%20%20%20&amp;%20%5Cmathcal%7BW%7D%20&amp;%20A%20&amp;%20%5Cmathcal%7BZ%7D%20&amp;%20R_Y%20&amp;%20Y%5C%5C%20%5Chline%20%20%0A%20%20%20%5Cmathcal%7BW%7D%20&amp;%200%20&amp;%20C_1%20&amp;%20B_1%20&amp;%20B_1%20&amp;%20C_2%5C%5C%0A%20%20%20A%20&amp;%200%20&amp;%200%20&amp;%20C_3%20&amp;%20C_3%20&amp;%20C_3%5C%5C%0A%20%20%20%5Cmathcal%7BZ%7D%20&amp;%200%20&amp;%200%20&amp;%20D%20&amp;%20B_2%20&amp;%20B_2%5C%5C%0A%20%20%20R_Y%20&amp;%200%20&amp;%200%20&amp;%200%20&amp;%200%20&amp;%200%5C%5C%0A%20%20%20Y%20&amp;%200%20&amp;%200%20&amp;%200%20&amp;%200%20&amp;%200%5C%5C%0A%5Cend%7Barray%7D%5Cright)%0A"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?B_1,B_2"> are bipartite graphs, <img src="https://latex.codecogs.com/png.latex?C_1,C_2,C_3"> are bipartite graphs of one node on one side, and <img src="https://latex.codecogs.com/png.latex?D"> is a DAG.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Within <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BZ%7D"> no time- or topological order is known a priori.</p>
</div>
</div>
<p>The problem is now equivalent to infering <img src="https://latex.codecogs.com/png.latex?p(B_1,B_2,C_1,C_2,C_3,D%5Cmid%5Cboldsymbol%7BO%7D)"></p>
</section>
<section id="representation-of-bipartite-graphs-and-dags" class="level2">
<h2 class="anchored" data-anchor-id="representation-of-bipartite-graphs-and-dags">Representation of bipartite graphs and DAGs</h2>
<p>Let <img src="https://latex.codecogs.com/png.latex?d_w=%7C%5Cmathcal%7BW%7D%7C">, <img src="https://latex.codecogs.com/png.latex?d_z=%7C%5Cmathcal%7BZ%7D%7C"> and <img src="https://latex.codecogs.com/png.latex?d=d_w+d_z+3">. The (adjacency matrix) of DAG <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> lives in <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1%5C%7D%5E%7Bd%5Ctimes%20d%7D">, and it can be represented by <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D=S%5Codot%20T">, where <img src="https://latex.codecogs.com/png.latex?T%5Cin%20%5C%7B0,1%5C%7D%5E%7Bd%5Ctimes%20d%7D"> dictates the <em>topological order</em>, i.e, <img src="https://latex.codecogs.com/png.latex?T_%7Bi,j%7D=1"> if <img src="https://latex.codecogs.com/png.latex?i%5Cprec%20j">; and <img src="https://latex.codecogs.com/png.latex?S%5Cin%20%5C%7B0,1%5C%7D%5E%7Bd%5Ctimes%20d%7D"> acts as a <em>mask structure</em> to disable the edge existence. <img src="https://latex.codecogs.com/png.latex?S"> is needed to counter the <em>post hoc ergo propter hoc</em> fallacy: not because <img src="https://latex.codecogs.com/png.latex?j"> follows <img src="https://latex.codecogs.com/png.latex?i">, it is true that <img src="https://latex.codecogs.com/png.latex?i"> causes <img src="https://latex.codecogs.com/png.latex?j">. Any DAG can be represented this way <span class="citation" data-cites="annadani2023bayesdag">(Annadani et al. 2023)</span>.</p>
<p><span class="citation" data-cites="annadani2023bayesdag">Annadani et al. (2023)</span> propose a representation of <img src="https://latex.codecogs.com/png.latex?T"> in term of node potentials <img src="https://latex.codecogs.com/png.latex?%5Crho%5Cin%5Cmathbb%7BR%7D%5Ed">, such that <img src="https://latex.codecogs.com/png.latex?T_%7Bi,j%7D=%5Cmathbb%7BI%7D(%5Crho_j-%5Crho_i%3E0)">, and leverages the equivalence <img src="https://latex.codecogs.com/png.latex?T=%5Csigma(%5Crho)%5CLambda%5Csigma(%5Crho)%5E%5Ctop">, with <img src="https://latex.codecogs.com/png.latex?%5Csigma(%5Crho)"> being a permutation matrix of <img src="https://latex.codecogs.com/png.latex?%5Crho">, and <img src="https://latex.codecogs.com/png.latex?%5CLambda"> being an upper-triangular matrix filled with ones. Such alternative formulation facilitates the computation of approximate gradients with respect to <img src="https://latex.codecogs.com/png.latex?%5Crho"> using techniques from the <em>differentiable permutation</em> literature.</p>
<p>Parameters of <img src="https://latex.codecogs.com/png.latex?S_%7Bi,j%7D"> are updated within the <em>stochastic gradient Markov chain Monte Carlo</em> (SG-MCMC) scheme either via <em>variational inference</em> (as a function of updated <img src="https://latex.codecogs.com/png.latex?%5Crho">) or via own SG-MCMC. The authors point the former performs better, because coupling <img src="https://latex.codecogs.com/png.latex?S"> with <img src="https://latex.codecogs.com/png.latex?%5Crho"> seems to be important. In other words, <strong>the embedding representation of <img src="https://latex.codecogs.com/png.latex?T"> should also be informative of <img src="https://latex.codecogs.com/png.latex?S"></strong>.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-annadani2023bayesdag" class="csl-entry">
Annadani, Yashas, Nick Pawlowski, Joel Jennings, Stefan Bauer, Cheng Zhang, and Wenbo Gong. 2023. <span>“BayesDAG: Gradient-Based Posterior Sampling for Causal Discovery.”</span> <em>arXiv Preprint arXiv:2307.13917</em>.
</div>
<div id="ref-PearlCausality" class="csl-entry">
Pearl, Judea. 2009. <em>Causality: Models, Reasoning, and Inference</em>. 2nd ed. Cambridge, UK: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511803161">https://doi.org/10.1017/CBO9780511803161</a>.
</div>
</div></section></div> ]]></description>
  <category>Bayesian</category>
  <category>MCMC</category>
  <category>VI</category>
  <category>causal inference</category>
  <category>graphical models</category>
  <category>structure learning</category>
  <guid>https://johandh2o.github.io/posts/2023-09-15_structureUQ/index.html</guid>
  <pubDate>Thu, 14 Sep 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-09-15_structureUQ/logo.png" medium="image" type="image/png" height="132" width="144"/>
</item>
<item>
  <title>Uncertainty modeling and quantification for causal inference</title>
  <link>https://johandh2o.github.io/posts/2023-09-01_UQcausality/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="structural-causal-models-a-simple-introduction-and-example" class="level2">
<h2 class="anchored" data-anchor-id="structural-causal-models-a-simple-introduction-and-example">Structural causal models: a simple introduction and example</h2>
<p>The most complete and versatile axiomatic treatment of causal inference is given by the <em>structural causal model</em> (SCM) framework, by celebrated computer scientist and philosopher Dr.&nbsp;Judea Pearl <span class="citation" data-cites="PearlCausality">(Pearl 2009)</span>. Let us give a simple example:</p>
<p>Consider an experiment where we apply an external force <img src="https://latex.codecogs.com/png.latex?F"> on objects with different masses <img src="https://latex.codecogs.com/png.latex?m"> and then measure their induced acceleration <img src="https://latex.codecogs.com/png.latex?a">. Let us put all these variables together: <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D=%5C%7Bm,F,a%5C%7D">. Here, <img src="https://latex.codecogs.com/png.latex?m"> and <img src="https://latex.codecogs.com/png.latex?F"> are <em>controlled</em> (possibly randomly assigned) by the researcher, so they might be considered <em>exogenous</em>.</p>
<p>Acceleration measurements is noisy, due to random measurement errors or residual forces applied (air current). Such noise is captured by random variable <img src="https://latex.codecogs.com/png.latex?U_a">. Let us put all exogenous variables and noises together in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BU%7D=%5C%7Bm,F,U_a%5C%7D">. Observations from these variables come respectively from <img src="https://latex.codecogs.com/png.latex?P(m),%20P(F),%20P(U_a)"> (independent) distributions.</p>
<p>Since we measure the induced acceleration after an applied force, and we know there’s a theoretical (causal) relation between them, we can say that such acceleration is <strong>caused</strong> by the force. We can represent this graphically as <img src="https://latex.codecogs.com/png.latex?F%5Crightarrow%20a">. We also know changes in the mass being pushed induce changes in the resulting acceleration, so the <img src="https://latex.codecogs.com/png.latex?m"> is also a cause of <img src="https://latex.codecogs.com/png.latex?a">, or <img src="https://latex.codecogs.com/png.latex?m%5Crightarrow%20a">. The external force is applied independent of the mass, so none is cause of the other. We can represent succinctly such <strong>causal structure</strong> with a <em>directed acyclic graph</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BG%7D%20:%5Cquad%20F%5Crightarrow%20a%5Cleftarrow%20m%0A"> By Newton’s second law formula (with noise), measured acceleration can be expressed as <img src="https://latex.codecogs.com/png.latex?a%20=%20m%5E%7B-1%7DF+U_a">. This can be shortly expressed as <img src="https://latex.codecogs.com/png.latex?a=f_a(m,F,U_a)">, where <img src="https://latex.codecogs.com/png.latex?f_a"> is the acceleration’s <strong>causal mechanism</strong>: a deterministic function defined as <img src="https://latex.codecogs.com/png.latex?f_a(x,y,z)=x%5E%7B-1%7Dy+z"></p>
<p>Then, the tuple of mathematical objects <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D=(%5Cmathcal%7BV%7D,%5Cmathcal%7BU%7D,%5Cmathcal%7BG%7D,f_a,%7BP%7D(%5Cmathcal%7BU%7D))"> is a structural causal model (SCM) that fully describes the system, and can be leveraged to answer queries in three levels:</p>
<ul>
<li><strong>Observational</strong>: keeping the mass constant at <img src="https://latex.codecogs.com/png.latex?m=2">kg, what is the observed curve <img src="https://latex.codecogs.com/png.latex?F"> vs.&nbsp;<img src="https://latex.codecogs.com/png.latex?a">?</li>
<li><strong>Causal</strong>: what’s the average change in <img src="https://latex.codecogs.com/png.latex?a"> if <img src="https://latex.codecogs.com/png.latex?F"> changes from <img src="https://latex.codecogs.com/png.latex?F=1">N to <img src="https://latex.codecogs.com/png.latex?F=2">N with a mass of <img src="https://latex.codecogs.com/png.latex?1">kg?</li>
<li><strong>Counterfactual</strong>: what <em>would have been</em> the value of <img src="https://latex.codecogs.com/png.latex?a"> under <img src="https://latex.codecogs.com/png.latex?F=2">N for a mass <img src="https://latex.codecogs.com/png.latex?m=1">kg that actually experienced <img src="https://latex.codecogs.com/png.latex?F=1">N and measured <img src="https://latex.codecogs.com/png.latex?a=1">?</li>
</ul>
</section>
<section id="structural-causal-models-a-more-technical-introduction" class="level2">
<h2 class="anchored" data-anchor-id="structural-causal-models-a-more-technical-introduction">Structural causal models: a more technical introduction</h2>
<p>An SCM is a tuple of mathematical objects <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D=(%5Cmathcal%7BV%7D,%5Cmathcal%7BU%7D,%5Cmathcal%7BG%7D,%5Cmathcal%7BF%7D,%7BP%7D(%5Cmathcal%7BU%7D))"><sup>1</sup>, such that:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D"> is a finite set of relevant random variables (<em>the data</em>)</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BU%7D"> is a finite set of exogenous random variables and background noises</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> is a <em>directed acyclic graph</em> on <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BU%7D)"> is a probability measure for <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BU%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D=%5C%7Bf_V%5C%7D_%7BV%5Cin%5Cmathcal%7BV%7D%7D"> is an indexed collection of measurable functions specifying the causal relations i.e., for every <img src="https://latex.codecogs.com/png.latex?V%5Cin%5Cmathcal%7BV%7D"> there is a <img src="https://latex.codecogs.com/png.latex?U_V%5Cin%5Cmathcal%7BU%7D"> and a function <img src="https://latex.codecogs.com/png.latex?f_V:%5Ctext%7Bsupp%7D%5C,%20%5Ctext%7Bpa%7D(V;%5Cmathcal%7BG%7D)%5Ctimes%20%5Ctext%7Bsupp%7D%5C,%20U_V%5Crightarrow%5Ctext%7Bsupp%7D%5C,%20V">, such that <img src="https://latex.codecogs.com/png.latex?V=f_V(%5Ctext%7Bpa%7D(V;%5Cmathcal%7BG%7D),U_V)"><sup>2</sup> almost surely</li>
</ul>
<p>An SCM is <strong>Markovian</strong> if all the background noises <img src="https://latex.codecogs.com/png.latex?%5C%7BU_V%5C%7D_%7BV%5Cin%5Cmathcal%7BV%7D%7D"> are assumed to be mutually independent. In this case, the set of conditional independence statements encoded in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> allows a Bayesian network representation that factorizes the joint distribution in terms of independent causal families <span class="citation" data-cites="PearlCausality">(Pearl 2009)</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cmathcal%7BV%7D)%20=%20%5Cprod_%7BV%5Cin%5Cmathcal%7BV%7D%7Dp(V%5Cmid%20%5Ctext%7Bpa%7D(V;%5Cmathcal%7BG%7D))%0A"></p>
<p>A <strong>hard intervention</strong> on a collection of variables <img src="https://latex.codecogs.com/png.latex?A=(A_j)_%7Bj%5Cin%20J%7D%5Csubset%5Cmathcal%7BV%7D"> to the assigned value <img src="https://latex.codecogs.com/png.latex?a=(a_j)_%7Bj%5Cin%20J%7D%5Cin%5Ctext%7Bsupp%7D%5C,%20A"> is denoted <img src="https://latex.codecogs.com/png.latex?do(A=a)">. Such intervention induces a new SCM <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D_%7BA=a%7D">, where all <img src="https://latex.codecogs.com/png.latex?f_%7BA_j%7D"> are replaced by constant functions that output the respective value <img src="https://latex.codecogs.com/png.latex?a_j">. Its associated graph is the mutilated graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D%5B%5Coverline%7BA%7D%5D"> that removes all incoming arrows to <img src="https://latex.codecogs.com/png.latex?A"> <span class="citation" data-cites="BareinboimHierarchy2022">(Bareinboim et al. 2022)</span>.</p>
<p>Let disjoint <img src="https://latex.codecogs.com/png.latex?A,Y%5Csubset%5Cmathcal%7BV%7D"> denote respectively <strong>the exposure</strong> and <strong>outcome variables</strong>, the <strong>unit-level counterfactual</strong> <img src="https://latex.codecogs.com/png.latex?Y_%7Ba%7D(u)"> is the value <img src="https://latex.codecogs.com/png.latex?Y"> takes according to <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D_%7BA=a%7D"> in the individual context <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BU%7D=u">. Its induced population-level distribution, named the <strong>interventional distribution</strong>, can be expressed as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20p(y%5Cmid%20do(A=a))%20:=%20p_%7BY_%7Ba%7D%7D(y)=%5Cint_%7B%5Cmathcal%7BU%7D_a%5By%5D%7D%5Ctext%7Bd%7D%20P(u)%0A"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BU%7D_a%5By%5D=%5C%7Bu%5Cin%5Ctext%7Bsupp%7D%5C,%20%5Cmathcal%7BU%7D%20:%20Y_%7Ba%7D(u)=y%20%5C%7D"> is the inverse image of <img src="https://latex.codecogs.com/png.latex?y%5Cin%5Ctext%7Bsupp%7D%5C,%20Y"> under <img src="https://latex.codecogs.com/png.latex?Y_%7Ba%7D(u)"> for a given <img src="https://latex.codecogs.com/png.latex?a%5Cin%5Ctext%7Bsupp%7D%5C,%20A">.</p>
<p>The <strong>average treatment effect</strong> (ATE), <img src="https://latex.codecogs.com/png.latex?%5Cpsi">, and the <img src="https://latex.codecogs.com/png.latex?X">-specific <strong>conditional average treatment effect</strong> (CATE), <img src="https://latex.codecogs.com/png.latex?%5Cpsi_X(%5Ccdot)">, with <img src="https://latex.codecogs.com/png.latex?X%5Csubseteq%5Ctext%7Bnd%7D(A;%5Cmathcal%7BG%7D)"><sup>3</sup>:, are two of the most commonly investigated <em>causal effects/estimands</em>. For binary <img src="https://latex.codecogs.com/png.latex?A">, they correspond to difference functionals of the interventional distribution, and are defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20%5Cpsi%20&amp;:=%20%5CDelta_a%20%5Cmathbb%7BE%7D%5Cleft%5BY%5Cmid%20do(A=a)%20%5Cright%5D%5C%5C%0A%20%20%20%20%5Cpsi_X(x)%20&amp;:=%20%5CDelta_a%20%5Cmathbb%7BE%7D%5Cleft%5BY%5Cmid%20do(A=a),X=x%20%5Cright%5D,%5C,%20%20x%5Cin%5Ctext%7Bsupp%7D%5C,%20X,%5C,%20X%5Csubseteq%5Ctext%7Bnd%7D(A;%5Cmathcal%7BG%7D)%0A%5Cend%7Baligned%7D%0A"></p>
<p>An interventional distribution or causal effect is said to be <strong>nonparametrically identifiable</strong> from positive <img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BV%7D)"> if it can be uniquely computed from it (using the conditional independence statements embedded in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> and its mutilation). In other words, a query <img src="https://latex.codecogs.com/png.latex?Q"> such as interventional distribution, ATE, or CATE, is nonparametrically identifiable from <img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BV%7D)">, if there exists a <strong>functional/algorithm</strong> <img src="https://latex.codecogs.com/png.latex?%5CPsi_%5Cmathcal%7BG%7D:P(%5Cmathcal%7BV%7D)%5Cmapsto%20Q">, such that such that it returns a unique value up to some equivalent relation.</p>
</section>
<section id="uncertainty-modeling-and-quantification-in-structural-causal-models" class="level2">
<h2 class="anchored" data-anchor-id="uncertainty-modeling-and-quantification-in-structural-causal-models">Uncertainty modeling and quantification in structural causal models</h2>
<p>The two <em>natures</em> of uncertainty, aleatoric and epistemic <span class="citation" data-cites="uncertainty2021">(Hüllermeier and Waegeman 2021)</span>, can be associated with different parts of an SCM.</p>
<section id="aleatoric-uncertainty" class="level3">
<h3 class="anchored" data-anchor-id="aleatoric-uncertainty">Aleatoric uncertainty</h3>
<p>It is generally induced by <span style="color:purple;"><strong>randomness</strong></span>, i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BU%7D)"> and, in turn, <img src="https://latex.codecogs.com/png.latex?P(%5Cmathcal%7BV%7D)">.</p>
</section>
<section id="epistemic-uncertainty" class="level3">
<h3 class="anchored" data-anchor-id="epistemic-uncertainty">Epistemic uncertainty</h3>
<p>It is the result of working with <span style="color:purple;"><strong>unknowns</strong></span>. It can be further broken down into:</p>
<ul>
<li><p><strong>Model/mechanism uncertainty</strong>: <span style="color:blue;">induced by unknown <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D"></span>. Its analytic treatment depends on where the true mechanism lies in relation with the working models/hypotheses <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D"> (linear regressions, neural nets, etc.).</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">-<em>closed world</em>: If <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D%5Cin%5Cmathcal%7BM%7D">, model uncertainty can be integrated via <em>Bayesian model-averaging</em>.</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D">-<em>open/complete world</em>: If <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BF%7D%5Cnotin%5Cmathcal%7BM%7D">, model uncertainty can be integrated via <em>Bayesian stacking of predictive distributions</em> <span class="citation" data-cites="stackingAki">(Yao et al. 2018)</span>.</li>
</ul></li>
<li><p><strong>Structure uncertainty</strong>: <span style="color:blue;">induced by unknown <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"></span>, typically under the <em>causal sufficiency assumption</em>, i.e., all relevant endogenous variables <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D"> are observed, but the graph connecting them is not <span class="citation" data-cites="kitson2023survey">(Kitson et al. 2023)</span>.</p>
<ul>
<li>Here, ‘’relevant’’ depends on the downstream task. If the goal is full structure learning, then all <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D"> must be observed. If the goal is downstream causal inference, then a <em>minimal adjustment set</em> must be observed.</li>
</ul></li>
<li><p><strong>Identification uncertainty</strong>: <span style="color:blue;">induced by latent/hidden <img src="https://latex.codecogs.com/png.latex?V_H%5Csubset%5Cmathcal%7BV%7D"></span>, where variables <img src="https://latex.codecogs.com/png.latex?V_H"> are needed for identification of causal and counterfactual queries.</p>
<ul>
<li>When point-identification is not possible due to latent variables, such as unmeasured confounders, partial-identification (bounds) can still be informative <span class="citation" data-cites="chernozhukov2022long">(Chernozhukov et al. 2022)</span>.</li>
</ul></li>
</ul>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-BareinboimHierarchy2022" class="csl-entry">
Bareinboim, Elias, Juan D. Correa, Duligur Ibeling, and Thomas Icard. 2022. <span>“On Pearl’s Hierarchy and the Foundations of Causal Inference.”</span> In <em>Probabilistic and Causal Inference: The Works of Judea Pearl</em>, 1st ed., 507–56. New York, NY, USA: Association for Computing Machinery. <a href="https://doi.org/10.1145/3501714.3501743">https://doi.org/10.1145/3501714.3501743</a>.
</div>
<div id="ref-chernozhukov2022long" class="csl-entry">
Chernozhukov, Victor, Carlos Cinelli, Whitney Newey, Amit Sharma, and Vasilis Syrgkanis. 2022. <span>“Long Story Short: Omitted Variable Bias in Causal Machine Learning.”</span> National Bureau of Economic Research.
</div>
<div id="ref-uncertainty2021" class="csl-entry">
Hüllermeier, Eyke, and Willem Waegeman. 2021. <span>“Aleatoric and Epistemic Uncertainty in Machine Learning: An Introduction to Concepts and Methods.”</span> <em>Machine Learning</em> 110 (3): 457–506. <a href="https://doi.org/10.1007/s10994-021-05946-3">https://doi.org/10.1007/s10994-021-05946-3</a>.
</div>
<div id="ref-kitson2023survey" class="csl-entry">
Kitson, Neville Kenneth, Anthony C Constantinou, Zhigao Guo, Yang Liu, and Kiattikun Chobtham. 2023. <span>“A Survey of Bayesian Network Structure Learning.”</span> <em>Artificial Intelligence Review</em>, 1–94.
</div>
<div id="ref-PearlCausality" class="csl-entry">
Pearl, Judea. 2009. <em>Causality: Models, Reasoning, and Inference</em>. 2nd ed. Cambridge, UK: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511803161">https://doi.org/10.1017/CBO9780511803161</a>.
</div>
<div id="ref-stackingAki" class="csl-entry">
Yao, Yuling, Aki Vehtari, Daniel Simpson, and Andrew Gelman. 2018. <span>“<span class="nocase">Using Stacking to Average Bayesian Predictive Distributions (with Discussion)</span>.”</span> <em>Bayesian Analysis</em> 13 (3): 917–1007. <a href="https://doi.org/10.1214/17-BA1091">https://doi.org/10.1214/17-BA1091</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Some authors do not include <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> directly in <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D">, but say that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> is <em>associated</em> with <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BM%7D">. This might be useful in some uncertainty-related context, such as when there are hidden variables, as many <em>marginal</em> graphs can be associated with the same SCM.↩︎</p></li>
<li id="fn2"><p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bpa%7D(A;%5Cmathcal%7BG%7D)"> stands for the <em>parents</em> of node <img src="https://latex.codecogs.com/png.latex?A"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">.↩︎</p></li>
<li id="fn3"><p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bnd%7D(A;%5Cmathcal%7BG%7D)"> stands for the <em>non-descendants</em> of node <img src="https://latex.codecogs.com/png.latex?A"> in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>UQ</category>
  <category>causal inference</category>
  <category>graphical models</category>
  <category>structure learning</category>
  <guid>https://johandh2o.github.io/posts/2023-09-01_UQcausality/index.html</guid>
  <pubDate>Thu, 31 Aug 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-09-01_UQcausality/logo.png" medium="image" type="image/png" height="132" width="144"/>
</item>
<item>
  <title>Simulation task: recovering causal effects from post-treatment selection induced by missing outcome data</title>
  <link>https://johandh2o.github.io/posts/2023-08-15_missingSimulation/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>The final goal is to estimate <span style="color:blue;">the effects of ADHD treatment on school performance</span>, where:</p>
<ul>
<li><strong>the estimands</strong>: average treatment effect (ATE) and conditional average treatment effect (CATE)</li>
<li><strong>the exposure</strong>: stimulant medication for ADHD</li>
<li><strong>the outcome</strong>: raw score at the mathematics national test at grade 8</li>
<li><strong>the target population</strong>: ADHD-diagnosed Norwegian schoolchildren between grades 6 and 8</li>
</ul>
<p>For this task, we employ:</p>
<ul>
<li>The structural causal models (SCM) framework <span class="citation" data-cites="PearlCausality">(Pearl 2009)</span></li>
<li>A synthetic <strong>observational</strong> dataset, generated by an SCM learnt from real-world data (functional mechanisms are treated as unknown in the analysis)</li>
<li>A back-door admissible set of pre-treatment variables; i.e., the assumption of no latent confounding</li>
<li>A missing-outcome mechanism that allows recoverability via IPW and regression adjustment (functional specification is unknown in the analysis)</li>
<li>The targeted minimum-loss estimation (TMLE) framework <span class="citation" data-cites="TMLEbook1">(van der Laan and Rose 2011)</span></li>
</ul>
</section>
<section id="synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-data">Synthetic data</h2>
<p>Let <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'"> be a directed acyclic graph (DAG) built from domain knowledge and temporal-order constraints, involving the exposure <img src="https://latex.codecogs.com/png.latex?A">, the outcome <img src="https://latex.codecogs.com/png.latex?Y">, a set of confounders <img src="https://latex.codecogs.com/png.latex?H">, and mediators <img src="https://latex.codecogs.com/png.latex?M">. We previously fit flexible models (random forests) to learn the causal mechanisms <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bf%7D_V:%5Ctext%7Bsupp%7D%5C,%20%5Ctext%7Bpa%7D(V;%5Cmathcal%7BG%7D')%5Ctimes%20%5Ctext%7Bsupp%7D%5C,%20U_V%5Crightarrow%5Ctext%7Bsupp%7D%5C,%20V"> from real-world data on the subject. This allows us to replicate such mechanisms to generate fake data from seeds (noises and exogenous variables) in a controlled environment, along with counterfactual outcomes. In this exercise, exogenous variables mimic the marginal distribution of their real-world counterpart, <span style="color:blue;">but not the joint distribution</span>.</p>
<blockquote class="blockquote">
<p>By design, conditional ignorability is satisfied in the synthetic system using the full confounder set. It might not be satisfied in the system where the real-world data come from.</p>
</blockquote>
<p>Generated variables can be grouped in three categories:</p>
<p><strong>1. Pre-treatment / exogenous variables and the exposure</strong>:</p>
<ul>
<li><code>mom.vuln</code> = <img src="https://latex.codecogs.com/png.latex?H_1%5Cin%5Cmathbb%7BR%7D"> = maternal <em>vulnerability</em> index: a PCA-based index summarizing mother’s diagnoses (+), level of education (-), age (-), and number of children (-)</li>
<li><code>sex.girl</code> = <img src="https://latex.codecogs.com/png.latex?H_2%5Cin%5C%7B0,1%5C%7D"> = child’s sex at birth, female = 1</li>
<li><code>med.pre6</code> = <img src="https://latex.codecogs.com/png.latex?H_3%5Cin%5C%7B0,1%5C%7D"> = prescription for ADHD medication before grade 6</li>
<li><code>pre.diag</code> = <img src="https://latex.codecogs.com/png.latex?H_4%5Cin%5C%7B0,1%5C%7D"> = diagnoses for comorbid disorders (ADHD-related, internalizing or externalizing) registered before grade 6</li>
<li><code>ntr.grd5</code> = <img src="https://latex.codecogs.com/png.latex?H_5%5Cin%5Cmathbb%7BR%7D"> = raw score obtained at the national test for grade 5 (average math and reading)</li>
<li><code>reg.gpsp</code> = <img src="https://latex.codecogs.com/png.latex?H_6%5Cin%5Cmathbb%7BN%7D"> = number of registrations for health services (GP and specialist) before grade 6</li>
<li><code>med.6to8</code> = <img src="https://latex.codecogs.com/png.latex?A"> = prescription for ADHD medication between grades 6-8</li>
</ul>
<p><strong>2. Mediator variables and the outcome</strong>:</p>
<ul>
<li><code>ptr.diag</code> = <img src="https://latex.codecogs.com/png.latex?M_1%5Cin%5C%7B0,1%5C%7D"> = diagnoses for comorbid disorders (ADHD-related, internalizing or externalizing) registered between grades 6-8</li>
<li><code>ptr.gpsp</code> = <img src="https://latex.codecogs.com/png.latex?M_2%5Cin%5Cmathbb%7BN%7D"> = number of registrations for health services (GP and specialist) between grades 6-8</li>
<li><code>ntr.grd8</code> = <img src="https://latex.codecogs.com/png.latex?Y"> = raw score obtained at the national test for grade 8 (math)</li>
</ul>
<p><strong>3. Counterfactual variables</strong>:</p>
<ul>
<li><code>ptr.diag.cntr</code> = <img src="https://latex.codecogs.com/png.latex?M_1%5E%7B1-A%7D"> = diagnoses for comorbid disorders (ADHD-related, internalizing or externalizing) registered between grades 6-8, <em>had the individual taken the opposite treatment</em></li>
<li><code>ptr.gpsp.cntr</code> = <img src="https://latex.codecogs.com/png.latex?M_2%5E%7B1-A%7D"> = number of registrations for health services (GP and specialist) between grades 6-8, <em>had the individual taken the opposite treatment</em></li>
<li><code>ntr.grd8.cntr</code> = <img src="https://latex.codecogs.com/png.latex?Y%5E%7B1-A%7D"> = raw score obtained at the national test for grade 5 (math)</li>
<li><code>ITE</code> = <img src="https://latex.codecogs.com/png.latex?Y%5E%7B1%7D-Y%5E%7B0%7D"> = individual treatment effect</li>
</ul>
<p>A dataset (<code>synth.data</code>) of <img src="https://latex.codecogs.com/png.latex?N=5%5C,000"> samples was generated:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load packages --------------------------------------------------------------</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Processes dataframes</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Processes dataframes</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(kableExtra)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Styles tables</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(speedglm)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs fast fitting for GLM</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ranger)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs random forest learning</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(nnls)         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs non-negative least squares</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Rsolnp)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Augmented Lagrange optimizer</span></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sl3)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs super-learning</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tmle3)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs TMLE</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tmle3mediate) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performs TMLE for mediation analysis</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plots</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read data -------------------------------------------------------------------</span></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"syntheticADHDdata.RData"</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Glimpse of the data ---------------------------------------------------------</span></span>
<span id="cb1-18">synth.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(synth.data)</span>
<span id="cb1-19">synth.data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table 1: A glimpse at the synthetic data"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table 1: A glimpse at the synthetic data</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">mom.vuln</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sex.girl</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">med.pre6</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre.diag</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ntr.grd5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">reg.gpsp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">med.6to8</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ptr.diag</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ptr.gpsp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ntr.grd8</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ptr.diag.cntr</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ptr.gpsp.cntr</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ntr.grd8.cntr</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ITE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">19.64</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">16.77</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">19.29</td>
<td style="text-align: right;">2.52</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.31</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">25.85</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">26.72</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">21.64</td>
<td style="text-align: right;">5.08</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.59</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">21.38</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">23.27</td>
<td style="text-align: right;">1.89</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">15.12</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">17.62</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">14.48</td>
<td style="text-align: right;">3.14</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9.30</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">15.02</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">15.16</td>
<td style="text-align: right;">0.14</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.02</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.83</td>
<td style="text-align: right;">128</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">19.62</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">20.18</td>
<td style="text-align: right;">0.56</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="no-missingness-case" class="level2">
<h2 class="anchored" data-anchor-id="no-missingness-case">No missingness case</h2>
<p>A known SCM allows the computation of unit-level counterfactuals: we can see both worlds at the same time. In particular, we can compute the oracle <em>sample average treatment effect</em> (<img src="https://latex.codecogs.com/png.latex?%5ES">ATE): the within-sample average of the <em>individual treatment effects</em> (unobserved in real-world data). <img src="https://latex.codecogs.com/png.latex?%0A%5ES%5Ctext%7BATE%7D%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%20%5Ctext%7BITE%7D%5E%7B(i)%7D%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%20(Y%5E%7B(i)%7D_%7BA=1%7D-Y%5E%7B(i)%7D_%7BA=0%7D)%0A"> The <img src="https://latex.codecogs.com/png.latex?%5ES">ATE is itself a consistent (but impossible) estimator of the <em>population</em> ATE (<img src="https://latex.codecogs.com/png.latex?%5EP">ATE).</p>
<p>Likewise, we can compute the oracle <img src="https://latex.codecogs.com/png.latex?%5ES">CATE for <img src="https://latex.codecogs.com/png.latex?X">-specific effects. If <img src="https://latex.codecogs.com/png.latex?X"> is categorical, we can partition units into strata: <img src="https://latex.codecogs.com/png.latex?I(x):=%5C%7Bi%5Cin%201%5Cdots%20N%20:%20X%5E%7B(i)%7D=x%5C%7D">. <img src="https://latex.codecogs.com/png.latex?%0A%5ES%5Ctext%7BCATE%7D(x)%20=%20%7CI(x)%7C%5E%7B-1%7D%5Csum_%7Bi%5Cin%20I(x)%7D%20%5Ctext%7BITE%7D%5E%7B(i)%7D%20=%20%7CI(x)%7C%5E%7B-1%7D%5Csum_%7Bi%5Cin%20I(x)%7D%20(Y%5E%7B(i)%7D_%7BA=1%7D-Y%5E%7B(i)%7D_%7BA=0%7D)%0A"></p>
<p>Let us compare the oracle effects against the results from two approaches:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?t">-tests comparing the means of raw test scores between treated and non-treated. This estimator would be biased due to confounding</p></li>
<li><p>The TMLE estimator using <strong>super-learners</strong> <span class="citation" data-cites="superlearners2023">(Phillips et al. 2023)</span>, combining:</p>
<ul>
<li><p>flexible libraries of <strong>base-learners</strong> to model <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> given confounders <img src="https://latex.codecogs.com/png.latex?H">. We employ linear models and random forests (ground-truth DGP is in this model-space)</p></li>
<li><p><strong>meta-learners</strong>: to ensemble the base-learners together, weighted by their <strong>out-of-sample</strong> (CV) predictive measures to avoid over-fitting (logit for <img src="https://latex.codecogs.com/png.latex?A"> and NNLS for <img src="https://latex.codecogs.com/png.latex?Y">)</p></li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solution via t-tests (biased by confounding)</span></span>
<span id="cb2-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to generate C.I. data from t-tests ---------------------------------</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: pre-treatment binary variable to stratify</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return: data ready to plot as confidence intervals</span></span>
<span id="cb2-8"></span>
<span id="cb2-9">get.ci.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(varname){</span>
<span id="cb2-10">  </span>
<span id="cb2-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Temporal data.frame</span></span>
<span id="cb2-12">  dplot1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> synth.data</span>
<span id="cb2-13">  dplot1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dummy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dplot1[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(varname)]</span>
<span id="cb2-14">    </span>
<span id="cb2-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Two-sample t-test: biased! -------------------</span></span>
<span id="cb2-16">  </span>
<span id="cb2-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all, med vs no-med</span></span>
<span id="cb2-18">  ttest.pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ntr.grd8], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># treated</span></span>
<span id="cb2-19">                     dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ntr.grd8]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control</span></span>
<span id="cb2-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop 0, med vs no-med</span></span>
<span id="cb2-21">  ttest.sp0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ntr.grd8], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># treated (sp 0)</span></span>
<span id="cb2-22">                     dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ntr.grd8]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control (sp 0)</span></span>
<span id="cb2-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop 1, med vs no-med</span></span>
<span id="cb2-24">  ttest.sp1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ntr.grd8], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># treated (sp 1)</span></span>
<span id="cb2-25">                     dplot1[med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ntr.grd8]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control (sp 1)</span></span>
<span id="cb2-26"></span>
<span id="cb2-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One-sample t-test: oracle! -------------------</span></span>
<span id="cb2-28">  </span>
<span id="cb2-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># oracle ITE, all</span></span>
<span id="cb2-30">  otest.pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[, ITE])            </span>
<span id="cb2-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># oracle ITE, subpop 0</span></span>
<span id="cb2-32">  otest.sp0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ITE])    </span>
<span id="cb2-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># oracle ITE, subpop 1</span></span>
<span id="cb2-34">  otest.sp1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(dplot1[dummy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ITE])    </span>
<span id="cb2-35">  </span>
<span id="cb2-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data frame put together ----------------------</span></span>
<span id="cb2-37">  </span>
<span id="cb2-38">  dplot1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>( </span>
<span id="cb2-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># label for type of analysis</span></span>
<span id="cb2-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'t-test'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'oracle'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb2-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># label for supopulation</span></span>
<span id="cb2-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),        </span>
<span id="cb2-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># lower bound</span></span>
<span id="cb2-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ttest.pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ttest.sp0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ttest.sp1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],  </span>
<span id="cb2-45">            otest.pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], otest.sp0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], otest.sp1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb2-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># upper bound</span></span>
<span id="cb2-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upr =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ttest.pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ttest.sp0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ttest.sp1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],  </span>
<span id="cb2-48">            otest.pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], otest.sp0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], otest.sp1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf.int[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span>
<span id="cb2-49">  </span>
<span id="cb2-50">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add midpoint and return dataframe</span></span>
<span id="cb2-51">  dplot1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dplot1[, midp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> (low<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>upr)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] </span>
<span id="cb2-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(dplot1)                          </span>
<span id="cb2-53">}</span>
<span id="cb2-54"></span>
<span id="cb2-55"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solution via adjusted regression / TMLE</span></span>
<span id="cb2-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-58"></span>
<span id="cb2-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning algorithms employed to learn treatment/outcome mechanisms -----------</span></span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear model</span></span>
<span id="cb2-62">lrnr_lm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_glm_fast)</span>
<span id="cb2-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random forest model</span></span>
<span id="cb2-64">lrnr_rf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_ranger)      </span>
<span id="cb2-65"></span>
<span id="cb2-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Meta-learners: to stack together predictions from the learners ---------------</span></span>
<span id="cb2-67"></span>
<span id="cb2-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine Y predictions with non-negative least squares</span></span>
<span id="cb2-69">meta_Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_nnls)   </span>
<span id="cb2-70"></span>
<span id="cb2-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine A predictions with logit likelihood (augmented Lagrange optimizer)</span></span>
<span id="cb2-72">meta_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_learner</span>(Lrnr_solnp,                     </span>
<span id="cb2-73">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_function =</span> loss_loglik_binomial,              </span>
<span id="cb2-74">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_function =</span> metalearner_logistic_binomial)   </span>
<span id="cb2-75"></span>
<span id="cb2-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners: learners + meta-learners together ----------------------------</span></span>
<span id="cb2-77"></span>
<span id="cb2-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outcome super-learning</span></span>
<span id="cb2-79">super_Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(lrnr_lm, lrnr_rf), </span>
<span id="cb2-80">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metalearner =</span> meta_Y)</span>
<span id="cb2-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exposure super-learning</span></span>
<span id="cb2-82">super_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(lrnr_lm, lrnr_rf), </span>
<span id="cb2-83">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metalearner =</span> meta_A)</span>
<span id="cb2-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners put together</span></span>
<span id="cb2-85">super_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> super_A,</span>
<span id="cb2-86">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> super_Y)              </span>
<span id="cb2-87"></span>
<span id="cb2-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Confounder set labels</span></span>
<span id="cb2-89">H <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(synth.data[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>])</span>
<span id="cb2-90"></span>
<span id="cb2-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to generate C.I. data from TMLE--------------------------------------</span></span>
<span id="cb2-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: pre-treatment binary variable to stratify</span></span>
<span id="cb2-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: data</span></span>
<span id="cb2-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return: data from confidence intervals</span></span>
<span id="cb2-95"></span>
<span id="cb2-96">aux_tml_method <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(namevar, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>synth.data){</span>
<span id="cb2-97">  tmle_CATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle3</span>(</span>
<span id="cb2-98">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmle_spec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_stratified</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tmle_ATE</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Causal contrast CATE: Y1-Y0</span></span>
<span id="cb2-99">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(                           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variables involved in the query</span></span>
<span id="cb2-100">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(H,namevar),                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label for non-stratum confounders</span></span>
<span id="cb2-101">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V =</span> namevar,                              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label for stratifying variable</span></span>
<span id="cb2-102">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"med.6to8"</span>,                           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label for exposure</span></span>
<span id="cb2-103">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ntr.grd8"</span>),                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label for outcome</span></span>
<span id="cb2-104">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data,                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data</span></span>
<span id="cb2-105">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learner_list =</span> super_list)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learners specified</span></span>
<span id="cb2-106">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(tmle_CATE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>summary)                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return summary</span></span>
<span id="cb2-107">}</span>
<span id="cb2-108"></span>
<span id="cb2-109"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-110"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate confidence intervals to plot</span></span>
<span id="cb2-111"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb2-112"></span>
<span id="cb2-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># t-test on prior treatment</span></span>
<span id="cb2-114">ttest.med <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.ci.data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb2-115">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prior treatment'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb2-116"></span>
<span id="cb2-117"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># t-test on sex strata</span></span>
<span id="cb2-118">ttest.sex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.ci.data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb2-119">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex at birth'</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb2-120"></span>
<span id="cb2-121"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on prior treatment</span></span>
<span id="cb2-122">tml.cate.med <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>)                                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb2-123">tlme.med <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE'</span>,                                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb2-124">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb2-125">                            tml.cate.med[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.med<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb2-126">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prior treatment'</span>)                           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb2-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on sex strata</span></span>
<span id="cb2-128">tml.cate.sex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>)                                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb2-129">tlme.sex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE'</span>,                                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb2-130">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb2-131">                            tml.cate.sex[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.sex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb2-132">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex at birth'</span>)                              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb2-133"></span>
<span id="cb2-134"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unify column names</span></span>
<span id="cb2-135"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.med) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.med)</span>
<span id="cb2-136"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.sex) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.sex)</span>
<span id="cb2-137"></span>
<span id="cb2-138"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put all together</span></span>
<span id="cb2-139">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind.data.frame</span>(ttest.med, ttest.sex, tlme.med, tlme.sex)</span></code></pre></div>
</details>
</div>
<p>The following plot presents the point-estimate and 95% confidence interval for the ATE/CATE resulting from oracle <img src="https://latex.codecogs.com/png.latex?%5ES">ATE/<img src="https://latex.codecogs.com/png.latex?%5ES">CATE, <img src="https://latex.codecogs.com/png.latex?t">-tests, and TMLE.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot confidence intervals ---------------------------------------------------</span></span>
<span id="cb3-2">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> subpop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> midp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>                    </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> upr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> low), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ATE/CATE estimate'</span>,</span>
<span id="cb3-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Subpopulation (1 = yes prior treatment, 1 = girls)'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>strata) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-15_missingSimulation/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>From the previous plot we can infer:</p>
<p><strong>1. There is some amount of confounding</strong></p>
<ul>
<li><p>Confidence intervals from <img src="https://latex.codecogs.com/png.latex?t">-tests (<span style="color:green;">green</span>) do not always cover the sample-based oracle value (<span style="color:red;">red</span>). This is probably due to confounding bias, as <img src="https://latex.codecogs.com/png.latex?t">-test do not adjust for covariation with <img src="https://latex.codecogs.com/png.latex?H"></p></li>
<li><p>In general, confounding bias is negative: unadjusted effects are below the oracle result</p></li>
<li><p>Confounding bias seems to be particularly problematic when stratifying on prior prescription for ADHD medication, which might be a strong predictor of the exposure</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?t">-test results might lead to conclude that the treatment is actually <strong>deleterious</strong> for those who had not started it before grade 6 (because of late diagnosis?). In fact, the treatment has positive, but extremely small, average effect in such subpopulation</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?t">-test results might also lead to conclude that the treatment effect is <strong>insignificant</strong> for boys. In fact, the effect on them is small but positive</p></li>
</ul>
<p><strong>2. TMLE with covariate adjustment</strong></p>
<ul>
<li><p>Under some mild condition including back-door admissibility of <img src="https://latex.codecogs.com/png.latex?H">, TMLE produces consistent estimators. This is, the amount of confounding bias becomes negligible in large finite samples. We can see that confidence intervals from TMLE (<span style="color:blue;">blue</span>) cover the sample-based oracle value (<span style="color:red;">red</span>) in all cases</p></li>
<li><p>TMLE results lead to correct interpretation of treatment effect for boys and the subpopulation who did not start treatment before grade 6</p></li>
</ul>
<p><span style="color:blue;">3. In general, the effects of ADHD treatment on school performance are <strong>positive but small</strong></span></p>
<ul>
<li><span style="color:blue;">The estimate ATE is 1.7, on an outcome with mean 21.0 and standard deviation 7.0</span></li>
</ul>
</section>
<section id="outcome-missingness-mechanisms" class="level2">
<h2 class="anchored" data-anchor-id="outcome-missingness-mechanisms">Outcome-missingness mechanisms</h2>
<p>Let us simulate the <img src="https://latex.codecogs.com/png.latex?Y">-missingness mechanism as a binary random variable <img src="https://latex.codecogs.com/png.latex?R_Y">, childless in the associated <img src="https://latex.codecogs.com/png.latex?m">-graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">. For a particular individual <img src="https://latex.codecogs.com/png.latex?i">, <img src="https://latex.codecogs.com/png.latex?R_Y%5E%7B(i)%7D=1"> indicates that its respective outcome realization <img src="https://latex.codecogs.com/png.latex?Y%5E%7B(i)%7D"> is observed, while <img src="https://latex.codecogs.com/png.latex?R_Y%5E%7B(i)%7D=0"> signifies <img src="https://latex.codecogs.com/png.latex?Y%5E%7B(i)%7D"> is missing. This mechanism has a probit specification:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR_Y%20=%20%5Cmathbb%7BI%7D%5B%5Ctheta_0%20+%20%5Ctheta_H%5E%5Ctop%20H%20+%20%5Ctheta_A%20A%20+%20%5Ctheta_M%5E%5Ctop%20M%20+%20U_R%20%3E%200%5D,%5Cquad%20U_R%5Csim%20N(0,1)%0A"></p>
<p>Fixing the parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> to certain value (unknown in the analysis), a realization of <img src="https://latex.codecogs.com/png.latex?U_R"> produces 751 (15%) missing outcomes:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Building an endogenous selection/missingness mechanism</span></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter for the glm-probit specification, only main effects</span></span>
<span id="cb4-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb4-7">noise.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-8">theta.i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.77</span> </span>
<span id="cb4-9">theta.c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.97</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.18</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.64</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb4-10">lin.pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(synth.data[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> theta.c <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> theta.i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.R</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Realization of missingness mechanism</span></span>
<span id="cb4-13">synth.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RY <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(lin.pred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count how many selected / observed -------------------------------------------</span></span>
<span id="cb4-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(synth.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RY) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col.names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R(Y)"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>),</span>
<span id="cb4-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Table 2: Missing/selected unit-outcomes"</span>,</span>
<span id="cb4-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">table.attr =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quarto-disable-processing=true"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">

<table quarto-disable-processing="true" class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table 2: Missing/selected unit-outcomes</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> R(Y) </th>
   <th style="text-align:right;"> n </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 751 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:right;"> 4249 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Under the TMLE framework, let us first consider four options to recover the ATE/CATE:</p>
<ol type="1">
<li><p><strong><span style="color:brown;">TMLE-cc</span></strong>: TMLE with complete cases. We discard entire units with <img src="https://latex.codecogs.com/png.latex?R_Y=0"></p>
<ul>
<li>This approach would produce a consistent estimator under MCAR. However, as <img src="https://latex.codecogs.com/png.latex?R_Y"> is MAR in our case, results would be biased</li>
</ul></li>
</ol>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Complete-case analysis for TMLE</span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on prior treatment</span></span>
<span id="cb5-6">tml.cate.med.cc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>,                                            </span>
<span id="cb5-7">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>synth.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])                               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb5-8">tlme.med.cc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-cc'</span>,                                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb5-9">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb5-10">                               tml.cate.med.cc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.med.cc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb5-11">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prior treatment'</span>)                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on sex strata</span></span>
<span id="cb5-13">tml.cate.sex.cc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>,</span>
<span id="cb5-14">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>synth.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])                               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb5-15">tlme.sex.cc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-cc'</span>,                                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb5-16">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb5-17">                               tml.cate.sex.cc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.sex.cc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb5-18">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex at birth'</span>)                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span></code></pre></div>
</details>
</div>
<ol start="2" type="1">
<li><p><strong><span style="color:green;">TMLE-im</span></strong>: TMLE with single median-inputation. We replace <img src="https://latex.codecogs.com/png.latex?Y%5E*"> with the median of the observed <img src="https://latex.codecogs.com/png.latex?Y"></p>
<ul>
<li>This approach would also produce biased results, as all missing slots are inputed with the same numeric value independen of <img src="https://latex.codecogs.com/png.latex?H,A">. One preferable approach would be <strong>multiple model-based inputations</strong> (consistent under MAR). Yet, single median-inputation is <a href="https://tlverse.org/tmle3/reference/process_missing.html">the built-in preprocessing method in the <code>tmle</code> package</a></li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%5E*%20%5Cleftarrow%20%5Ctext%7Bmed%7D(Y%5Cmid%20R_Y=1)%0A"></p></li>
</ol>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Median-based single imputation for missing outcome</span></span>
<span id="cb6-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace Y-values for NA whenever R(Y)=0</span></span>
<span id="cb6-6">observed.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(synth.data)</span>
<span id="cb6-7">observed.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ntr.grd8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(observed.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, observed.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ntr.grd8)</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply process_missing function on TMLE package</span></span>
<span id="cb6-10">processed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">process_missing</span>(observed.data,                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data</span></span>
<span id="cb6-11">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">node_list =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> H,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confounders</span></span>
<span id="cb6-12">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"med.6to8"</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exposure</span></span>
<span id="cb6-13">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ntr.grd8"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outcome</span></span>
<span id="cb6-14">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">complete_nodes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># complete variables</span></span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on prior treatment</span></span>
<span id="cb6-17">tml.cate.med.im <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>,</span>
<span id="cb6-18">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>processed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data)                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb6-19">tlme.med.im <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-im'</span>,                                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb6-20">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb6-21">                               tml.cate.med.im[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.med.im<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb6-22">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prior treatment'</span>)                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb6-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE on sex strata</span></span>
<span id="cb6-24">tml.cate.sex.im <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>,</span>
<span id="cb6-25">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>processed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data)                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TMLE results</span></span>
<span id="cb6-26">tlme.sex.im <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind.data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-im'</span>,                                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method label</span></span>
<span id="cb6-27">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subpop=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 0'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'subpop 1'</span>),                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subpop label</span></span>
<span id="cb6-28">                               tml.cate.sex.im[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(tml.cate.sex.im<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C.I. data</span></span>
<span id="cb6-29">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex at birth'</span>)                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Strata variable</span></span>
<span id="cb6-30"></span>
<span id="cb6-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unify column names</span></span>
<span id="cb6-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.med.cc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.med)</span>
<span id="cb6-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.sex.cc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.sex)</span>
<span id="cb6-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.med.im) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.med)</span>
<span id="cb6-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tlme.sex.im) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ttest.sex)</span>
<span id="cb6-36"></span>
<span id="cb6-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put all together</span></span>
<span id="cb6-38">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind.data.frame</span>(ttest.med[ttest.med<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'oracle'</span>,],</span>
<span id="cb6-39">                             ttest.sex[ttest.sex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'oracle'</span>,],</span>
<span id="cb6-40">                             tlme.med.cc, tlme.sex.cc,</span>
<span id="cb6-41">                             tlme.med.im, tlme.sex.im)</span></code></pre></div>
</details>
</div>
<ol start="3" type="1">
<li><p><strong><span style="color:blue;">TMLE-mm</span></strong>: TMLE with explicit model for <img src="https://latex.codecogs.com/png.latex?M"> (only considering <code>ptr.diag</code>)</p>
<ul>
<li>Let us assume we are sure that post-treatment diagnoses (<code>ptr.diag</code>) have a direct effect on attrition, but post-treatment visits (<code>ptr.gpsp</code>) do not. Since the variable <code>ptr.diag</code> is binary, we can pose an explicit model using a superlearner based on logistic regression. If such assumption is sound, this approach should remove most of the selection bias.</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5Ctext%7BOutcome%20model%20on%20selected%20%7D%20&amp;%20Q_1(H,A,M)%20=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,M,R_Y=1%5D%20&amp;%20%5C%5C%0A&amp;%5Ctext%7BM-model%20(%5Ctexttt%7Bptr.diag%7D)%7D%20%20&amp;%20m(H,A)%20=%20%5Cmathbb%7BP%7D%5BM=1%5Cmid%20H,A%5D%20&amp;%5C%5C%0A&amp;%5Ctext%7BM-averaged%20expected%20outcome%7D%20%20&amp;%20Q_2(H,a)%20=%20m(H,a)Q_1(H,a,1)%20+(1-m(H,a))Q_1(H,a,0)%20&amp;%5C%5C%0A&amp;%5Ctext%7BInitial%20ATE%7D%20&amp;%20%20%5Cpsi_0%20=%20%5Cmathbb%7BE%7D_H%5CDelta_a%20Q_2(H,a)&amp;%5C%5C%0A&amp;%5Ctext%7BPropensity%20score%20(nuisance)%7D%20%20&amp;%20e(H)%20=%20%5Cmathbb%7BP%7D%5BA=1%5Cmid%20H%5D%20&amp;%5C%5C%0A&amp;%5Ctext%7BSelection%20score%20(nuisance)%7D%20%20&amp;%20s(H,A,M)%20=%20%5Cmathbb%7BP%7D%5BR_Y=1%5Cmid%20H,A,M%5D%20&amp;%5C%5C%0A%5Cend%7Baligned%7D%0A"></p></li>
</ol>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recovering causal effect via regression and explicit M-model</span></span>
<span id="cb7-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The library of base learners: GAM and random forests</span></span>
<span id="cb7-6">stack <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Stack<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(Lrnr_gam<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(), Lrnr_ranger<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>())</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learner for continuous outcome: NNLS</span></span>
<span id="cb7-9">superl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> stack, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metalearner =</span> Lrnr_nnls<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>())</span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Super-learner for binary variables: default logit</span></span>
<span id="cb7-12">superb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Lrnr_sl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learners =</span> stack)</span>
<span id="cb7-13"></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to generate C.I. data from TMLE--------------------------------------</span></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: pre-treatment binary variable to stratify</span></span>
<span id="cb7-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: data</span></span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return: data from confidence intervals</span></span>
<span id="cb7-18"></span>
<span id="cb7-19">aux_tml_method_mmod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(namevar, input.data){</span>
<span id="cb7-20">  </span>
<span id="cb7-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove namevar from adjustment set</span></span>
<span id="cb7-22">  H <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(H, namevar)</span>
<span id="cb7-23">  </span>
<span id="cb7-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning the Q-function ---------------------------------------------------</span></span>
<span id="cb7-25">  </span>
<span id="cb7-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for Q, fit superlearner </span></span>
<span id="cb7-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on selected-outcome data, including M1 as predictors</span></span>
<span id="cb7-28">  train.Q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,],</span>
<span id="cb7-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb7-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-32">  )</span>
<span id="cb7-33">  Q_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q)</span>
<span id="cb7-34">  </span>
<span id="cb7-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for M, all data</span></span>
<span id="cb7-36">  train.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb7-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,</span>
<span id="cb7-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>)</span>
<span id="cb7-40">  )</span>
<span id="cb7-41">  M_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.M)</span>
<span id="cb7-42">  </span>
<span id="cb7-43">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case A=1 ------------------------------------------------------------------</span></span>
<span id="cb7-44">  </span>
<span id="cb7-45">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data to make counterfactual predictions </span></span>
<span id="cb7-46">  temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(input.data)</span>
<span id="cb7-47">  </span>
<span id="cb7-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for p(M=1 |A=1)</span></span>
<span id="cb7-49">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-50">  pred.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,</span>
<span id="cb7-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>)</span>
<span id="cb7-54">  )</span>
<span id="cb7-55">  pM <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> M_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.M)</span>
<span id="cb7-56">  </span>
<span id="cb7-57">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=1, M=1)</span></span>
<span id="cb7-58">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ptr.diag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-59">  pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb7-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-63">  )</span>
<span id="cb7-64">  </span>
<span id="cb7-65">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=1, M=0)</span></span>
<span id="cb7-66">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ptr.diag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-67">  pred.Q0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-68">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-69">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb7-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-71">  )</span>
<span id="cb7-72">  </span>
<span id="cb7-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save INTEGRAL dP(M |A=1) E(Y |A=1, M)</span></span>
<span id="cb7-74">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_1m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> pM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-75">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pM) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q0)</span>
<span id="cb7-76">  </span>
<span id="cb7-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Case A=0 ------------------------------------------------------------------</span></span>
<span id="cb7-78">  </span>
<span id="cb7-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for p(M=1 |A=0)</span></span>
<span id="cb7-80">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-81">  pred.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-82">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-83">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,</span>
<span id="cb7-84">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>)</span>
<span id="cb7-85">  )</span>
<span id="cb7-86">  pM <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> M_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.M)</span>
<span id="cb7-87">  </span>
<span id="cb7-88">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=0, M=1)</span></span>
<span id="cb7-89">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ptr.diag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-90">  pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-91">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-92">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb7-93">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-94">  )</span>
<span id="cb7-95">  </span>
<span id="cb7-96">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=0, M=0)</span></span>
<span id="cb7-97">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ptr.diag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-98">  pred.Q0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-99">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb7-100">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb7-101">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-102">  )</span>
<span id="cb7-103">  </span>
<span id="cb7-104">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save INTEGRAL dP(M |A=0) E(Y |A=0, M)</span></span>
<span id="cb7-105">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_0m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> pM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-106">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pM) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q0)</span>
<span id="cb7-107">  </span>
<span id="cb7-108">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save Qm as the M-average of Q1 and Q0</span></span>
<span id="cb7-109">  input.data[,Qm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q_1m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q_0m]</span>
<span id="cb7-110">  </span>
<span id="cb7-111">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: A  ----------------------------------------------------</span></span>
<span id="cb7-112">  </span>
<span id="cb7-113">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for A, fit superlearner </span></span>
<span id="cb7-114">  train.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb7-116">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,</span>
<span id="cb7-117">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> H</span>
<span id="cb7-118">  )</span>
<span id="cb7-119">  A_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb7-120">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb7-121">  </span>
<span id="cb7-122">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: R(Y)  -------------------------------------------------</span></span>
<span id="cb7-123">  </span>
<span id="cb7-124">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for R(Y), fit superlearner </span></span>
<span id="cb7-125">  train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb7-126">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb7-127">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RY'</span>,</span>
<span id="cb7-128">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb7-129">  )</span>
<span id="cb7-130">  R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-131">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.select <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb7-132">  </span>
<span id="cb7-133">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count parameters  ---------------------------------------------------------</span></span>
<span id="cb7-134">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(input.data)</span>
<span id="cb7-135">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(input.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-136">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb7-137">  </span>
<span id="cb7-138">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: R(Y)  ---------------------------------------------------</span></span>
<span id="cb7-139">  input.data[, H<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>p.score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.score)) ]</span>
<span id="cb7-140">  </span>
<span id="cb7-141">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Updating model  ---------------------------------------------------</span></span>
<span id="cb7-142">  updating <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(ntr.grd8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Qm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> H, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>input.data)</span>
<span id="cb7-143">  eps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(updating))</span>
<span id="cb7-144">  </span>
<span id="cb7-145">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-values</span></span>
<span id="cb7-146">  input.data[, Q_1f<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> Q_1m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p.score)]</span>
<span id="cb7-147">  input.data[, Q_0f<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> Q_0m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> eps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.score))]</span>
<span id="cb7-148">  input.data[, D<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> H<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(ntr.grd8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Qm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Q_1m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Q_0m]</span>
<span id="cb7-149">  </span>
<span id="cb7-150">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute ATE, standard errors and CI</span></span>
<span id="cb7-151">  ate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_1f <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_0f)</span>
<span id="cb7-152">  ate.se <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(n)</span>
<span id="cb7-153">  ate.lo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ate.se</span>
<span id="cb7-154">  ate.up <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ate.se</span>
<span id="cb7-155">  </span>
<span id="cb7-156">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return CI</span></span>
<span id="cb7-157">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate.lo, ate.up, ate))</span>
<span id="cb7-158">}</span>
<span id="cb7-159"></span>
<span id="cb7-160"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate CI data</span></span>
<span id="cb7-161">ate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_mmod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, observed.data)</span>
<span id="cb7-162">cate.nop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_mmod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>, observed.data[med.pre6<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb7-163">cate.yes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_mmod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>, observed.data[med.pre6<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-164">cate.boy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_mmod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>, observed.data[sex.girl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb7-165">cate.grl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_mmod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>, observed.data[sex.girl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb7-166"></span>
<span id="cb7-167"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put all together</span></span>
<span id="cb7-168">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ci.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,]</span>
<span id="cb7-169">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-mm'</span></span>
<span id="cb7-170">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb7-171">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>low <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb7-172">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span></code></pre></div>
</details>
</div>
<ol start="4" type="1">
<li><p><strong><span style="color:purple;">TMLE-nr</span></strong>: TMLE with nested regressions.</p>
<ul>
<li>Let us assume we are sure that post-treatment diagnoses (<code>ptr.diag</code>) have a direct effect on attrition, but post-treatment visits (<code>ptr.gpsp</code>) do not. Since the variable <code>ptr.diag</code> is binary, we can pose an explicit model using a superlearner based on logistic regression. If such assumption is sound, this approach should remove most of the selection bias.</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5Ctext%7BOutcome%20model%20on%20selected%20%7D%20&amp;%20Q_1(H,A,M)%20=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,M,R_Y=1%5D%20&amp;%20%5C%5C%0A&amp;%5Ctext%7BHigh-level%20regression%7D%20%20&amp;%20Q_2(H,a)%20=%20%5Cmathbb%7BE%7D%5B%5Chat%7BQ%7D_1%5Cmid%20H,A=a%5D%20&amp;%5C%5C%0A&amp;%5Ctext%7BInitial%20ATE%7D%20&amp;%20%20%5Cpsi_0%20=%20%5Cmathbb%7BE%7D_H%5CDelta_a%20Q_2(H,a)&amp;%5C%5C%0A&amp;%5Ctext%7BPropensity%20score%20(nuisance)%7D%20%20&amp;%20e(H)%20=%20%5Cmathbb%7BP%7D%5BA=1%5Cmid%20H%5D%20&amp;%5C%5C%0A&amp;%5Ctext%7BSelection%20score%20(nuisance)%7D%20%20&amp;%20s(H,A,M)%20=%20%5Cmathbb%7BP%7D%5BR_Y=1%5Cmid%20H,A,M%5D%20&amp;%5C%5C%0A%5Cend%7Baligned%7D%0A"></p></li>
</ol>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recovering causal effect via nested regressions</span></span>
<span id="cb8-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############################################################################</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to generate C.I. data from TMLE--------------------------------------</span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: pre-treatment binary variable to stratify</span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Param: data</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return: data from confidence intervals</span></span>
<span id="cb8-9"></span>
<span id="cb8-10">aux_tml_method_nest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(namevar, input.data){</span>
<span id="cb8-11">  </span>
<span id="cb8-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove namevar from adjustment set</span></span>
<span id="cb8-13">  H <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(H, namevar)</span>
<span id="cb8-14">  </span>
<span id="cb8-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning the Q-function ---------------------------------------------------</span></span>
<span id="cb8-16">  </span>
<span id="cb8-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for Q, fit superlearner </span></span>
<span id="cb8-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on selected-outcome data, including M1 as predictors</span></span>
<span id="cb8-19">  train.Q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,],</span>
<span id="cb8-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb8-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.gpsp'</span>)</span>
<span id="cb8-23">  )</span>
<span id="cb8-24">  </span>
<span id="cb8-25">  Q_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q)</span>
<span id="cb8-26">  </span>
<span id="cb8-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data to make counterfactual predictions </span></span>
<span id="cb8-28">  temp.dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(input.data)</span>
<span id="cb8-29">  </span>
<span id="cb8-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=1, M)</span></span>
<span id="cb8-31">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-32">  pred.Q1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb8-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb8-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.gpsp'</span>)</span>
<span id="cb8-36">  )</span>
<span id="cb8-37">  </span>
<span id="cb8-38">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1.pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q1)</span>
<span id="cb8-39">  </span>
<span id="cb8-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prediction task for E(Y |A=0, M)</span></span>
<span id="cb8-41">  temp.dt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-42">  pred.Q0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> temp.dt,</span>
<span id="cb8-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ntr.grd8'</span>,</span>
<span id="cb8-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.gpsp'</span>)</span>
<span id="cb8-46">  )</span>
<span id="cb8-47">  </span>
<span id="cb8-48">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q0.pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> pred.Q0)</span>
<span id="cb8-49">  </span>
<span id="cb8-50">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for Q21</span></span>
<span id="cb8-51">  train.Q21 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb8-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q1.pred'</span>,</span>
<span id="cb8-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> H <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No treatment in here, its fixed</span></span>
<span id="cb8-55">  )</span>
<span id="cb8-56">  Q21_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q21)</span>
<span id="cb8-57">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q1.fin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q21_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q21)</span>
<span id="cb8-58">  </span>
<span id="cb8-59">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for Q20</span></span>
<span id="cb8-60">  train.Q20 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb8-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Q0.pred'</span>,</span>
<span id="cb8-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> H <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No treatment in here, its fixed</span></span>
<span id="cb8-64">  )</span>
<span id="cb8-65">  Q20_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q20)</span>
<span id="cb8-66">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q0.fin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Q20_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.Q20)</span>
<span id="cb8-67">  </span>
<span id="cb8-68">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># m-Average</span></span>
<span id="cb8-69">  input.data[, Qa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q1.fin <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>Q0.fin]</span>
<span id="cb8-70">  </span>
<span id="cb8-71">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: A  ----------------------------------------------------</span></span>
<span id="cb8-72">  </span>
<span id="cb8-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for A, fit superlearner </span></span>
<span id="cb8-74">  train.A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-75">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb8-76">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,</span>
<span id="cb8-77">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> H</span>
<span id="cb8-78">  )</span>
<span id="cb8-79">  A_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb8-80">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.A)</span>
<span id="cb8-81">  </span>
<span id="cb8-82">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: R(Y)  -------------------------------------------------</span></span>
<span id="cb8-83">  </span>
<span id="cb8-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training task for R(Y), fit superlearner </span></span>
<span id="cb8-85">  train.R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sl3_Task</span>(</span>
<span id="cb8-86">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> input.data,</span>
<span id="cb8-87">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RY'</span>,</span>
<span id="cb8-88">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">covariates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(H,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.6to8'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ptr.diag'</span>)</span>
<span id="cb8-89">  )</span>
<span id="cb8-90">  R_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> superb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb8-91">  input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.select <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R_fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> train.R)</span>
<span id="cb8-92">  </span>
<span id="cb8-93">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count parameters  ---------------------------------------------------------</span></span>
<span id="cb8-94">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(input.data)</span>
<span id="cb8-95">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(input.data[RY<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb8-96">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb8-97">  </span>
<span id="cb8-98">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nuisance parameters: R(Y)  ---------------------------------------------------</span></span>
<span id="cb8-99">  input.data[, H<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>p.score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>med<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>to8)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.score)) ]</span>
<span id="cb8-100">  </span>
<span id="cb8-101">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Updating model  ---------------------------------------------------</span></span>
<span id="cb8-102">  updating <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(ntr.grd8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(Qa) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> H, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>input.data)</span>
<span id="cb8-103">  eps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(updating))</span>
<span id="cb8-104">  </span>
<span id="cb8-105">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Q-values</span></span>
<span id="cb8-106">  input.data[, Q_1f<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> Q1.fin <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p.score)]</span>
<span id="cb8-107">  input.data[, Q_0f<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> Q0.fin <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> eps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(p.select<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.score))]</span>
<span id="cb8-108">  input.data[, D<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> H<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(ntr.grd8 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Qa) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Q1.fin <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Q0.fin]</span>
<span id="cb8-109">  </span>
<span id="cb8-110">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute ATE, standard errors and CI</span></span>
<span id="cb8-111">  ate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_1f <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Q_0f)</span>
<span id="cb8-112">  ate.se <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(input.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(n)</span>
<span id="cb8-113">  ate.lo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ate.se</span>
<span id="cb8-114">  ate.up <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ate.se</span>
<span id="cb8-115">  </span>
<span id="cb8-116">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return CI</span></span>
<span id="cb8-117">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate.lo, ate.up, ate))</span>
<span id="cb8-118">}</span>
<span id="cb8-119"></span>
<span id="cb8-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate CI data</span></span>
<span id="cb8-121">ate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_nest</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, observed.data)</span>
<span id="cb8-122">cate.nop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_nest</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>, observed.data[med.pre6<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb8-123">cate.yes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_nest</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'med.pre6'</span>, observed.data[med.pre6<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb8-124">cate.boy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_nest</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>, observed.data[sex.girl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,])</span>
<span id="cb8-125">cate.grl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aux_tml_method_nest</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex.girl'</span>, observed.data[sex.girl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb8-126"></span>
<span id="cb8-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put all together</span></span>
<span id="cb8-128">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ci.data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,]</span>
<span id="cb8-129">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TMLE-nr'</span></span>
<span id="cb8-130">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb8-131">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>low <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb8-132">ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>upr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.nop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.yes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], ate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.boy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], cate.grl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb8-133"></span>
<span id="cb8-134"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All methods together</span></span>
<span id="cb8-135">ci.data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span>, ci.data<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.4</span>)</span></code></pre></div>
</details>
</div>
<p>The following plot presents the point-estimate and 95% confidence interval from the approaches presented above:</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot confidence intervals ---------------------------------------------------</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(ci.data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> subpop, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> midp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>                    </span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> upr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> low), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ATE/CATE estimate'</span>,</span>
<span id="cb9-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Subpopulation (1 = yes prior treatment, 1 = girls)'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>strata) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-15_missingSimulation/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p><strong>Regression adjustment works</strong></p>
<ul>
<li>Confidence intervals from complete-case analysis (<span style="color:brown;">brown</span>) and single median-inputations (<span style="color:green;">green</span>) fail to cover the oracle SATE (<span style="color:red;">red</span>) in most cases, particularly for the population ATE.</li>
<li>A regression-based solution via an explicit model for <code>ptr.diag</code> (<span style="color:blue;">blue</span>) does a better job, and only struggle with small subpopulations in the data (no prior treatment or girls, about 30%).</li>
<li>A nested-regressions approach (<span style="color:purple;">purple</span>) performs well for the ATE, but struggle a little with small subpopulations.</li>
</ul>
<p>All methods above via TMLE employ only one fluctuation parameter (on <img src="https://latex.codecogs.com/png.latex?Q_2">). Better performance can be obtained by working with a fluctuation parameter on <img src="https://latex.codecogs.com/png.latex?Q_1"> or <img src="https://latex.codecogs.com/png.latex?p(M%5Cmid%20H,A)"> as well, and by incorporating smart cross-fitting schemes.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-PearlCausality" class="csl-entry">
Pearl, Judea. 2009. <em>Causality: Models, Reasoning, and Inference</em>. 2nd ed. Cambridge, UK: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511803161">https://doi.org/10.1017/CBO9780511803161</a>.
</div>
<div id="ref-superlearners2023" class="csl-entry">
Phillips, Rachael V, Mark J van der Laan, Hana Lee, and Susan Gruber. 2023. <span>“<span class="nocase">Practical considerations for specifying a super learner</span>.”</span> <em>International Journal of Epidemiology</em> 52 (4): 1276–85. <a href="https://doi.org/10.1093/ije/dyad023">https://doi.org/10.1093/ije/dyad023</a>.
</div>
<div id="ref-TMLEbook1" class="csl-entry">
van der Laan, M. J., and S. Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.no/books?id=RGnSX5aCAgQC">https://books.google.no/books?id=RGnSX5aCAgQC</a>.
</div>
</div></section></div> ]]></description>
  <category>selection bias</category>
  <category>mediation</category>
  <category>regression</category>
  <category>IPW</category>
  <category>doubly-robust</category>
  <category>TMLE</category>
  <guid>https://johandh2o.github.io/posts/2023-08-15_missingSimulation/index.html</guid>
  <pubDate>Mon, 14 Aug 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-08-15_missingSimulation/logo.png" medium="image" type="image/png" height="132" width="144"/>
</item>
<item>
  <title>Recovering causal effects from post-treatment selection induced by missing outcome data</title>
  <link>https://johandh2o.github.io/posts/2023-08-01_missingOutcome/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>The final goal is to estimate the average treatment effect (ATE) and conditional average treatment effect (CATE) using <strong>observational data with missing values on the outcome variable</strong></p>
</section>
<section id="conceptual-diagrams" class="level2">
<h2 class="anchored" data-anchor-id="conceptual-diagrams">Conceptual diagrams</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  A["Observed-data
  distribution"] -- "recovery" --&gt; B["Underlying
  distribution"]
  B -- "identification" --&gt; C["Causal effect"]
  A -- "recovery" --&gt; C
</pre>
</div>
</div>
</div>
</div>
<p>Diagram 1: relation between identifiability and recoverability:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  D["Graphical
  criteria"] ==&gt; E["IPW"]
  D ==&gt; F["Regression"]
  D -.-&gt; M["Mediation
  analysis"]
  F --&gt; G["M-model"]
  F ==&gt; H["Nested"]
  E ==&gt; I["Doubly-
  robustness"]
  F ==&gt; I
  I -.-&gt; J["AIPW"]
  I ==&gt; K["TMLE"]
  I -.-&gt; L["DML"]
  M -.-&gt; N["Triply-
  robustness"]
</pre>
</div>
</div>
</div>
</div>
<p>Diagram 2: relation between recoverability criteria and some estimation procedures:</p>
</section>
<section id="setting" class="level2">
<h2 class="anchored" data-anchor-id="setting">Setting</h2>
<p>Consider the following <img src="https://latex.codecogs.com/png.latex?m">-graph<sup>1</sup>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, representing the causal relations among a set of random variables <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D=%5C%7BH,A,M,Y,R_Y%5C%7D">, where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?H%5Cin%5Cmathbb%7BR%7D%5Ed"> is a vector of pre-treatment and context covariates</li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Cin%5C%7B0,1%5C%7D"> is a binary exposure</li>
<li><img src="https://latex.codecogs.com/png.latex?Y"> is the outcome of interest, with general support (univariate or multivariate, discrete or continuous)</li>
<li><img src="https://latex.codecogs.com/png.latex?M"> is a mediator on the causal pathway from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">, with general support</li>
<li><img src="https://latex.codecogs.com/png.latex?R_Y%5Cin%5C%7B0,1%5C%7D"> is an indicator of sample selection for <img src="https://latex.codecogs.com/png.latex?Y">, i.e., for a given sample, <img src="https://latex.codecogs.com/png.latex?R_Y=1"> means <img src="https://latex.codecogs.com/png.latex?Y"> is observed; otherwise <img src="https://latex.codecogs.com/png.latex?Y"> is missing (denoted with proxy <img src="https://latex.codecogs.com/png.latex?Y%5E*=%5Cemptyset">).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/mdag1.png" class="img-fluid figure-img" width="250"></p>
<figcaption class="figure-caption">Figure 1: <img src="https://latex.codecogs.com/png.latex?m">-graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"></figcaption>
</figure>
</div>
<p>Our goal is to estimate the average treatment effect (ATE), <img src="https://latex.codecogs.com/png.latex?%5Cpsi">, <strong>in the target population</strong>, defined as:</p>
<p><span id="eq-1"><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%20:=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=1)%5D-%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=0)%5D%0A%5Ctag%7B1%7D"></span></p>
</section>
<section id="the-problem-of-identifiability" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-of-identifiability">The problem of identifiability</h2>
<p>When there is no sample selection nor missingness, or when missing is <em>completely at random</em> (MCAR), all arrows pointing to <img src="https://latex.codecogs.com/png.latex?R_Y"> are absent. The <img src="https://latex.codecogs.com/png.latex?m">-graph representing the system correspond to a causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5Cequiv%5Cmathcal%7BG%7D%5B%5Coverline%7BR_Y%7D%5D">, and samples are obtained from the observational distribution <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)">. This is the traditional setting motivating causal inference with observational data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/mdag2.png" class="img-fluid figure-img" width="250"></p>
<figcaption class="figure-caption">Figure 2: causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5Cequiv%5Cmathcal%7BG%7D%5B%5Coverline%7BR_Y%7D%5D"></figcaption>
</figure>
</div>
<p>Under the assumptions embedded in the causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'">, and a special mutilation known as the <em>back-door graph</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5BA%5C!-%5C!Y%5D"><sup>2</sup>, <img src="https://latex.codecogs.com/png.latex?%5Cpsi"> is <em>nonparametrically identifiable</em> from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)"> via the <em>back-door formula</em> <span class="citation" data-cites="Pearl1995 PearlDo">(Pearl 1995, 2012)</span>, as:</p>
<p><span id="eq-2"><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D_H%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A=a%5D%0A%5Ctag%7B2%7D"></span></p>
<p>Given identifiability plus <img src="https://latex.codecogs.com/png.latex?N"> i.i.d. samples from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)">, a consistent estimator can be constructed using a regression model for the outcome <img src="https://latex.codecogs.com/png.latex?%5Chat%7BQ%7D(H,A)=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20H,A%5D">, and then proceeding with <img src="https://latex.codecogs.com/png.latex?g">-computation <span class="citation" data-cites="robins1986gcomp">(Robins 1986)</span>:</p>
<p><span id="eq-3"><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Cpsi%7D%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5E%7BN%7D%5CDelta_a%5Chat%7BQ%7D(H_i,a)%0A%5Ctag%7B3%7D"></span></p>
</section>
<section id="the-problem-of-recoverability" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-of-recoverability">The problem of recoverability</h2>
<p>A (causal) parameter is said to be <strong>recoverable</strong> from the observed-data distribution <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y%5E*,R_Y)"> <sup>3</sup> if it can be uniquely computed from it using the assumptions embedded in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> (and the necessary graph mutilation).</p>
<p>Under identifiability in the substantive model <sup>4</sup>, there is an ample number of methods to recover joint/conditional distributions based on different statistical theories. Although not originally motivated by graphical models, they can be seen as <em>ad hoc</em> solutions under special graphical conditions <span class="citation" data-cites="mgraphs">(Mohan and Pearl 2021)</span>.</p>
<p>Table 1 presents a summary of literature review <sup>5</sup> benchmarking four methodological approaches in terms of:</p>
<ul>
<li><span style="color:blue;">Graphical conditions for recoveravility</span>: from hard (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to easy (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) to fulfill/believe</li>
<li><span style="color:blue;">Flexibility in model specification</span>: from parametric (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to ML/nonparametric (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">)</li>
<li><span style="color:blue;">Statistical efficiency</span>: from wider (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to narrower (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) confidence/credible intervals</li>
<li><span style="color:blue;">Computational efficiency</span>: from slow (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to fast (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) computation/convergence</li>
</ul>
<table class="table">
<caption>Table 1: some statistical methods to address selection/missingness</caption>
<colgroup>
<col style="width: 40%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Graph cond.</th>
<th>Flex. spec.</th>
<th>Stat. eff.</th>
<th>Comp. eff.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Expectation-maximization <span class="citation" data-cites="DEMP1977">(Dempster, Laird, and Rubin 1977)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
</tr>
<tr class="even">
<td>Multiple imputation <span class="citation" data-cites="Rubin1976 RubinMIpaper">(Rubin 1976, 1978)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
</tr>
<tr class="odd">
<td>Inverse probability weighting <span class="citation" data-cites="robins1992recovery Robins1994">(Robins and Rotnitzky 1992; Robins, Rotnitzky, and Zhao 1994)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
</tr>
<tr class="even">
<td>Regression adjustment <span class="citation" data-cites="Bareinboim_Tian_Pearl_2014 Correa_Tian_Bareinboim_2018">(Bareinboim, Tian, and Pearl 2014; J. Correa, Tian, and Bareinboim 2018)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
</tr>
</tbody>
</table>
<p>Arguably, the best set of properties come from IPW and regression adjustment, due to their direct derivation from graphical criteria, which might extend the Rubin-MAR setting. Moreover, both solutions have important theoretical results from the theory of semiparametric estimation, and produce <strong>doubly-robustness</strong> when combined. These reasons have motivated syncretic estimators, such as:</p>
<table class="table">
<caption>Table 2: some doubly-robust estimation methods</caption>
<colgroup>
<col style="width: 44%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Fast consistency</th>
<th>Plug-in for target</th>
<th>Bayesian version</th>
<th># iter. steps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Augmented inverse probability weighting (AIPW) <span class="citation" data-cites="Robins1994">(Robins, Rotnitzky, and Zhao 1994)</span></td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>0</td>
</tr>
<tr class="even">
<td>Targeted learning <span class="citation" data-cites="TMLEbook1">(van der Laan and Rose 2011)</span></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes, kinda</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cgeq%201"></td>
</tr>
<tr class="odd">
<td>Debiased machine learning (DML) <span class="citation" data-cites="DML">(Chernozhukov et al. 2018)</span></td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>0</td>
</tr>
</tbody>
</table>
<section id="recoverability-via-ipw" class="level3">
<h3 class="anchored" data-anchor-id="recoverability-via-ipw">Recoverability via IPW</h3>
<p>Graphical conditions for recoverability via IPW <span class="citation" data-cites="Mohan2014">(Mohan and Pearl 2014)</span>, with missing data on <img src="https://latex.codecogs.com/png.latex?Y">, are:</p>
<ol type="1">
<li>There is a back-door admissible set in the substantive model (<img src="https://latex.codecogs.com/png.latex?H">)</li>
<li>No self-selection: there are no directed arrows between <img src="https://latex.codecogs.com/png.latex?Y"> and <img src="https://latex.codecogs.com/png.latex?R_Y"></li>
<li>No open collider paths between <img src="https://latex.codecogs.com/png.latex?Y"> and <img src="https://latex.codecogs.com/png.latex?R_Y"> (open by variables involved in the query)</li>
<li>(When there are multiple missingness mechanisms: <img src="https://latex.codecogs.com/png.latex?R_V%5Ccap%20R_%7B%5Ctext%7Bmb%7D(R_V)%7D=%5Cemptyset">)</li>
</ol>
<p>Our <img src="https://latex.codecogs.com/png.latex?m">-graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> (figure 1) allows recoverability, so we can express :</p>
<p><span id="eq-4"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20p(Y%5Cmid%20do(A))%20&amp;=%20%5Cint%5Cfrac%7B%20%5Ctext%7Bd%7D%20H%7D%7Bp(A%5Cmid%20H)%7D%5Cint%20%5Cfrac%7B%5Ctext%7Bd%7D%20M%7D%7B%5Cmathbb%7BP%7D(R_Y=1%5Cmid%20H,M)%7D%5C,%20p(H,A,M,Y%5Cmid%20R_Y=1)%20%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cmathbb%7BE%7D_%7BH%5Cmid%20R_Y=1%7D%5Cleft%5B%5Cfrac%7Bp(A,Y%5Cmid%20H,M,R_Y=1)%7D%7Bp(A%5Cmid%20H)%5C,%20%5Cmathbb%7BP%7D(R_Y=1%5Cmid%20H,M)%20%7D%20%20%5Cright%5D%0A%5Cend%7Baligned%7D%0A%5Ctag%7B4%7D"></span></p>
<p>Thus, the IPW-estimator of the ATE is:</p>
<p><span id="eq-5"><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5Chat%7B%5Cpsi%7D%5E%7Bw%7D%20=%20N_1%5E%7B-1%7D%5Csum_%7Bi=1%7D%5E%7BN_1%7D%5Cfrac%7B(2A%5Ei-1)%5C,Y%5Ei%7D%7B%5Chat%7Bp%7D(A%5Ei%5Cmid%20H%5Ei)%5C,%5Chat%7B%5Cmathbb%7BP%7D%7D(R_Y=1%5Cmid%20H%5Ei,M%5Ei)%20%7D%0A%5Ctag%7B5%7D"></span></p>
<p>It requires two models:</p>
<ul>
<li>Treatment-assignment mechanism: <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bp%7D(A%5Ei%5Cmid%20H%5Ei)">. It <strong>does not</strong> involve the mediator <img src="https://latex.codecogs.com/png.latex?M"></li>
<li>Selection mechanism: <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cmathbb%7BP%7D%7D(R_Y=1%5Cmid%20H%5Ei,M%5Ei)">. It <strong>does</strong> involve the mediator <img src="https://latex.codecogs.com/png.latex?M"></li>
</ul>
</section>
<section id="recoverability-via-regression-adjustment" class="level3">
<h3 class="anchored" data-anchor-id="recoverability-via-regression-adjustment">Recoverability via regression adjustment</h3>
<p>Working with samples from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y%5E*,R_Y)"> implies conditioning on <img src="https://latex.codecogs.com/png.latex?R_Y=1"> <span class="citation" data-cites="Bareinboim12">(Bareinboim and Pearl 2012)</span>. In the <img src="https://latex.codecogs.com/png.latex?m">-graph of figure 1, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, such condition opens the following non-causal paths in the (proper) back-door graph:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20H%5Clongrightarrow%20Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20H%5Clongrightarrow%20M%5Clongrightarrow%20Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20M%5Clongrightarrow%20Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20M%5Clongleftarrow%20H%5Clongrightarrow%20Y"></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/mdag3.png" class="img-fluid figure-img" width="250"></p>
<figcaption class="figure-caption">Figure 3: The (proper) back-door graph</figcaption>
</figure>
</div>
<p>Graphical conditions for recoverability via GAC <span class="citation" data-cites="Correa_Tian_Bareinboim_2018">(J. Correa, Tian, and Bareinboim 2018)</span>, with missing data on <img src="https://latex.codecogs.com/png.latex?Y">, using an adjustment set <img src="https://latex.codecogs.com/png.latex?Z">:</p>
<ol type="1">
<li>All non-causal paths between <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> are blocked by <img src="https://latex.codecogs.com/png.latex?Z"> and <img src="https://latex.codecogs.com/png.latex?R_Y">: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20A%5Cmid%20Z,%20R_Y"> in the (proper) back-door graph</li>
<li><img src="https://latex.codecogs.com/png.latex?Z"> <img src="https://latex.codecogs.com/png.latex?d">-separates <img src="https://latex.codecogs.com/png.latex?Y"> from <img src="https://latex.codecogs.com/png.latex?R_Y">: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20R_Y%5Cmid%20Z"> in the (proper) back-door graph</li>
<li><span style="color:blue;">The adjustment set contains no forbidden nodes</span>: <img src="https://latex.codecogs.com/png.latex?Z%5Ccap%5Ctext%7Bfb%7D(A,Y;%5Cmathcal%7BG%7D)=%5Cemptyset"></li>
</ol>
<blockquote class="blockquote">
<p>No adjustment set fulfills all these critera. In particular, <img src="https://latex.codecogs.com/png.latex?Z=%5C%7BH,M%5C%7D"> fulfills only the first two.</p>
</blockquote>
<p>These criteria are incomplete, because they do not consider post-treatment selection influenced by mediators.</p>
<p><strong>Fix</strong>: <em>Our</em> recoverability criteria via regression adjustment with missing data on <img src="https://latex.codecogs.com/png.latex?Y"> using pre-treatment set <img src="https://latex.codecogs.com/png.latex?H"> and forbidden set <img src="https://latex.codecogs.com/png.latex?M%5Csubset%20%5Ctext%7Bfb%7D(A,Y;%5Cmathcal%7BG%7D)">:</p>
<ol type="1">
<li>All non-causal paths between <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?Y"> are blocked by <img src="https://latex.codecogs.com/png.latex?H">: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20A%5Cmid%20H"> in the (proper) back-door graph <span style="color:blue;">of the substantive model</span></li>
<li><img src="https://latex.codecogs.com/png.latex?H,M"> <img src="https://latex.codecogs.com/png.latex?d">-separate <img src="https://latex.codecogs.com/png.latex?Y"> from <img src="https://latex.codecogs.com/png.latex?R_Y">: <img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20R_Y%5Cmid%20H,M"> in the (proper) back-door graph</li>
<li><span style="color:blue;">The adjustment set contains no forbidden nodes</span>: <img src="https://latex.codecogs.com/png.latex?H%5Ccap%5Ctext%7Bfb%7D(A,Y;%5Cmathcal%7BG%7D)=%5Cemptyset"></li>
</ol>
<blockquote class="blockquote">
<p>This modification is not a revolutionary discovery. It is implied from the sequential factorization by <span class="citation" data-cites="Mohan2014">Mohan and Pearl (2014)</span>, and from <img src="https://latex.codecogs.com/png.latex?c">-factorization by <span class="citation" data-cites="Correa_Tian_Bareinboim_2019">J. D. Correa, Tian, and Bareinboim (2019)</span>. Yet, the former does not address the causal query directly, and the latter might be a fairly complicated overshoot. A nice list of graphical criteria, as in the case without forbidden nodes, might be more useful for researchers. Besides, IPW tends to be the first option in applied research, maybe it is thought that in some contexts regression adjustment is not possible.</p>
</blockquote>
<p>Under the modified criteria, we have that:</p>
<p><span id="eq-6"><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D_H%5Cmathbb%7BE%7D_%7BM%5Cmid%20H,A=a%7D%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A=a,%20M,%20R_Y=1%5D%0A%5Ctag%7B6%7D"></span></p>
<p>This estimand can be expressed in two different ways, each using two models.</p>
<p><span style="color:blue;"><strong>Solution 1: full mediator density-model</strong>:</span></p>
<p><span id="eq-7"><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D_H%5Cleft%5B%5Cint%20%5Cunderbrace%7B%5Ctext%7Bd%7DP(M%5Cmid%20H,A=a)%7D_%7B%5Cmathcal%7BM%7D_2%7D%5C,%20%5Cunderbrace%7BQ(H,a,M)%7D_%7B%5Cmathcal%7BM%7D_1%7D%20%5Cright%5D%0A%5Ctag%7B7%7D"></span></p>
<p>One model for the <strong>expected-outcome model</strong> (with <img src="https://latex.codecogs.com/png.latex?M"> as predictor): <img src="https://latex.codecogs.com/png.latex?Q(H,A,M)=%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,%20M,%20R_Y=1%5D">. The other model involved is a <strong>full mediator density-model</strong>: <img src="https://latex.codecogs.com/png.latex?p(M%5Cmid%20H,A)"></p>
<p><span style="color:blue;"><strong>Solution 2: nested/hierarchical regressions</strong>:</span></p>
<p><span id="eq-8"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A&amp;%5Cmathcal%7BM%7D_1:%20&amp;%20Q_1(H,A,M)%20&amp;=%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,%20M,%20R_Y=1%5D%20%5C%5C%0A&amp;%5Cmathcal%7BM%7D_2:%20&amp;%20Q_2(H,A)%20&amp;=%5Cmathbb%7BE%7D_%7BM%5Cmid%20H,A%7D%5C,%20Q_1(H,A,M)%20%5C%5C%0A&amp;%20&amp;%20%5Cpsi%20&amp;=%20%5CDelta_a%5Cmathbb%7BE%7D_H%5C,%20Q_2(H,a)%0A%5Cend%7Baligned%7D%0A%5Ctag%7B8%7D"></span></p>
<p>The second model is not in the mediator support, but in the outcome support. <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D_2"> <em>averages the predictions of</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BM%7D_1">, as a function of only <img src="https://latex.codecogs.com/png.latex?H,A">.</p>
<p>This solution has a clear advantage: it does not require modeling the conditional density of <img src="https://latex.codecogs.com/png.latex?M">, which is a hard job when such a variable is high-dimensional or combines discrete and continuous components. A little of math is required in the TMLE front.</p>
</section>
<section id="recoverability-via-mediation-analysis" class="level3">
<h3 class="anchored" data-anchor-id="recoverability-via-mediation-analysis">Recoverability via mediation analysis</h3>
<p>An alternative approach, closely related to regression adjustment, is mediation analysis. This is a viable approach in some circumstances, as the <em>natural indirect effect</em> (NIE) and the <em>total direct effect</em> (TDE) might be recoverable using Correa’s GAC, even when the ATE is not. The latter can be <em>reconstructed</em> as ATE = NIE + TDE. Yet, this approach has drawbacks relative to regression adjustment:</p>
<ul>
<li><p>Identifiability conditions in the substantive model are stronger for mediation effects than for the ATE: sequential ignorability (and cross-world assumption). Not clear to me how violations impact recoverability.</p></li>
<li><p>TMLE for mediation effects become a bit more involved</p></li>
<li><p>An explicit model for <img src="https://latex.codecogs.com/png.latex?M"> is required, but reformulations similar to <strong>solution 2</strong> are possible <span class="citation" data-cites="deepmed">(Xu, Liu, and Liu 2022)</span></p></li>
</ul>
</section>
<section id="multiply-robustness" class="level3">
<h3 class="anchored" data-anchor-id="multiply-robustness">Multiply-robustness</h3>
<p>Combining IPW and regression adjustment solutions produces <strong>multiply-robustness</strong>. A <strong>doubly-robust</strong> estimator for the ATE can be constructed for <strong>solution 1</strong>: it will be consistent if all semiparametric models involved are correctly specified, or in one of these scenarios:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?p(M%5Cmid%20H,%20A),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,%20M,%20R_Y=1%5D%5Cquad"> are both well specified</li>
<li><img src="https://latex.codecogs.com/png.latex?p(A%5Cmid%20H)"> and <img src="https://latex.codecogs.com/png.latex?p(R_Y%5Cmid%20A,H,M)"> are both well specified</li>
</ul>
<p>Nested regressions (<strong>solution 2</strong>) would produce <strong>doubly-robustness</strong> too, with consistency if either:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?Q_2(H,A)=%5Cmathbb%7BE%7D_%7BM%5Cmid%20H,A=a%7D%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A=a,%20M,%20R_Y=1%5D"> is well specified</li>
<li><img src="https://latex.codecogs.com/png.latex?p(A%5Cmid%20H)"> and <img src="https://latex.codecogs.com/png.latex?p(R_Y%5Cmid%20A,H,M)"> are both well specified</li>
</ul>
<p>Mediation analysis would produce <strong>triply-robustness</strong>, with consistency if all semiparametric models involved are correctly specified, or in one of these scenarios:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?p(M%5Cmid%20H,%20A),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,%20M,%20R_Y=1%5D%5Cquad"> are all well specified</li>
<li><img src="https://latex.codecogs.com/png.latex?p(A%5Cmid%20H),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?p(R_Y%5Cmid%20A,H,M),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?p(M%5Cmid%20H,%20A)%5Cquad"> are all well specified</li>
<li><img src="https://latex.codecogs.com/png.latex?p(A%5Cmid%20H),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?p(R_Y%5Cmid%20A,H,M),%5Cquad"> <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D%5BY%5Cmid%20H,A,%20M,%20R_Y=1%5D%5Cquad"> are all well specified</li>
</ul>
<p>Note that, using a misspecified model for <img src="https://latex.codecogs.com/png.latex?M"> here (like when reducing its dimension with PCA, VAE or representation learning) leaves the estimator with <span style="color:blue;">worse</span> robustness than simply using IPW, as it requires correct specification of <img src="https://latex.codecogs.com/png.latex?A">, <img src="https://latex.codecogs.com/png.latex?R_Y"> and <img src="https://latex.codecogs.com/png.latex?Y">, whereas IPW only requires <img src="https://latex.codecogs.com/png.latex?A">, <img src="https://latex.codecogs.com/png.latex?R_Y"></p>
</section>
</section>
<section id="path-forward" class="level2">
<h2 class="anchored" data-anchor-id="path-forward">Path forward</h2>
<p>Let us commit to:</p>
<ol type="1">
<li>One missing mechanism: <img src="https://latex.codecogs.com/png.latex?R_Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?m">-graph depicted in figure 1, so we have identifiability in the substantive model, and recoverability via IPW and regression</li>
<li>TMLE (the super-learner is default, we could restrict to only splines or BART, Bayesian?)</li>
</ol>
<ul>
<li>The <code>tmle</code> package in <code>R</code> deals with missing data in a very basic manner, combining dropping observations and single median-imputations: <a href="https://tlverse.org/tmle3/reference/process_missing.html">preprocessing missing data for TMLE</a></li>
</ul>
<ol start="4" type="1">
<li>Nested regressions, and full <img src="https://latex.codecogs.com/png.latex?M">-model only for one mediator</li>
<li>Try simulations</li>
</ol>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bareinboim12" class="csl-entry">
Bareinboim, Elias, and Judea Pearl. 2012. <span>“Controlling Selection Bias in Causal Inference.”</span> In <em>Proceedings of the Fifteenth International Conference on Artificial Intelligence and Statistics</em>, edited by Neil D. Lawrence and Mark Girolami, 22:100–108. Proceedings of Machine Learning Research. La Palma, Canary Islands: PMLR. <a href="https://proceedings.mlr.press/v22/bareinboim12.html">https://proceedings.mlr.press/v22/bareinboim12.html</a>.
</div>
<div id="ref-Bareinboim_Tian_Pearl_2014" class="csl-entry">
Bareinboim, Elias, Jin Tian, and Judea Pearl. 2014. <span>“Recovering from Selection Bias in Causal and Statistical Inference.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 28 (1). <a href="https://doi.org/10.1609/aaai.v28i1.9074">https://doi.org/10.1609/aaai.v28i1.9074</a>.
</div>
<div id="ref-Bhattacharya2020" class="csl-entry">
Bhattacharya, Rohit, Razieh Nabi, Ilya Shpitser, and James M. Robins. 2020. <span>“Identification in Missing Data Models Represented by Directed Acyclic Graphs.”</span> In <em>Proceedings of the 35th Uncertainty in Artificial Intelligence Conference</em>, edited by Ryan P. Adams and Vibhav Gogate, 115:1149–58. Proceedings of Machine Learning Research. PMLR. <a href="https://proceedings.mlr.press/v115/bhattacharya20b.html">https://proceedings.mlr.press/v115/bhattacharya20b.html</a>.
</div>
<div id="ref-DML" class="csl-entry">
Chernozhukov, Victor, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and James Robins. 2018. <span>“<span class="nocase">Double/debiased machine learning for treatment and structural parameters</span>.”</span> <em>The Econometrics Journal</em> 21 (1): C1–68. <a href="https://doi.org/10.1111/ectj.12097">https://doi.org/10.1111/ectj.12097</a>.
</div>
<div id="ref-Correa_Tian_Bareinboim_2019" class="csl-entry">
Correa, Juan D., Jin Tian, and Elias Bareinboim. 2019. <span>“Identification of Causal Effects in the Presence of Selection Bias.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 33 (01): 2744–51. <a href="https://doi.org/10.1609/aaai.v33i01.33012744">https://doi.org/10.1609/aaai.v33i01.33012744</a>.
</div>
<div id="ref-Correa_Tian_Bareinboim_2018" class="csl-entry">
Correa, Juan, Jin Tian, and Elias Bareinboim. 2018. <span>“Generalized Adjustment Under Confounding and Selection Biases.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 32 (1). <a href="https://doi.org/10.1609/aaai.v32i1.12125">https://doi.org/10.1609/aaai.v32i1.12125</a>.
</div>
<div id="ref-DEMP1977" class="csl-entry">
Dempster, A. P., N. M. Laird, and D. B. Rubin. 1977. <span>“Maximum Likelihood from Incomplete Data via the <span>EM</span> Algorithm.”</span> <em>Journal of the Royal Statistical Society: Series B</em> 39: 1–38. <a href="http://web.mit.edu/6.435/www/Dempster77.pdf">http://web.mit.edu/6.435/www/Dempster77.pdf</a>.
</div>
<div id="ref-EMMI" class="csl-entry">
Dong, Yiran, and Chao-Ying Joanne Peng. 2013. <span>“Principled Missing Data Methods for Researchers.”</span> <em>SpringerPlus</em> 2: 1–17.
</div>
<div id="ref-hernan2004structural" class="csl-entry">
Hernán, Miguel A., Sonia Hernández-Díaz, and James M. Robins. 2004. <span>“A Structural Approach to Selection Bias.”</span> <em>Epidemiology (Cambridge, Mass.)</em> 15 (5): 615–25. <a href="https://doi.org/10.1097/01.ede.0000135174.63482.43">https://doi.org/10.1097/01.ede.0000135174.63482.43</a>.
</div>
<div id="ref-lewin2018attrition" class="csl-entry">
Lewin, A., R. Brondeel, T. Benmarhnia, F. Thomas, and B. Chaix. 2018. <span>“Attrition Bias Related to Missing Outcome Data: A Longitudinal Simulation Study.”</span> <em>Epidemiology</em> 29 (1): 87–95. <a href="https://doi.org/10.1097/EDE.0000000000000755">https://doi.org/10.1097/EDE.0000000000000755</a>.
</div>
<div id="ref-Mohan2014" class="csl-entry">
Mohan, Karthika, and Judea Pearl. 2014. <span>“Graphical Models for Recovering Probabilistic and Causal Queries from Missing Data.”</span> In <em>Advances in Neural Information Processing Systems</em>, edited by Z. Ghahramani, M. Welling, C. Cortes, N. Lawrence, and K. Q. Weinberger. Vol. 27. Curran Associates, Inc. <a href="https://proceedings.neurips.cc/paper_files/paper/2014/file/31839b036f63806cba3f47b93af8ccb5-Paper.pdf">https://proceedings.neurips.cc/paper_files/paper/2014/file/31839b036f63806cba3f47b93af8ccb5-Paper.pdf</a>.
</div>
<div id="ref-mgraphs" class="csl-entry">
———. 2021. <span>“Graphical Models for Processing Missing Data.”</span> <em>Journal of the American Statistical Association</em> 116 (534): 1023–37. <a href="https://doi.org/10.1080/01621459.2021.1874961">https://doi.org/10.1080/01621459.2021.1874961</a>.
</div>
<div id="ref-Pearl1995" class="csl-entry">
Pearl, Judea. 1995. <span>“Causal Diagrams for Empirical Research.”</span> <em>Biometrika</em> 82 (4): 669–88. <a href="http://www.jstor.org/stable/2337329">http://www.jstor.org/stable/2337329</a>.
</div>
<div id="ref-PearlDo" class="csl-entry">
———. 2012. <span>“The Do-Calculus Revisited.”</span> In <em>Proceedings of the Twenty-Eighth Conference on Uncertainty in Artificial Intelligence</em>, 3–11. UAI’12. Arlington, Virginia, USA: AUAI Press.
</div>
<div id="ref-MIPW" class="csl-entry">
Perkins, Neil J, Stephen R Cole, Ofer Harel, Eric J Tchetgen Tchetgen, BaoLuo Sun, Emily M Mitchell, and Enrique F Schisterman. 2017. <span>“<span class="nocase">Principled Approaches to Missing Data in Epidemiologic Studies</span>.”</span> <em>American Journal of Epidemiology</em> 187 (3): 568–75. <a href="https://doi.org/10.1093/aje/kwx348">https://doi.org/10.1093/aje/kwx348</a>.
</div>
<div id="ref-robins1986gcomp" class="csl-entry">
Robins, James. 1986. <span>“A New Approach to Causal Inference in Mortality Studies with a Sustained Exposure Period—Application to Control of the Healthy Worker Survivor Effect.”</span> <em>Mathematical Modelling</em> 7 (9-12): 1393–1512.
</div>
<div id="ref-robins1992recovery" class="csl-entry">
Robins, James, and Andrea Rotnitzky. 1992. <span>“Recovery of Information and Adjustment for Dependent Censoring Using Surrogate Markers, Aids Epidemiology, Methodological Issues.”</span> <em>Proceedings of the American Statistical Association. Boston: Birkhauser</em>, 24–33.
</div>
<div id="ref-Robins1994" class="csl-entry">
Robins, James, Andrea Rotnitzky, and Lue Zhao. 1994. <span>“Estimation of Regression Coefficients When Some Regressors Are Not Always Observed.”</span> <em>Journal of the American Statistical Association</em> 89 (427): 846–66.
</div>
<div id="ref-Rubin1976" class="csl-entry">
Rubin, Donald B. 1976. <span>“Inference and Missing Data.”</span> <em>Biometrika</em> 63 (3): 581–92.
</div>
<div id="ref-RubinMIpaper" class="csl-entry">
———. 1978. <span>“Multiple Imputations in Sample Surveys: A Phenomenological <span>B</span>ayesian Approach to Nonresponse.”</span> <em>Journal of the American Statistical Association</em> 73 (362): 384–95.
</div>
<div id="ref-seaman2013review" class="csl-entry">
Seaman, Shaun R, and Ian R White. 2013. <span>“Review of Inverse Probability Weighting for Dealing with Missing Data.”</span> <em>Statistical Methods in Medical Research</em> 22 (3): 278–95.
</div>
<div id="ref-TMLEbook1" class="csl-entry">
van der Laan, M. J., and S. Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.no/books?id=RGnSX5aCAgQC">https://books.google.no/books?id=RGnSX5aCAgQC</a>.
</div>
<div id="ref-deepmed" class="csl-entry">
Xu, Siqi, Lin Liu, and Zhonghua Liu. 2022. <span>“DeepMed: Semiparametric Causal Mediation Analysis with Debiased Deep Learning.”</span> <em>Advances in Neural Information Processing Systems</em> 35: 28238–51.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><img src="https://latex.codecogs.com/png.latex?m">-graphs generalize causal graphs in settings with sample selection <span class="citation" data-cites="hernan2004structural">(Hernán, Hernández-Díaz, and Robins 2004)</span> and missing data <span class="citation" data-cites="mgraphs">(Mohan and Pearl 2021)</span>.↩︎</p></li>
<li id="fn2"><p>The back-door graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5BA%5C!-%5C!Y%5D"> is the graph resulting from removing in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'"> the first arrow of all directed paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">. It is termed the <em>proper back-door graph</em> in multi-exposure settings, and results from removing the first arrow of all directed and <em>non-self-intersecting</em> paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">.↩︎</p></li>
<li id="fn3"><p>Sampling from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y%5E*,R_Y)"> is equivalent to sample from <img src="https://latex.codecogs.com/png.latex?%5C%7BP(H,A,M,Y%5Cmid%20R_Y=1),P(H,A,M)%5C%7D">↩︎</p></li>
<li id="fn4"><p>Recoverability might be possible without identifiability in the substantive model, via (fairly complicated) <img src="https://latex.codecogs.com/png.latex?c">-factorizations <span class="citation" data-cites="Correa_Tian_Bareinboim_2019">(J. D. Correa, Tian, and Bareinboim 2019)</span> or <img src="https://latex.codecogs.com/png.latex?%5Cphi">-factorizations <span class="citation" data-cites="Bhattacharya2020">(Bhattacharya et al. 2020)</span> related to the problem of <img src="https://latex.codecogs.com/png.latex?g">-<em>identifiability</em>↩︎</p></li>
<li id="fn5"><p>Literature review based on <span class="citation" data-cites="seaman2013review">Seaman and White (2013)</span>, <span class="citation" data-cites="EMMI">Dong and Peng (2013)</span>, <span class="citation" data-cites="MIPW">Perkins et al. (2017)</span>, <span class="citation" data-cites="lewin2018attrition">Lewin et al. (2018)</span>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>selection bias</category>
  <category>mediation</category>
  <category>regression</category>
  <category>IPW</category>
  <category>doubly-robust</category>
  <category>TMLE</category>
  <guid>https://johandh2o.github.io/posts/2023-08-01_missingOutcome/index.html</guid>
  <pubDate>Mon, 31 Jul 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/logo.png" medium="image" type="image/png" height="145" width="144"/>
</item>
<item>
  <title>Recovering from selection bias with IPW methods</title>
  <link>https://johandh2o.github.io/posts/2023-03-01_ipw/index.html</link>
  <description><![CDATA[ 



<hr>
<p><em>Confounding bias</em> and <em>selection bias</em> are together the most prevalent hurdles to the validity and generalizability of causal inference results. In general, both arise from uncontrolled extraneous flows of statistical information between treatment and outcome in the analysis. Their precise characterization in the Structural Causal Models framework (SCM), and potential corrections, differ in nature:</p>
<ul>
<li><p><strong>Confounding bias</strong> emerges from <em>open backdoor paths</em> between treatment and outcome in the directed acyclic graph (DAG) that represents the set of assumptions on the system’s causal mechanisms. In experimental settings, (conditional) randomization of treatment assignment provides a practical solution to the problem. In observational studies, the <em>do</em>-calculus, developed by Judea Pearl <span class="citation" data-cites="pearl2009">(Pearl 2009)</span>, constitute a complete and formal set of graphical rules to test the identifiability of the target causal parameters.</p></li>
<li><p><strong>Selection bias</strong> emerges from the preferential exclusion of units from the sample under analysis. It implies conditioning on a <em>collider</em> (or a descendant of a <em>virtual collider</em>), which opens backdoor paths between treatment and outcome. Besides, distributions learnt from the biased samples might not generalize to the whole population. Selection bias cannot be removed via randomization, which makes it a concern for experimental settings as well. There exist extensions of the <em>do</em>-calculus to deal with selection bias in some cases. <em>Inverse probability weighting</em> (IPW) methods are more frequently used in applied work.</p></li>
</ul>
<section id="corrections-for-selection-bias" class="level1">
<h1>Corrections for selection bias</h1>
<p><em>Inverse probability weighting</em> (IPW) methods provide nonparametric statistical techniques to perform inference with biased data. In their basic presentation, they approximate the <em>interventional mean</em> of the outcome using a weighted average over the selected sample. Let:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?(y_i)_%7Bi=1%7D%5EN"> be a sample of outcomes for the selected (non-excluded) units</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?w_i"> be the relative inverse probability of selection, <img src="https://latex.codecogs.com/png.latex?w_i=p/p_i">, where <img src="https://latex.codecogs.com/png.latex?p"> is the population-level probability of selection, and <img src="https://latex.codecogs.com/png.latex?p_i"> is the probability of selection for unit <img src="https://latex.codecogs.com/png.latex?i"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?v_i(a)"> be the inverse probability of assignment of treatment <img src="https://latex.codecogs.com/png.latex?a"> for unit <img src="https://latex.codecogs.com/png.latex?i"></p></li>
</ul>
<p>The idea of IPW methods is motivated by the desired asymptotic result:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Clim_%7BN%5Crightarrow%5Cinfty%7D%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%20%5Cmathbb%7BI%7D%5BA_i=a%5D%20v_i(a)%5Ccdot%20w_i%5Ccdot%20y_i%5Clongrightarrow%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%0A"></p>
<p>The derived finite-sample estimator is consistent if <img src="https://latex.codecogs.com/png.latex?v_i(a)%5Ccdot%20w_i"> is; this is, if the probability of selection and the probability of treatment assignment are jointly correctly specified.</p>
<p>Let us analyse the results of an IPW-based approach on a simple simulation with a randomized treatment assignment and when:</p>
<ol type="1">
<li><p>the selection mechanism only hides the outcome. This is, only <img src="https://latex.codecogs.com/png.latex?Y"> is missing when <img src="https://latex.codecogs.com/png.latex?S=0"></p></li>
<li><p>the selection mechanism does not depend on a mediator</p></li>
</ol>
<section id="simple-simulation-setting" class="level2">
<h2 class="anchored" data-anchor-id="simple-simulation-setting">Simple simulation setting</h2>
<p>Let us consider the SCM given by the following DAG and set of structural equations:</p>
</section>
<section id="the-dag" class="level2">
<h2 class="anchored" data-anchor-id="the-dag">The DAG:</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DAG visualization</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dagitty)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdag)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb1-7">  M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A,</span>
<span id="cb1-8">  S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L,</span>
<span id="cb1-9">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L</span>
<span id="cb1-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layout =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nicely"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://johandh2o.github.io/posts/2023-03-01_ipw/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="structural-equations" class="level2">
<h2 class="anchored" data-anchor-id="structural-equations">Structural equations:</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%5Bc%5D%0AL%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_L)%20&amp;%20&amp;%5C%5C%0AA%20&amp;%5Csim%5Ctext%7BBer%7D(q)%20&amp;%20&amp;%5C%5C%0AM%20&amp;=%20%5Calpha_0%20+%20%5Calpha_1A%20+%20u_M%20&amp;%20u_M%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_M)%20%5C%5C%0AS%20&amp;=%20%5Cmathbb%7BI%7D%5B%5Cgamma_0%20+%20%5Cgamma_1A%20+%20%5Cgamma_2M%20+%20%5Cgamma_3L%20+%20u_S%20%3E%200%5D%20&amp;%20u_S%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_S)%20%5C%5C%0AY%20&amp;=%20%5Cbeta_0%20+%20%5Cbeta_1A%20+%20%5Cbeta_2M%20+%20%5Cbeta_3L%20+%20u_Y%20&amp;%20u_Y%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_Y)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="selection-mechanism" class="level2">
<h2 class="anchored" data-anchor-id="selection-mechanism">Selection mechanism:</h2>
<p>When <img src="https://latex.codecogs.com/png.latex?S=1"> for a particular unit, we get to observe their whole data <img src="https://latex.codecogs.com/png.latex?(L,A,M,Y)">. When <img src="https://latex.codecogs.com/png.latex?S=1">, only the final outcome <img src="https://latex.codecogs.com/png.latex?Y"> is missing, so we get to observe <img src="https://latex.codecogs.com/png.latex?(L,A,M)">.</p>
<p>Let us put this SCM as a data-generating process (DGP) in <em>R</em> code:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Libraries needed</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DescTools)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(LaplacesDemon)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(kableExtra)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(modelsummary)</span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)</span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(zeallot)</span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(reshape2)</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data generating process</span></span>
<span id="cb2-12">dgp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(param){</span>
<span id="cb2-13">  </span>
<span id="cb2-14">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### Parameters</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb2-16">    sdl,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection predictor</span></span>
<span id="cb2-17">    p,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment probability</span></span>
<span id="cb2-18">    a0, a1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;M relation</span></span>
<span id="cb2-19">    sdm,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of mediator noise</span></span>
<span id="cb2-20">    g0, g1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;S relation</span></span>
<span id="cb2-21">    g2,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;S relation</span></span>
<span id="cb2-22">    g3,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;S relation</span></span>
<span id="cb2-23">    sds,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb2-24">    b0, b1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;Y relation</span></span>
<span id="cb2-25">    b2,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;Y relation</span></span>
<span id="cb2-26">    b3,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;Y relation</span></span>
<span id="cb2-27">    sdy <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb2-28">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;-%</span> param     </span>
<span id="cb2-29">  </span>
<span id="cb2-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exogenous selection predictor</span></span>
<span id="cb2-31">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdl)</span>
<span id="cb2-32">  </span>
<span id="cb2-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment</span></span>
<span id="cb2-34">  A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob=</span>p)</span>
<span id="cb2-35">  </span>
<span id="cb2-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mediator</span></span>
<span id="cb2-37">  noise.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdm)</span>
<span id="cb2-38">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.M</span>
<span id="cb2-39">  </span>
<span id="cb2-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Selection mechanism</span></span>
<span id="cb2-41">  noise.S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sds)</span>
<span id="cb2-42">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(g0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-43">  </span>
<span id="cb2-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outcome</span></span>
<span id="cb2-45">  noise.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdy)</span>
<span id="cb2-46">  Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.Y</span>
<span id="cb2-47">  </span>
<span id="cb2-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># true ATE</span></span>
<span id="cb2-49">  true.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a1</span>
<span id="cb2-50">  </span>
<span id="cb2-51">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data</span></span>
<span id="cb2-52">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(L,A,M,S,Y)</span>
<span id="cb2-53">  </span>
<span id="cb2-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return</span></span>
<span id="cb2-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(dat,true.ATE))</span>
<span id="cb2-56">}</span></code></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="simulation-excercise" class="level1">
<h1>Simulation excercise</h1>
<p>This case of <img src="https://latex.codecogs.com/png.latex?M"> not being a direct cause of <img src="https://latex.codecogs.com/png.latex?S"> is equivalent to setting <img src="https://latex.codecogs.com/png.latex?%5Cgamma_2=0"> in the structural equation of the selection mechanism <img src="https://latex.codecogs.com/png.latex?S">. Let us simulate some noisy data:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set random seed</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters values</span></span>
<span id="cb3-5">param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdl=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection predictor</span></span>
<span id="cb3-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment probability</span></span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a0=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;M relation</span></span>
<span id="cb3-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdm=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of mediator noise</span></span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;S relation</span></span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;S relation </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">###</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> M DOES NOT CAUSE S</span></span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g3=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;S relation</span></span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sds=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb3-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;Y relation</span></span>
<span id="cb3-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b2=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;Y relation</span></span>
<span id="cb3-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b3=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.8</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;Y relation</span></span>
<span id="cb3-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdy=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.7</span>)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate data</span></span>
<span id="cb3-21">dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgp</span>(param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the full data</span></span>
<span id="cb3-24">dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the true ATE</span></span>
<span id="cb3-27">T.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Glimpse of the data</span></span>
<span id="cb3-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">L</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">A</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">M</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2.2872472</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.2988695</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.0302749</td>
</tr>
<tr class="even">
<td style="text-align: right;">-1.1967717</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.5175524</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.7544911</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.6942925</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0183553</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-3.2428682</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.4122930</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.3229087</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2.8405141</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.9706733</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.7833466</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-4.9430929</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.9472799</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.6778373</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-5.7906748</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can compute the true ATE underlying this SCM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True ATE</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>T.ATE) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">True.ATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.75</td>
</tr>
</tbody>
</table>


</div>
</div>
<hr>
<section id="results-under-no-exclusion-complete-data" class="level2">
<h2 class="anchored" data-anchor-id="results-under-no-exclusion-complete-data">Results under no exclusion (complete data)</h2>
<p>For a moment let us pretend we observe all variables for everyone. Let us examine the most interesting models that we can fit with the simulated data, to check their ability to recover population-level parameters under noisy samples.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for M, with complete data</span></span>
<span id="cb5-2">mod.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for S, with complete data</span></span>
<span id="cb5-5">mod.S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probit'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Y, with complete data</span></span>
<span id="cb5-8">mod.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with complete data</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Version 1: Controlling for predictor of Y</span></span>
<span id="cb5-12">mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-13"></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with complete data</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Version 2: Treatment is randomized, no controls needed</span></span>
<span id="cb5-16">mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All models put together</span></span>
<span id="cb5-19">models.full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.M, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.S, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.Y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE (O-set)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE (no adj)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>)</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summary of models</span></span>
<span id="cb5-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(models.full, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statistic =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[{conf.low}, {conf.high}]"</span>,</span>
<span id="cb5-23">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{estimate}{stars}"</span>) </span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">M</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE (O-set)</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE (no adj)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;">0.104***</td>
<td style="text-align: center;">−0.107+</td>
<td style="text-align: center;">−1.579***</td>
<td style="text-align: center;">−1.498***</td>
<td style="text-align: center;">−1.524***</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">[0.069, 0.139]</td>
<td style="text-align: center;">[−0.219, 0.005]</td>
<td style="text-align: center;">[−1.816, −1.342]</td>
<td style="text-align: center;">[−1.732, −1.263]</td>
<td style="text-align: center;">[−1.803, −1.245]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: center;">0.506***</td>
<td style="text-align: center;">0.296***</td>
<td style="text-align: center;">0.281</td>
<td style="text-align: center;">0.677***</td>
<td style="text-align: center;">0.742***</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">[0.456, 0.556]</td>
<td style="text-align: center;">[0.135, 0.457]</td>
<td style="text-align: center;">[−0.114, 0.675]</td>
<td style="text-align: center;">[0.340, 1.013]</td>
<td style="text-align: center;">[0.342, 1.141]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">L</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.427***</td>
<td style="text-align: center;">1.755***</td>
<td style="text-align: center;">1.768***</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">[0.341, 0.514]</td>
<td style="text-align: center;">[1.584, 1.925]</td>
<td style="text-align: center;">[1.597, 1.940]</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">M</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.784***</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;">[0.369, 1.200]</td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
<td style="text-align: center; box-shadow: 0px 1.5px;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Num.Obs.</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">R2</td>
<td style="text-align: center;">0.283</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.311</td>
<td style="text-align: center;">0.301</td>
<td style="text-align: center;">0.013</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R2 Adj.</td>
<td style="text-align: center;">0.282</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.308</td>
<td style="text-align: center;">0.300</td>
<td style="text-align: center;">0.012</td>
</tr>
<tr class="even">
<td style="text-align: left;">AIC</td>
<td style="text-align: center;">1022.7</td>
<td style="text-align: center;">1278.2</td>
<td style="text-align: center;">4824.1</td>
<td style="text-align: center;">4835.8</td>
<td style="text-align: center;">5178.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BIC</td>
<td style="text-align: center;">1037.5</td>
<td style="text-align: center;">1292.9</td>
<td style="text-align: center;">4848.7</td>
<td style="text-align: center;">4855.5</td>
<td style="text-align: center;">5193.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Log.Lik.</td>
<td style="text-align: center;">−508.364</td>
<td style="text-align: center;">−636.108</td>
<td style="text-align: center;">−2407.072</td>
<td style="text-align: center;">−2413.913</td>
<td style="text-align: center;">−2586.403</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE</td>
<td style="text-align: center;">0.40</td>
<td style="text-align: center;">0.47</td>
<td style="text-align: center;">2.69</td>
<td style="text-align: center;">2.70</td>
<td style="text-align: center;">3.21</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Since the treatment is randomized, no <em>control</em> variables are required in the regression of <img src="https://latex.codecogs.com/png.latex?Y"> against <img src="https://latex.codecogs.com/png.latex?A"> to remove confounding bias. However, <img src="https://latex.codecogs.com/png.latex?L"> is in the <img src="https://latex.codecogs.com/png.latex?O">-set of the effect; this is, controlling for <img src="https://latex.codecogs.com/png.latex?L"> produces an asymptotically more efficient estimator. Such property is not seen in finite samples [see last two models].</p>
<p>It is no surprise that, with complete data, the point-estimate for the coefficient of <img src="https://latex.codecogs.com/png.latex?A"> in the last two models lie close to the true ATE (0.75), even under a moderately noisy DGP (<img src="https://latex.codecogs.com/png.latex?R%5E2%5Capprox%200.3">).</p>
<hr>
</section>
<section id="results-under-exclusion" class="level2">
<h2 class="anchored" data-anchor-id="results-under-exclusion">Results under exclusion</h2>
<p>Ignoring samples for which <img src="https://latex.codecogs.com/png.latex?S=0"> reduces sample size from 1000 to 514. This is, the probability of exclusion is about 0.486.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of observation per selection</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 = selected / observed</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 = excluded</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>S) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col.names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">486</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">514</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>In contrast with the complete data case, a regression-based approach for estimating the ATE with only the selected samples <strong>does</strong> require controlling for <img src="https://latex.codecogs.com/png.latex?L">, since conditioning on <img src="https://latex.codecogs.com/png.latex?S"> opens the non-causal path:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20S%5Clongleftarrow%20L%5Clongrightarrow%20Y"></li>
</ul>
<p>Unfortunately, controlling for <img src="https://latex.codecogs.com/png.latex?L"> alone <strong>does not</strong> remove selection bias, despite blocking such path. This is because <strong>the distribution of</strong> <img src="https://latex.codecogs.com/png.latex?L"> <strong>in the sample does not necessarily match the distribution in the population</strong>.</p>
<p>Let us inspect it.</p>
<section id="regression-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="regression-based-approach">Regression-based approach:</h3>
<p>We fit a model for the outcome <img src="https://latex.codecogs.com/png.latex?Y"> against <img src="https://latex.codecogs.com/png.latex?A">, controlling for <img src="https://latex.codecogs.com/png.latex?L">, using only the selected samples:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data for the selected sample</span></span>
<span id="cb7-2">dat.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-3">N.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s)</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with selected</span></span>
<span id="cb7-6">mod.ate.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat.s)</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE(S=1)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate.s), </span>
<span id="cb7-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statistic =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb7-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{estimate}{stars} [{conf.low}, {conf.high}]"</span>) </span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE(S=1)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;">−1.341*** [−1.688, −0.995]</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: center;">0.516* [0.058, 0.974]</td>
</tr>
<tr class="odd">
<td style="text-align: left; box-shadow: 0px 1.5px;">L</td>
<td style="text-align: center; box-shadow: 0px 1.5px;">1.843*** [1.601, 2.085]</td>
</tr>
<tr class="even">
<td style="text-align: left;">Num.Obs.</td>
<td style="text-align: center;">514</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R2</td>
<td style="text-align: center;">0.307</td>
</tr>
<tr class="even">
<td style="text-align: left;">R2 Adj.</td>
<td style="text-align: center;">0.304</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AIC</td>
<td style="text-align: center;">2458.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">BIC</td>
<td style="text-align: center;">2475.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Log.Lik.</td>
<td style="text-align: center;">−1225.026</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE</td>
<td style="text-align: center;">2.62</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The resulted 95% confidence interval for the coefficient of <img src="https://latex.codecogs.com/png.latex?A">, using only samples for which <img src="https://latex.codecogs.com/png.latex?S=1">, still covers the true ATE (0.75). Yet, a downwards bias shrinks the point-estimate and its lower bound noticeably. Using this, we would conclude the ATE is smaller than what truly is.</p>
<p>Let us implement an IPW-based approach to compare against:</p>
</section>
<section id="ipw-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="ipw-based-approach">IPW-based approach:</h3>
<p>Given the SCM, and the assumption of <img src="https://latex.codecogs.com/png.latex?%5Cgamma_2=0">, we can express:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?w_i=%5Cmathbb%7BP%7D(S=1)/%5Cmathbb%7BP%7D(S=1%5Cmid%20A=a_i,L=l_i)"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?v_i(a)=1/%5Cmathbb%7BP%7D(A=a)%20=%201/q"> because treatment is randomized</p></li>
</ul>
<p>The derived finite-sample estimator of the mean counterfactuals / potential outcomes is: <img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7BY%7D%5Ea%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Cmathbb%7BI%7D(A_i=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a_i,L=l_i)%7D%5Ccdot%20y_i%0A"></p>
<p>Putting all ingredients together we get point-estimates <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%5E1=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20do(A=1)%5D"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%5E0=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20do(A=0)%5D">:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the probability of selecton for all the units selected</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We leverage the model mod.S, trained on complete data since S, A and L are</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># always observed (Y is the only one missing) and predict only on the selected units</span></span>
<span id="cb8-4">prob.s.unit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod.S, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span>dat.s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The unconditional probability of selection can be consistently estimated </span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#... with counts from the total sample size and selected sample size</span></span>
<span id="cb8-8">prob.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Since the treatment is randomized, the propensity score in the population is known at 0.5. </span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It can also be estimated from counts in the complete dataset</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prop.score = sum(dat.1$A==1)/nrow(dat.1)</span></span>
<span id="cb8-13">prop.score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb8-16">est.PO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit),</span>
<span id="cb8-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s),</span>
<span id="cb8-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score),</span>
<span id="cb8-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb8-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb8-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.Y =</span> weights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PO'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.Y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N.s)</span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print resulted estimates</span></span>
<span id="cb8-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(est.PO) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">A</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PO</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">-1.4318076</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.7537995</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Which, can be used to compute a point-estimate of the ATE: <img src="https://latex.codecogs.com/png.latex?%5Chat%7BATE%7D=%5Chat%7BY%7D%5E1-%5Chat%7BY%7D%5E0">:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print estimated ATE</span></span>
<span id="cb9-2">est.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IPW ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>est.ATE) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">IPW.ATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.678008</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can see that the IPW-based approach produces a point-estimate closer to the true ATE. To get valid confidence intervals, however, a bootstrapping or asymptotic analysis need to be invoked. We can compute naïve confidence interval without resampling, using the fact:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7B%5Ctext%7BATE%7D%7D)%20%5Cgeq%20%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7BY%7D%5E1)+%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7BY%7D%5E0)=(N-2)%5E%7B-2%7D%5Csum_%7Ba%5Cin%5C%7B0,1%5C%7D%7D%5Csum_%7Bi=1%7D%5EN%20%5Cmathbb%7BI%7D(A_i=a)%5Ccdot%20%5Chat%7Bv%7D_i(a)%5E2%5Chat%7Bw%7D_i%5E2(y_i-%5Chat%7BY%7D%5Ea)%5E2%0A">Such variance is naïve in the sense that it is overconfident due to ignoring the covariance between the potential outcomes, and the higher-order contributions of the weighting factors in the total variance. Anyway, using it will get us:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb10-2">sd.PO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit),</span>
<span id="cb10-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s),</span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score),</span>
<span id="cb10-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb10-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb10-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.var =</span> weights<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ( A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb10-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sd'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.var))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(N.s<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-2</span>))</span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve confidence interval</span></span>
<span id="cb10-13">naivebounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sd.PO[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb10-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IPW ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE),</span>
<span id="cb10-15">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'naïve LB'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>naivebounds,</span>
<span id="cb10-16">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'naïve UB'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>naivebounds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">IPW.ATE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">naïve.LB</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">naïve.UB</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.678008</td>
<td style="text-align: right;">0.5741569</td>
<td style="text-align: right;">0.7818592</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>As noted, the naïve confidence interval is tighter than those produced by inference on the complete data. This means such confidence interval is not statistically valid, but it can still help us visualize the convergence of IPW estimator.</p>
<p>Now, if we simulate and repeat the DGP and same analysis for different sample sizes, consistency would be visually perceived if we see:</p>
<ul>
<li><p>Point-estimate converging to the true ATE</p></li>
<li><p>Confidence intervals shrinking at a fast (**) rate</p></li>
</ul>
<p>Let us test it. We run 20 simulations with different complete sample sizes, from <img src="https://latex.codecogs.com/png.latex?N=500"> to <img src="https://latex.codecogs.com/png.latex?N=23%5C,000"> [number of complete samples from <img src="https://latex.codecogs.com/png.latex?N_s=250"> to <img src="https://latex.codecogs.com/png.latex?N_s=12%5C,000">]. We repeat the procedure three times and average the results on those three repetitions. Such averages are presented in the following table:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data frame to save results from iterations</span></span>
<span id="cb11-2">rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Ns=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">EST=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LB=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">UB=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All sample sizes to consider</span></span>
<span id="cb11-5">samplesizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>)))</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of repetitions</span></span>
<span id="cb11-8">M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Paramaters are the same as before</span></span>
<span id="cb11-11">param.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span></span>
<span id="cb11-12"></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Seed</span></span>
<span id="cb11-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>)</span>
<span id="cb11-15"></span>
<span id="cb11-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop</span></span>
<span id="cb11-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(m <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>M){</span>
<span id="cb11-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> samplesizes){</span>
<span id="cb11-19">    </span>
<span id="cb11-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change sample size</span></span>
<span id="cb11-21">    param.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> n</span>
<span id="cb11-22">    </span>
<span id="cb11-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the data (complete and selected)</span></span>
<span id="cb11-24">    dat.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgp</span>(param.iter)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb11-25">    dat.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-26">    </span>
<span id="cb11-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated probability of selection</span></span>
<span id="cb11-28">    N.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s.iter)</span>
<span id="cb11-29">    prob.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> N.s.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n</span>
<span id="cb11-30">    </span>
<span id="cb11-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for S, with complete data</span></span>
<span id="cb11-32">    mod.S.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probit'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat.iter)</span>
<span id="cb11-33">    prob.s.unit.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod.S.iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span>dat.s.iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb11-34">  </span>
<span id="cb11-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Propensity score model</span></span>
<span id="cb11-36">    prop.score.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(dat.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.iter)</span>
<span id="cb11-37">    </span>
<span id="cb11-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put everything together</span></span>
<span id="cb11-39">    row.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-40">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit.iter),</span>
<span id="cb11-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.iter),</span>
<span id="cb11-42">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score.iter),</span>
<span id="cb11-43">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb11-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb11-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.Y =</span> weights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y) </span>
<span id="cb11-46">    </span>
<span id="cb11-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb11-48">    po.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> row.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-49">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y(A)'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.Y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N.s.iter)</span>
<span id="cb11-50">    </span>
<span id="cb11-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated ATE</span></span>
<span id="cb11-52">    ATE.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-53">    </span>
<span id="cb11-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve variances</span></span>
<span id="cb11-55">    sd.PO.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> row.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-56">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.var =</span> weights<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ( A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-57">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-58">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sd'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.var))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(N.s.iter<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>))</span>
<span id="cb11-59">    </span>
<span id="cb11-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve confidence interval</span></span>
<span id="cb11-61">    naivebounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sd.PO.iter[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-62">    </span>
<span id="cb11-63">    rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind.data.frame</span>(rounds.IPPW,</span>
<span id="cb11-64">                                   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span>n,</span>
<span id="cb11-65">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Ns=</span>N.s.iter,</span>
<span id="cb11-66">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">EST=</span>ATE.iter,</span>
<span id="cb11-67">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LB=</span>ATE.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>naivebounds,</span>
<span id="cb11-68">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">UB=</span>ATE.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>naivebounds))</span>
<span id="cb11-69">  }</span>
<span id="cb11-70">}</span>
<span id="cb11-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print resulted estimates</span></span>
<span id="cb11-72">rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> rounds.IPPW[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(N) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise_all</span>(mean)</span>
<span id="cb11-75"></span>
<span id="cb11-76"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(rounds.IPPW) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Ns</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">EST</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">LB</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">UB</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">500</td>
<td style="text-align: right;">249.6667</td>
<td style="text-align: right;">0.5919352</td>
<td style="text-align: right;">-0.1461034</td>
<td style="text-align: right;">1.3299737</td>
</tr>
<tr class="even">
<td style="text-align: right;">611</td>
<td style="text-align: right;">309.0000</td>
<td style="text-align: right;">0.7701710</td>
<td style="text-align: right;">0.1782066</td>
<td style="text-align: right;">1.3621354</td>
</tr>
<tr class="odd">
<td style="text-align: right;">746</td>
<td style="text-align: right;">379.6667</td>
<td style="text-align: right;">0.8962619</td>
<td style="text-align: right;">0.2991885</td>
<td style="text-align: right;">1.4933353</td>
</tr>
<tr class="even">
<td style="text-align: right;">911</td>
<td style="text-align: right;">453.6667</td>
<td style="text-align: right;">0.7438565</td>
<td style="text-align: right;">0.5811669</td>
<td style="text-align: right;">0.9065460</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1113</td>
<td style="text-align: right;">556.0000</td>
<td style="text-align: right;">0.7817429</td>
<td style="text-align: right;">0.3579693</td>
<td style="text-align: right;">1.2055165</td>
</tr>
<tr class="even">
<td style="text-align: right;">1359</td>
<td style="text-align: right;">679.0000</td>
<td style="text-align: right;">0.6411555</td>
<td style="text-align: right;">0.3223225</td>
<td style="text-align: right;">0.9599884</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>An the following plot:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Plot results from rounds</span></span>
<span id="cb12-2">rounds.IPPW[,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id.vars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ns'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(variable<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N. C.I.'</span>) ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>Ns,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>value,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(x)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## O(N^0.5) convergence</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Value of estimate / bound'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'number of complete samples'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span>T.ATE, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://johandh2o.github.io/posts/2023-03-01_ipw/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>We can appreciate that the estimator converges to the true ATE [in red], and its uncertainty reduce at a sustained rate; there is <strong>convergence in probability</strong>. In other words, the IPW-based estimator is consistent.</p>
<section id="mathematical-justification-of-consistency" class="level4">
<h4 class="anchored" data-anchor-id="mathematical-justification-of-consistency">Mathematical justification of consistency</h4>
<p>We can prove consistency mathematically for this SCM. However, to avoid measure-theoretic conundrums, let us consider the case for which all variables are discrete. Results are generalizable for mixed discrete-continuous cases with positive distributions (no zero-measure events).</p>
<p>Let us assume <img src="https://latex.codecogs.com/png.latex?Y"> has support on <img src="https://latex.codecogs.com/png.latex?%5C%7By_%7B(c)%7D%5C%7D_%7Bc=1%7D%5EC">, and <img src="https://latex.codecogs.com/png.latex?L"> has support on <img src="https://latex.codecogs.com/png.latex?%5C%7Bl_%7B(k)%7D%5C%7D_%7Bk=1%7D%5EK">, then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Chat%7BY%7D%5Ea%20&amp;=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a_i,L=l_i)%7D%5Ccdot%20y_i%5Ccdot%20%5Cmathbb%7BI%7D(A_i=a)%20%5C%5C%0A&amp;=%0AN%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_i)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a,L=l_i)%7D%5Ccdot%20y_i%5Ccdot%5Cmathbb%7BI%7D(A_i=a,S_i=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bi=1%7D%5EN%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_i)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_i%5Ccdot%5Cmathbb%7BI%7D(A_i=a,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_i,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bi=1%7D%5EN%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7Bi%7D%5Ccdot%5Cmathbb%7BI%7D(A_i=a,L_i=l_%7B(k)%7D,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%5Csum_%7Bi=1%7D%5EN%5Cmathbb%7BI%7D(Y_i=y_%7B(c)%7D,A_i=a,L_i=l_%7B(k)%7D,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>Assuming the propensity scores and the probability of selection are both correctly specified, all finite-sample approximations <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cmathbb%7BP%7D%7D"> converge in the limit to the true distributions <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D">. Then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Bplim%7D_%7BN%5Crightarrow%5Cinfty%7D%0A%5Chat%7BY%7D%5Ea%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D%5Cmid%20S=1)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Ccdot%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D%5Cmid%20A=a,L=l_%7B(k)%7D%20S=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Csum_%7Bc%7D%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D%5Cmid%20A=a,L=l_%7B(k)%7D,%20S=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,%20S=1)%5C%5C%0A&amp;=%0A%5Cmathbb%7BE%7D_L%0A%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,%20S=1)%20=%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a),L,S=1%5D%5C%5C%0A&amp;=%20%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a),L%5D%20=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>This is, the IPW estimator converges to the true counterfactual mean given by intervention <img src="https://latex.codecogs.com/png.latex?do(A=a)">. The last two equalities come from these facts:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?L"> blocks all non-causal paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y"> when conditioning on <img src="https://latex.codecogs.com/png.latex?S=1"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20S%5C,%5Cmid%20L"> in the back-door graph: the resulting DAG after removing all arrows coming out of <img src="https://latex.codecogs.com/png.latex?A"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(L=l_%7B(k)%7D)"> is the population-distribution of <img src="https://latex.codecogs.com/png.latex?L"></p></li>
</ul>
</section>
</section>
<section id="revisiting-the-regression-approach-generalized-adjustment-criteria" class="level3">
<h3 class="anchored" data-anchor-id="revisiting-the-regression-approach-generalized-adjustment-criteria">Revisiting the regression approach: generalized adjustment criteria</h3>
<p>Notice that, in the convergence proof for the IPW estimator, it was shown that the underlying estimand is algebraically equivalent to a regression-adjusted mean of <img src="https://latex.codecogs.com/png.latex?Y">, averaged over the population distribution of <img src="https://latex.codecogs.com/png.latex?L">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%20=%20%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,S=1)%0A"></p>
<p>Extensions of this results are covered by three <strong><em>generalized adjustment criteria</em></strong> <span class="citation" data-cites="Correa_Tian_Bareinboim_2018">(Correa, Tian, and Bareinboim 2018)</span>. This is, for this case, a mathematically equivalent result in term of consistency can be achieved via regression adjustment.</p>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Correa_Tian_Bareinboim_2018" class="csl-entry">
Correa, Juan, Jin Tian, and Elias Bareinboim. 2018. <span>“Generalized Adjustment Under Confounding and Selection Biases.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 32 (1). <a href="https://doi.org/10.1609/aaai.v32i1.12125">https://doi.org/10.1609/aaai.v32i1.12125</a>.
</div>
<div id="ref-pearl2009" class="csl-entry">
Pearl, Judea. 2009. <span>“Causality,”</span> September. <a href="https://doi.org/10.1017/cbo9780511803161">https://doi.org/10.1017/cbo9780511803161</a>.
</div>
</div></section></div> ]]></description>
  <category>IPW</category>
  <category>selection bias</category>
  <guid>https://johandh2o.github.io/posts/2023-03-01_ipw/index.html</guid>
  <pubDate>Tue, 28 Feb 2023 23:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-03-01_ipw/logo.png" medium="image" type="image/png" height="145" width="144"/>
</item>
</channel>
</rss>
