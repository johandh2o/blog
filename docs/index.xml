<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Johan de Aguas</title>
<link>https://johandh2o.github.io/index.html</link>
<atom:link href="https://johandh2o.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.353</generator>
<lastBuildDate>Mon, 31 Jul 2023 22:00:00 GMT</lastBuildDate>
<item>
  <title>Recovering causal effects from post-treatment selection induced by missing outcome data</title>
  <link>https://johandh2o.github.io/posts/2023-08-01_missingOutcome/index.html</link>
  <description><![CDATA[ 



<hr>
<section id="setting" class="level2">
<h2 class="anchored" data-anchor-id="setting">Setting</h2>
<p>Consider the following <img src="https://latex.codecogs.com/png.latex?m">-graph<sup>1</sup>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, representing the causal relations among a set of random variables <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BV%7D=%5C%7BH,A,M,Y,R_Y%5C%7D">, where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?H%5Cin%5Cmathbb%7BR%7D%5Ed"> is a vector of pre-treatment and context covariates</li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Cin%5C%7B0,1%5C%7D"> is a binary exposure</li>
<li><img src="https://latex.codecogs.com/png.latex?Y"> is the outcome of interest, with general support (univariate or multivariate, discrete or continuous)</li>
<li><img src="https://latex.codecogs.com/png.latex?M"> is a mediator on the causal pathway from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">, with general support</li>
<li><img src="https://latex.codecogs.com/png.latex?R_Y%5Cin%5C%7B0,1%5C%7D"> is an indicator of sample selection for <img src="https://latex.codecogs.com/png.latex?Y">, i.e., for a given sample, <img src="https://latex.codecogs.com/png.latex?R_Y=1"> means <img src="https://latex.codecogs.com/png.latex?Y"> is observed; otherwise <img src="https://latex.codecogs.com/png.latex?Y"> is missing (denoted with proxy <img src="https://latex.codecogs.com/png.latex?Y%5E*=%5Cemptyset">).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/mdag1.png" class="img-fluid figure-img" width="250"></p>
<figcaption class="figure-caption">Figure 1: <img src="https://latex.codecogs.com/png.latex?m">-graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"></figcaption>
</figure>
</div>
<p>Our goal is to estimate the average treatment effect (ATE), <img src="https://latex.codecogs.com/png.latex?%5Cpsi">, <strong>in the target population</strong>, defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%20:=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=1)%5D-%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=0)%5D%0A"></p>
</section>
<section id="the-problem-of-identifiability" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-of-identifiability">The problem of identifiability</h2>
<p>When there is no sample selection nor missingness, or when missing is <em>completely at random</em> (MCAR), all arrows pointing to <img src="https://latex.codecogs.com/png.latex?R_Y"> are absent. The <img src="https://latex.codecogs.com/png.latex?m">-graph representing the system correspond to a causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5Cequiv%5Cmathcal%7BG%7D%5B%5Coverline%7BR_Y%7D%5D">, and samples are obtained from the observational distribution <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)">. This is the traditional setting motivating causal inference with observational data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/mdag2.png" class="img-fluid figure-img" width="250"></p>
<figcaption class="figure-caption">Figure 2: causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5Cequiv%5Cmathcal%7BG%7D%5B%5Coverline%7BR_Y%7D%5D"></figcaption>
</figure>
</div>
<p>Under the assumptions embedded in the causal graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'">, and a special mutilation known as the <em>back-door graph</em> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5BA%5C!-%5C!Y%5D"><sup>2</sup>, <img src="https://latex.codecogs.com/png.latex?%5Cpsi"> is <em>nonparametrically identifiable</em> from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)"> via the <em>back-door formula</em> <span class="citation" data-cites="Pearl1995 PearlDo">(Pearl 1995, 2012)</span>, as: <img src="https://latex.codecogs.com/png.latex?%0A%5Cpsi%20=%20%5CDelta_a%5Cmathbb%7BE%7D_H%5Cmathbb%7BE%7D%5BY%5Cmid%20A=a,H%5D%0A"></p>
<p>Given identifiability plus <img src="https://latex.codecogs.com/png.latex?N"> i.i.d. sample from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y)">, a consistent estimator can be constructed using a regression model for the outcome <img src="https://latex.codecogs.com/png.latex?%5Chat%7BQ%7D(A,H)=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20A,H%5D"> and proceeding with <img src="https://latex.codecogs.com/png.latex?g">-computation <span class="citation" data-cites="robins1986gcomp">(Robins 1986)</span>: <img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Cpsi%7D%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5E%7BN%7D%5CDelta_a%5Chat%7BQ%7D(a,H_i)%0A"></p>
</section>
<section id="the-problem-of-recoverability" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-of-recoverability">The problem of recoverability</h2>
<p>A (causal) parameter is said to be <strong>recoverable</strong> from the observed-data distribution <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y%5E*,R_Y)%5Cequiv%5C%7BP(H,A,M,Y%5Cmid%20R_Y=1),P(H,A,M)%20%5C%7D"> if it can be uniquely computed from it using the assumptions embedded in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D"> (and the necessary graph mutilation).</p>
<p>Under identifiability in the substantive model <sup>3</sup>, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D%5B%5Coverline%7BR_Y%7D%5D">, there is an ample number of methods to recover joint/conditional distributions from sample selection/missingness, based on different statistical theories. Although not originally motivated by graphical models, they can be seen as <em>ad hoc</em> solutions under special graphical conditions <span class="citation" data-cites="mgraphs">(Mohan and Pearl 2021)</span>. Table 1 presents a summary of literature review <sup>4</sup> benchmarking four methodological approaches in terms of:</p>
<ul>
<li><span style="color:blue;">Graphical conditions for recoveravility</span>: from hard (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to easy (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) to fulfill/believe</li>
<li><span style="color:blue;">Flexibility in model specification</span>: from parametric (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to ML/nonparametric (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">)</li>
<li><span style="color:blue;">Statistical efficiency</span>: from wider (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to narrower (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) confidence/credible intervals</li>
<li><span style="color:blue;">Computational efficiency</span>: from slow (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar">) to fast (<img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar">) computation/convergence</li>
</ul>
<table class="table-striped table-hover table">
<caption>Table 1: some statistical methods to address selection/missingness</caption>
<colgroup>
<col style="width: 31%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Graph cond.</th>
<th>Flex. spec.</th>
<th>Stat. eff.</th>
<th>Comp. eff.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Expectation-maximization <span class="citation" data-cites="DEMP1977">(Dempster, Laird, and Rubin 1977)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
</tr>
<tr class="even">
<td>Multiple imputation <span class="citation" data-cites="Rubin1976 RubinMIpaper">(Rubin 1976, 1978)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
</tr>
<tr class="odd">
<td>Inverse probability weighting <span class="citation" data-cites="robins1992recovery Robins1994">(Robins and Rotnitzky 1992; Robins, Rotnitzky, and Zhao 1994)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
</tr>
<tr class="even">
<td>Regression adjustment <span class="citation" data-cites="Bareinboim_Tian_Pearl_2014 Correa_Tian_Bareinboim_2018">(Bareinboim, Tian, and Pearl 2014; J. Correa, Tian, and Bareinboim 2018)</span></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cbigstar%5Cbigstar%5Cbigstar"></td>
</tr>
</tbody>
</table>
<p>Arguably, the best set of properties come from IPW and regression adjustment, due to their direct derivation from graphical criteria, which might extend the Rubin-MAR setting. Moreover, both solutions have important theoretical results from the theory of semiparametric estimation, and produce <strong>doubly-</strong> or <strong>multiply-robustness</strong> when combined. These reasons have motivated syncretic estimators, such as:</p>
<table class="table-striped table-hover table">
<caption>Table 2: some doubly/multiply-robust estimation methods</caption>
<colgroup>
<col style="width: 36%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Can use ML libraries</th>
<th>Fast consistency</th>
<th>Plug-in for target</th>
<th>Bayesian version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Augmented inverse probability weighting (AIPW) <span class="citation" data-cites="Robins1994">(Robins, Rotnitzky, and Zhao 1994)</span></td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="even">
<td>Targeted learning <span class="citation" data-cites="TMLEbook1">(Laan and Rose 2011)</span></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes<img src="https://latex.codecogs.com/png.latex?%5E*"></td>
</tr>
<tr class="odd">
<td>Debiased machine learning (DML) <span class="citation" data-cites="DML">(Chernozhukov et al. 2018)</span></td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
</tbody>
</table>
<section id="recoverability-via-ipw" class="level3">
<h3 class="anchored" data-anchor-id="recoverability-via-ipw">Recoverability via IPW</h3>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20p(Y%5Cmid%20do(A))%20&amp;=%20%5Cint%5Cfrac%7B%20%5Ctext%7Bd%7D%20H%7D%7Bp(A%5Cmid%20H)%7D%5Cint%20%5Cfrac%7B%5Ctext%7Bd%7D%20M%7D%7B%5Cmathbb%7BP%7D(R_Y=1%5Cmid%20H,M)%7D%5C,%20p(Y,A,H,M%5Cmid%20R_Y=1)%20%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cmathbb%7BE%7D_%7BH%5Cmid%20R_Y=1%7D%5Cleft%5B%5Cfrac%7Bp(Y,A%5Cmid%20H,M,R_Y=1)%7D%7Bp(A%5Cmid%20H)%5C,%20%5Cmathbb%7BP%7D(R_Y=1%5Cmid%20H,M)%20%7D%20%20%5Cright%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%5Chat%7B%5Cpsi%7D%5E%7Bw%7D%20=%20N_1%5E%7B-1%7D%5Csum_%7Bi=1%7D%5E%7BN_1%7D%5Cfrac%7B(2A%5Ei-1)%5C,Y%5Ei%7D%7B%5Chat%7Bp%7D(A%5Ei%5Cmid%20H%5Ei)%5C,%5Chat%7B%5Cmathbb%7BP%7D%7D(R_Y=1%5Cmid%20H%5Ei,M%5Ei)%20%7D%0A"></p>
</section>
<section id="recoverability-via-regression-adjustment" class="level3">
<h3 class="anchored" data-anchor-id="recoverability-via-regression-adjustment">Recoverability via regression adjustment</h3>
</section>
<section id="multiple-robustness" class="level3">
<h3 class="anchored" data-anchor-id="multiple-robustness">Multiple robustness</h3>
<p>Notice that, working with samples from <img src="https://latex.codecogs.com/png.latex?P(H,A,M,Y%5E*,R_Y)%5Cequiv%5C%7BP(H,A,M,Y%5Cmid%20R_Y=1),P(H,A,M)%20%5C%7D"> implies conditioning on <img src="https://latex.codecogs.com/png.latex?R_Y=1"> <span class="citation" data-cites="Bareinboim12">(Bareinboim and Pearl 2012)</span>. In the <img src="https://latex.codecogs.com/png.latex?m">-graph of figure 1, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D">, such condition opens the following non-causal paths:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20H%5Clongrightarrow%20Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20H%5Clongrightarrow%20M%5Clongrightarrow%20Y"></li>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20R_Y%5Clongleftarrow%20M%5Clongrightarrow%20Y"></li>
</ul>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bareinboim12" class="csl-entry">
Bareinboim, Elias, and Judea Pearl. 2012. <span>“Controlling Selection Bias in Causal Inference.”</span> In <em>Proceedings of the Fifteenth International Conference on Artificial Intelligence and Statistics</em>, edited by Neil D. Lawrence and Mark Girolami, 22:100–108. Proceedings of Machine Learning Research. La Palma, Canary Islands: PMLR. <a href="https://proceedings.mlr.press/v22/bareinboim12.html">https://proceedings.mlr.press/v22/bareinboim12.html</a>.
</div>
<div id="ref-Bareinboim_Tian_Pearl_2014" class="csl-entry">
Bareinboim, Elias, Jin Tian, and Judea Pearl. 2014. <span>“Recovering from Selection Bias in Causal and Statistical Inference.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 28 (1). <a href="https://doi.org/10.1609/aaai.v28i1.9074">https://doi.org/10.1609/aaai.v28i1.9074</a>.
</div>
<div id="ref-Bhattacharya2020" class="csl-entry">
Bhattacharya, Rohit, Razieh Nabi, Ilya Shpitser, and James M. Robins. 2020. <span>“Identification in Missing Data Models Represented by Directed Acyclic Graphs.”</span> In <em>Proceedings of the 35th Uncertainty in Artificial Intelligence Conference</em>, edited by Ryan P. Adams and Vibhav Gogate, 115:1149–58. Proceedings of Machine Learning Research. PMLR. <a href="https://proceedings.mlr.press/v115/bhattacharya20b.html">https://proceedings.mlr.press/v115/bhattacharya20b.html</a>.
</div>
<div id="ref-DML" class="csl-entry">
Chernozhukov, Victor, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and James Robins. 2018. <span>“<span class="nocase">Double/debiased machine learning for treatment and structural parameters</span>.”</span> <em>The Econometrics Journal</em> 21 (1): C1–68. <a href="https://doi.org/10.1111/ectj.12097">https://doi.org/10.1111/ectj.12097</a>.
</div>
<div id="ref-Correa_Tian_Bareinboim_2019" class="csl-entry">
Correa, Juan D., Jin Tian, and Elias Bareinboim. 2019. <span>“Identification of Causal Effects in the Presence of Selection Bias.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 33 (01): 2744–51. <a href="https://doi.org/10.1609/aaai.v33i01.33012744">https://doi.org/10.1609/aaai.v33i01.33012744</a>.
</div>
<div id="ref-Correa_Tian_Bareinboim_2018" class="csl-entry">
Correa, Juan, Jin Tian, and Elias Bareinboim. 2018. <span>“Generalized Adjustment Under Confounding and Selection Biases.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 32 (1). <a href="https://doi.org/10.1609/aaai.v32i1.12125">https://doi.org/10.1609/aaai.v32i1.12125</a>.
</div>
<div id="ref-DEMP1977" class="csl-entry">
Dempster, A. P., N. M. Laird, and D. B. Rubin. 1977. <span>“Maximum Likelihood from Incomplete Data via the <span>EM</span> Algorithm.”</span> <em>Journal of the Royal Statistical Society: Series B</em> 39: 1–38. <a href="http://web.mit.edu/6.435/www/Dempster77.pdf">http://web.mit.edu/6.435/www/Dempster77.pdf</a>.
</div>
<div id="ref-EMMI" class="csl-entry">
Dong, Yiran, and Chao-Ying Joanne Peng. 2013. <span>“Principled Missing Data Methods for Researchers.”</span> <em>SpringerPlus</em> 2: 1–17.
</div>
<div id="ref-hernan2004structural" class="csl-entry">
Hernán, Miguel A., Sonia Hernández-Díaz, and James M. Robins. 2004. <span>“A Structural Approach to Selection Bias.”</span> <em>Epidemiology (Cambridge, Mass.)</em> 15 (5): 615–25. <a href="https://doi.org/10.1097/01.ede.0000135174.63482.43">https://doi.org/10.1097/01.ede.0000135174.63482.43</a>.
</div>
<div id="ref-TMLEbook1" class="csl-entry">
Laan, M. J. van der, and S. Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. Springer New York. <a href="https://books.google.no/books?id=RGnSX5aCAgQC">https://books.google.no/books?id=RGnSX5aCAgQC</a>.
</div>
<div id="ref-lewin2018attrition" class="csl-entry">
Lewin, A., R. Brondeel, T. Benmarhnia, F. Thomas, and B. Chaix. 2018. <span>“Attrition Bias Related to Missing Outcome Data: A Longitudinal Simulation Study.”</span> <em>Epidemiology</em> 29 (1): 87–95. <a href="https://doi.org/10.1097/EDE.0000000000000755">https://doi.org/10.1097/EDE.0000000000000755</a>.
</div>
<div id="ref-mgraphs" class="csl-entry">
Mohan, Karthika, and Judea Pearl. 2021. <span>“Graphical Models for Processing Missing Data.”</span> <em>Journal of the American Statistical Association</em> 116 (534): 1023–37. <a href="https://doi.org/10.1080/01621459.2021.1874961">https://doi.org/10.1080/01621459.2021.1874961</a>.
</div>
<div id="ref-Pearl1995" class="csl-entry">
Pearl, Judea. 1995. <span>“Causal Diagrams for Empirical Research.”</span> <em>Biometrika</em> 82 (4): 669–88. <a href="http://www.jstor.org/stable/2337329">http://www.jstor.org/stable/2337329</a>.
</div>
<div id="ref-PearlDo" class="csl-entry">
———. 2012. <span>“The Do-Calculus Revisited.”</span> In <em>Proceedings of the Twenty-Eighth Conference on Uncertainty in Artificial Intelligence</em>, 3–11. UAI’12. Arlington, Virginia, USA: AUAI Press.
</div>
<div id="ref-MIPW" class="csl-entry">
Perkins, Neil J, Stephen R Cole, Ofer Harel, Eric J Tchetgen Tchetgen, BaoLuo Sun, Emily M Mitchell, and Enrique F Schisterman. 2017. <span>“<span class="nocase">Principled Approaches to Missing Data in Epidemiologic Studies</span>.”</span> <em>American Journal of Epidemiology</em> 187 (3): 568–75. <a href="https://doi.org/10.1093/aje/kwx348">https://doi.org/10.1093/aje/kwx348</a>.
</div>
<div id="ref-robins1986gcomp" class="csl-entry">
Robins, James. 1986. <span>“A New Approach to Causal Inference in Mortality Studies with a Sustained Exposure Period—Application to Control of the Healthy Worker Survivor Effect.”</span> <em>Mathematical Modelling</em> 7 (9-12): 1393–1512.
</div>
<div id="ref-robins1992recovery" class="csl-entry">
Robins, James, and Andrea Rotnitzky. 1992. <span>“Recovery of Information and Adjustment for Dependent Censoring Using Surrogate Markers, Aids Epidemiology, Methodological Issues.”</span> <em>Proceedings of the American Statistical Association. Boston: Birkhauser</em>, 24–33.
</div>
<div id="ref-Robins1994" class="csl-entry">
Robins, James, Andrea Rotnitzky, and Lue Zhao. 1994. <span>“Estimation of Regression Coefficients When Some Regressors Are Not Always Observed.”</span> <em>Journal of the American Statistical Association</em> 89 (427): 846–66.
</div>
<div id="ref-Rubin1976" class="csl-entry">
Rubin, Donald B. 1976. <span>“Inference and Missing Data.”</span> <em>Biometrika</em> 63 (3): 581–92.
</div>
<div id="ref-RubinMIpaper" class="csl-entry">
———. 1978. <span>“Multiple Imputations in Sample Surveys: A Phenomenological <span>B</span>ayesian Approach to Nonresponse.”</span> <em>Journal of the American Statistical Association</em> 73 (362): 384–95.
</div>
<div id="ref-seaman2013review" class="csl-entry">
Seaman, Shaun R, and Ian R White. 2013. <span>“Review of Inverse Probability Weighting for Dealing with Missing Data.”</span> <em>Statistical Methods in Medical Research</em> 22 (3): 278–95.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><img src="https://latex.codecogs.com/png.latex?m">-graphs generalize causal graphs in settings with sample selection <span class="citation" data-cites="hernan2004structural">(Hernán, Hernández-Díaz, and Robins 2004)</span> and missing data <span class="citation" data-cites="mgraphs">(Mohan and Pearl 2021)</span>.↩︎</p></li>
<li id="fn2"><p>The back-door graph <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'%5BA%5C!-%5C!Y%5D"> is the graph resulting from removing in <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D'"> the first arrow of all directed paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">. It is termed the <em>proper back-door graph</em> in multi-exposure settings, and results from removing the first arrow of all directed and <em>non-self-intersecting</em> paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y">.↩︎</p></li>
<li id="fn3"><p>Recoverability might be possible without identifiability in the substantive model, via (fairly complicated) <img src="https://latex.codecogs.com/png.latex?c">-factorizations <span class="citation" data-cites="Correa_Tian_Bareinboim_2019">(J. D. Correa, Tian, and Bareinboim 2019)</span> or <img src="https://latex.codecogs.com/png.latex?%5Cphi">-factorizations <span class="citation" data-cites="Bhattacharya2020">(Bhattacharya et al. 2020)</span> related to the problem of <img src="https://latex.codecogs.com/png.latex?g">-<em>identifiability</em>↩︎</p></li>
<li id="fn4"><p>Literature review based on <span class="citation" data-cites="seaman2013review">Seaman and White (2013)</span>, <span class="citation" data-cites="EMMI">Dong and Peng (2013)</span>, <span class="citation" data-cites="MIPW">Perkins et al. (2017)</span>, <span class="citation" data-cites="lewin2018attrition">Lewin et al. (2018)</span>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>selection bias</category>
  <category>mediation</category>
  <category>regression</category>
  <category>IPW</category>
  <category>doubly-robust</category>
  <category>TMLE</category>
  <guid>https://johandh2o.github.io/posts/2023-08-01_missingOutcome/index.html</guid>
  <pubDate>Mon, 31 Jul 2023 22:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-08-01_missingOutcome/logo.png" medium="image" type="image/png" height="145" width="144"/>
</item>
<item>
  <title>Recovering from selection bias with IPW methods</title>
  <link>https://johandh2o.github.io/posts/2023-03-01_ipw/index.html</link>
  <description><![CDATA[ 



<hr>
<p><em>Confounding bias</em> and <em>selection bias</em> are together the most prevalent hurdles to the validity and generalizability of causal inference results. In general, both arise from uncontrolled extraneous flows of statistical information between treatment and outcome in the analysis. Their precise characterization in the Structural Causal Models framework (SCM), and potential corrections, differ in nature:</p>
<ul>
<li><p><strong>Confounding bias</strong> emerges from <em>open backdoor paths</em> between treatment and outcome in the directed acyclic graph (DAG) that represents the set of assumptions on the system’s causal mechanisms. In experimental settings, (conditional) randomization of treatment assignment provides a practical solution to the problem. In observational studies, the <em>do</em>-calculus, developed by Judea Pearl <span class="citation" data-cites="pearl2009">(Pearl 2009)</span>, constitute a complete and formal set of graphical rules to test the identifiability of the target causal parameters.</p></li>
<li><p><strong>Selection bias</strong> emerges from the preferential exclusion of units from the sample under analysis. It implies conditioning on a <em>collider</em> (or a descendant of a <em>virtual collider</em>), which opens backdoor paths between treatment and outcome. Besides, distributions learnt from the biased samples might not generalize to the whole population. Selection bias cannot be removed via randomization, which makes it a concern for experimental settings as well. There exist extensions of the <em>do</em>-calculus to deal with selection bias in some cases. <em>Inverse probability weighting</em> (IPW) methods are more frequently used in applied work.</p></li>
</ul>
<section id="corrections-for-selection-bias" class="level1">
<h1>Corrections for selection bias</h1>
<p><em>Inverse probability weighting</em> (IPW) methods provide nonparametric statistical techniques to perform inference with biased data. In their basic presentation, they approximate the <em>interventional mean</em> of the outcome using a weighted average over the selected sample. Let:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?(y_i)_%7Bi=1%7D%5EN"> be a sample of outcomes for the selected (non-excluded) units</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?w_i"> be the relative inverse probability of selection, <img src="https://latex.codecogs.com/png.latex?w_i=p/p_i">, where <img src="https://latex.codecogs.com/png.latex?p"> is the population-level probability of selection, and <img src="https://latex.codecogs.com/png.latex?p_i"> is the probability of selection for unit <img src="https://latex.codecogs.com/png.latex?i"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?v_i(a)"> be the inverse probability of assignment of treatment <img src="https://latex.codecogs.com/png.latex?a"> for unit <img src="https://latex.codecogs.com/png.latex?i"></p></li>
</ul>
<p>The idea of IPW methods is motivated by the desired asymptotic result:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Clim_%7BN%5Crightarrow%5Cinfty%7D%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%20%5Cmathbb%7BI%7D%5BA_i=a%5D%20v_i(a)%5Ccdot%20w_i%5Ccdot%20y_i%5Clongrightarrow%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%0A"></p>
<p>The derived finite-sample estimator is consistent if <img src="https://latex.codecogs.com/png.latex?v_i(a)%5Ccdot%20w_i"> is; this is, if the probability of selection and the probability of treatment assignment are jointly correctly specified.</p>
<p>Let us analyse the results of an IPW-based approach on a simple simulation with a randomized treatment assignment and when:</p>
<ol type="1">
<li><p>the selection mechanism only hides the outcome. This is, only <img src="https://latex.codecogs.com/png.latex?Y"> is missing when <img src="https://latex.codecogs.com/png.latex?S=0"></p></li>
<li><p>the selection mechanism does not depend on a mediator</p></li>
</ol>
<section id="simple-simulation-setting" class="level2">
<h2 class="anchored" data-anchor-id="simple-simulation-setting">Simple simulation setting</h2>
<p>Let us consider the SCM given by the following DAG and set of structural equations:</p>
</section>
<section id="the-dag" class="level2">
<h2 class="anchored" data-anchor-id="the-dag">The DAG:</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DAG visualization</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dagitty)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggdag)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dagify</span>(</span>
<span id="cb1-7">  M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A,</span>
<span id="cb1-8">  S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L,</span>
<span id="cb1-9">  Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L</span>
<span id="cb1-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy_dagitty</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layout =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nicely"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> xend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> yend)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_edges</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_dag_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_dag</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://johandh2o.github.io/posts/2023-03-01_ipw/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="structural-equations" class="level2">
<h2 class="anchored" data-anchor-id="structural-equations">Structural equations:</h2>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%5Bc%5D%0AL%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_L)%20&amp;%20&amp;%5C%5C%0AA%20&amp;%5Csim%5Ctext%7BBer%7D(q)%20&amp;%20&amp;%5C%5C%0AM%20&amp;=%20%5Calpha_0%20+%20%5Calpha_1A%20+%20u_M%20&amp;%20u_M%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_M)%20%5C%5C%0AS%20&amp;=%20%5Cmathbb%7BI%7D%5B%5Cgamma_0%20+%20%5Cgamma_1A%20+%20%5Cgamma_2M%20+%20%5Cgamma_3L%20+%20u_S%20%3E%200%5D%20&amp;%20u_S%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_S)%20%5C%5C%0AY%20&amp;=%20%5Cbeta_0%20+%20%5Cbeta_1A%20+%20%5Cbeta_2M%20+%20%5Cbeta_3L%20+%20u_Y%20&amp;%20u_Y%20&amp;%5Csim%5Ctext%7BNor%7D(0,%5Csigma%5E2_Y)%0A%5Cend%7Baligned%7D%0A"></p>
</section>
<section id="selection-mechanism" class="level2">
<h2 class="anchored" data-anchor-id="selection-mechanism">Selection mechanism:</h2>
<p>When <img src="https://latex.codecogs.com/png.latex?S=1"> for a particular unit, we get to observe their whole data <img src="https://latex.codecogs.com/png.latex?(L,A,M,Y)">. When <img src="https://latex.codecogs.com/png.latex?S=1">, only the final outcome <img src="https://latex.codecogs.com/png.latex?Y"> is missing, so we get to observe <img src="https://latex.codecogs.com/png.latex?(L,A,M)">.</p>
<p>Let us put this SCM as a data-generating process (DGP) in <em>R</em> code:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Libraries needed</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(DescTools)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(LaplacesDemon)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(kableExtra)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(modelsummary)</span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gt)</span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(zeallot)</span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(reshape2)</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data generating process</span></span>
<span id="cb2-12">dgp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(param){</span>
<span id="cb2-13">  </span>
<span id="cb2-14">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### Parameters</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(n,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb2-16">    sdl,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection predictor</span></span>
<span id="cb2-17">    p,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment probability</span></span>
<span id="cb2-18">    a0, a1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;M relation</span></span>
<span id="cb2-19">    sdm,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of mediator noise</span></span>
<span id="cb2-20">    g0, g1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;S relation</span></span>
<span id="cb2-21">    g2,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;S relation</span></span>
<span id="cb2-22">    g3,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;S relation</span></span>
<span id="cb2-23">    sds,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb2-24">    b0, b1, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;Y relation</span></span>
<span id="cb2-25">    b2,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;Y relation</span></span>
<span id="cb2-26">    b3,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;Y relation</span></span>
<span id="cb2-27">    sdy <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb2-28">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;-%</span> param     </span>
<span id="cb2-29">  </span>
<span id="cb2-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exogenous selection predictor</span></span>
<span id="cb2-31">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdl)</span>
<span id="cb2-32">  </span>
<span id="cb2-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment</span></span>
<span id="cb2-34">  A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob=</span>p)</span>
<span id="cb2-35">  </span>
<span id="cb2-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mediator</span></span>
<span id="cb2-37">  noise.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdm)</span>
<span id="cb2-38">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.M</span>
<span id="cb2-39">  </span>
<span id="cb2-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Selection mechanism</span></span>
<span id="cb2-41">  noise.S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sds)</span>
<span id="cb2-42">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(g0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> g3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-43">  </span>
<span id="cb2-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outcome</span></span>
<span id="cb2-45">  noise.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sdy)</span>
<span id="cb2-46">  Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise.Y</span>
<span id="cb2-47">  </span>
<span id="cb2-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># true ATE</span></span>
<span id="cb2-49">  true.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a1</span>
<span id="cb2-50">  </span>
<span id="cb2-51">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data</span></span>
<span id="cb2-52">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(L,A,M,S,Y)</span>
<span id="cb2-53">  </span>
<span id="cb2-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return</span></span>
<span id="cb2-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(dat,true.ATE))</span>
<span id="cb2-56">}</span></code></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="simulation-excercise" class="level1">
<h1>Simulation excercise</h1>
<p>This case of <img src="https://latex.codecogs.com/png.latex?M"> not being a direct cause of <img src="https://latex.codecogs.com/png.latex?S"> is equivalent to setting <img src="https://latex.codecogs.com/png.latex?%5Cgamma_2=0"> in the structural equation of the selection mechanism <img src="https://latex.codecogs.com/png.latex?S">. Let us simulate some noisy data:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set random seed</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters values</span></span>
<span id="cb3-5">param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdl=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection predictor</span></span>
<span id="cb3-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Treatment assigment probability</span></span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a0=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;M relation</span></span>
<span id="cb3-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdm=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of mediator noise</span></span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;S relation</span></span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g2=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;S relation </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">###</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> M DOES NOT CAUSE S</span></span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g3=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;S relation</span></span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sds=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb3-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters of A-&gt;Y relation</span></span>
<span id="cb3-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b2=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of M-&gt;Y relation</span></span>
<span id="cb3-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b3=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.8</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter of L-&gt;Y relation</span></span>
<span id="cb3-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdy=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.7</span>)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stdr. dev. of selection noise</span></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate data</span></span>
<span id="cb3-21">dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgp</span>(param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the full data</span></span>
<span id="cb3-24">dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the true ATE</span></span>
<span id="cb3-27">T.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dgp<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Glimpse of the data</span></span>
<span id="cb3-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">L</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">A</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">M</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2.2872472</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.2988695</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.0302749</td>
</tr>
<tr class="even">
<td style="text-align: right;">-1.1967717</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.5175524</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.7544911</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.6942925</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0183553</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-3.2428682</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.4122930</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.3229087</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2.8405141</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.9706733</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.7833466</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-4.9430929</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.9472799</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.6778373</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-5.7906748</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can compute the true ATE underlying this SCM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True ATE</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>T.ATE) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">True.ATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.75</td>
</tr>
</tbody>
</table>


</div>
</div>
<hr>
<section id="results-under-no-exclusion-complete-data" class="level2">
<h2 class="anchored" data-anchor-id="results-under-no-exclusion-complete-data">Results under no exclusion (complete data)</h2>
<p>For a moment let us pretend we observe all variables for everyone. Let us examine the most interesting models that we can fit with the simulated data, to check their ability to recover population-level parameters under noisy samples.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for M, with complete data</span></span>
<span id="cb5-2">mod.M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for S, with complete data</span></span>
<span id="cb5-5">mod.S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probit'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for Y, with complete data</span></span>
<span id="cb5-8">mod.Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with complete data</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Version 1: Controlling for predictor of Y</span></span>
<span id="cb5-12">mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-13"></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with complete data</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Version 2: Treatment is randomized, no controls needed</span></span>
<span id="cb5-16">mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All models put together</span></span>
<span id="cb5-19">models.full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.M, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.S, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.Y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE (O-set)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE (no adj)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>)</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summary of models</span></span>
<span id="cb5-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(models.full, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statistic =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[{conf.low}, {conf.high}]"</span>,</span>
<span id="cb5-23">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{estimate}{stars}"</span>) </span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">M</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE (O-set)</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE (no adj)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;">0.104***</td>
<td style="text-align: center;">−0.107+</td>
<td style="text-align: center;">−1.579***</td>
<td style="text-align: center;">−1.498***</td>
<td style="text-align: center;">−1.524***</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">[0.069, 0.139]</td>
<td style="text-align: center;">[−0.219, 0.005]</td>
<td style="text-align: center;">[−1.816, −1.342]</td>
<td style="text-align: center;">[−1.732, −1.263]</td>
<td style="text-align: center;">[−1.803, −1.245]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: center;">0.506***</td>
<td style="text-align: center;">0.296***</td>
<td style="text-align: center;">0.281</td>
<td style="text-align: center;">0.677***</td>
<td style="text-align: center;">0.742***</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;">[0.456, 0.556]</td>
<td style="text-align: center;">[0.135, 0.457]</td>
<td style="text-align: center;">[−0.114, 0.675]</td>
<td style="text-align: center;">[0.340, 1.013]</td>
<td style="text-align: center;">[0.342, 1.141]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">L</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.427***</td>
<td style="text-align: center;">1.755***</td>
<td style="text-align: center;">1.768***</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">[0.341, 0.514]</td>
<td style="text-align: center;">[1.584, 1.925]</td>
<td style="text-align: center;">[1.597, 1.940]</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">M</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.784***</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: left; box-shadow: 0px 1px;"></td>
<td style="text-align: center; box-shadow: 0px 1px;"></td>
<td style="text-align: center; box-shadow: 0px 1px;"></td>
<td style="text-align: center; box-shadow: 0px 1px;">[0.369, 1.200]</td>
<td style="text-align: center; box-shadow: 0px 1px;"></td>
<td style="text-align: center; box-shadow: 0px 1px;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Num.Obs.</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">R2</td>
<td style="text-align: center;">0.283</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.311</td>
<td style="text-align: center;">0.301</td>
<td style="text-align: center;">0.013</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R2 Adj.</td>
<td style="text-align: center;">0.282</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">0.308</td>
<td style="text-align: center;">0.300</td>
<td style="text-align: center;">0.012</td>
</tr>
<tr class="even">
<td style="text-align: left;">AIC</td>
<td style="text-align: center;">1022.7</td>
<td style="text-align: center;">1278.2</td>
<td style="text-align: center;">4824.1</td>
<td style="text-align: center;">4835.8</td>
<td style="text-align: center;">5178.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BIC</td>
<td style="text-align: center;">1037.5</td>
<td style="text-align: center;">1292.9</td>
<td style="text-align: center;">4848.7</td>
<td style="text-align: center;">4855.5</td>
<td style="text-align: center;">5193.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Log.Lik.</td>
<td style="text-align: center;">−508.364</td>
<td style="text-align: center;">−636.108</td>
<td style="text-align: center;">−2407.072</td>
<td style="text-align: center;">−2413.913</td>
<td style="text-align: center;">−2586.403</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RMSE</td>
<td style="text-align: center;">0.40</td>
<td style="text-align: center;">0.47</td>
<td style="text-align: center;">2.69</td>
<td style="text-align: center;">2.70</td>
<td style="text-align: center;">3.21</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Since the treatment is randomized, no <em>control</em> variables are required in the regression of <img src="https://latex.codecogs.com/png.latex?Y"> against <img src="https://latex.codecogs.com/png.latex?A"> to remove confounding bias. However, <img src="https://latex.codecogs.com/png.latex?L"> is in the <img src="https://latex.codecogs.com/png.latex?O">-set of the effect; this is, controlling for <img src="https://latex.codecogs.com/png.latex?L"> produces an asymptotically more efficient estimator. Such property is not seen in finite samples [see last two models].</p>
<p>It is no surprise that, with complete data, the point-estimate for the coefficient of <img src="https://latex.codecogs.com/png.latex?A"> in the last two models lie close to the true ATE (0.75), even under a moderately noisy DGP (<img src="https://latex.codecogs.com/png.latex?R%5E2%5Capprox%200.3">).</p>
<hr>
</section>
<section id="results-under-exclusion" class="level2">
<h2 class="anchored" data-anchor-id="results-under-exclusion">Results under exclusion</h2>
<p>Ignoring samples for which <img src="https://latex.codecogs.com/png.latex?S=0"> reduces sample size from 1000 to 514. This is, the probability of exclusion is about 0.486.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of observation per selection</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 = selected / observed</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 = excluded</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>S) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col.names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">486</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">514</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>In contrast with the complete data case, a regression-based approach for estimating the ATE with only the selected samples <strong>does</strong> require controlling for <img src="https://latex.codecogs.com/png.latex?L">, since conditioning on <img src="https://latex.codecogs.com/png.latex?S"> opens the non-causal path:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?A%5Clongrightarrow%20S%5Clongleftarrow%20L%5Clongrightarrow%20Y"></li>
</ul>
<p>Unfortunately, controlling for <img src="https://latex.codecogs.com/png.latex?L"> alone <strong>does not</strong> remove selection bias, despite blocking such path. This is because <strong>the distribution of</strong> <img src="https://latex.codecogs.com/png.latex?L"> <strong>in the sample does not necessarily match the distribution in the population</strong>.</p>
<p>Let us inspect it.</p>
<section id="regression-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="regression-based-approach">Regression-based approach:</h3>
<p>We fit a model for the outcome <img src="https://latex.codecogs.com/png.latex?Y"> against <img src="https://latex.codecogs.com/png.latex?A">, controlling for <img src="https://latex.codecogs.com/png.latex?L">, using only the selected samples:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data for the selected sample</span></span>
<span id="cb7-2">dat.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-3">N.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s)</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for causal effect, with selected</span></span>
<span id="cb7-6">mod.ate.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat.s)</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATE(S=1)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod.ate.s), </span>
<span id="cb7-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statistic =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb7-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{estimate}{stars} [{conf.low}, {conf.high}]"</span>) </span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">ATE(S=1)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;">−1.341*** [−1.688, −0.995]</td>
</tr>
<tr class="even">
<td style="text-align: left;">A</td>
<td style="text-align: center;">0.516* [0.058, 0.974]</td>
</tr>
<tr class="odd">
<td style="text-align: left; box-shadow: 0px 1px;">L</td>
<td style="text-align: center; box-shadow: 0px 1px;">1.843*** [1.601, 2.085]</td>
</tr>
<tr class="even">
<td style="text-align: left;">Num.Obs.</td>
<td style="text-align: center;">514</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R2</td>
<td style="text-align: center;">0.307</td>
</tr>
<tr class="even">
<td style="text-align: left;">R2 Adj.</td>
<td style="text-align: center;">0.304</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AIC</td>
<td style="text-align: center;">2458.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">BIC</td>
<td style="text-align: center;">2475.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Log.Lik.</td>
<td style="text-align: center;">−1225.026</td>
</tr>
<tr class="even">
<td style="text-align: left;">RMSE</td>
<td style="text-align: center;">2.62</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The resulted 95% confidence interval for the coefficient of <img src="https://latex.codecogs.com/png.latex?A">, using only samples for which <img src="https://latex.codecogs.com/png.latex?S=1">, still covers the true ATE (0.75). Yet, a downwards bias shrinks the point-estimate and its lower bound noticeably. Using this, we would conclude the ATE is smaller than what truly is.</p>
<p>Let us implement an IPW-based approach to compare against:</p>
</section>
<section id="ipw-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="ipw-based-approach">IPW-based approach:</h3>
<p>Given the SCM, and the assumption of <img src="https://latex.codecogs.com/png.latex?%5Cgamma_2=0">, we can express:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?w_i=%5Cmathbb%7BP%7D(S=1)/%5Cmathbb%7BP%7D(S=1%5Cmid%20A=a_i,L=l_i)"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?v_i(a)=1/%5Cmathbb%7BP%7D(A=a)%20=%201/q"> because treatment is randomized</p></li>
</ul>
<p>The derived finite-sample estimator of the mean counterfactuals / potential outcomes is: <img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7BY%7D%5Ea%20=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Cmathbb%7BI%7D(A_i=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a_i,L=l_i)%7D%5Ccdot%20y_i%0A"></p>
<p>Putting all ingredients together we get point-estimates <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%5E1=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20do(A=1)%5D"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%5E0=%5Chat%7B%5Cmathbb%7BE%7D%7D%5BY%5Cmid%20do(A=0)%5D">:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the probability of selecton for all the units selected</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We leverage the model mod.S, trained on complete data since S, A and L are</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># always observed (Y is the only one missing) and predict only on the selected units</span></span>
<span id="cb8-4">prob.s.unit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod.S, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span>dat.s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The unconditional probability of selection can be consistently estimated </span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#... with counts from the total sample size and selected sample size</span></span>
<span id="cb8-8">prob.s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Since the treatment is randomized, the propensity score in the population is known at 0.5. </span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It can also be estimated from counts in the complete dataset</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prop.score = sum(dat.1$A==1)/nrow(dat.1)</span></span>
<span id="cb8-13">prop.score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb8-16">est.PO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit),</span>
<span id="cb8-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s),</span>
<span id="cb8-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score),</span>
<span id="cb8-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb8-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb8-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.Y =</span> weights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PO'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.Y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N.s)</span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print resulted estimates</span></span>
<span id="cb8-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(est.PO) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">A</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PO</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">-1.4318076</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.7537995</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Which, can be used to compute a point-estimate of the ATE: <img src="https://latex.codecogs.com/png.latex?%5Chat%7BATE%7D=%5Chat%7BY%7D%5E1-%5Chat%7BY%7D%5E0">:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print estimated ATE</span></span>
<span id="cb9-2">est.ATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IPW ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>est.ATE) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">IPW.ATE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.678008</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can see that the IPW-based approach produces a point-estimate closer to the true ATE. To get valid confidence intervals, however, a bootstrapping or asymptotic analysis need to be invoked. We can compute naïve confidence interval without resampling, using the fact:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7B%5Ctext%7BATE%7D%7D)%20%5Cgeq%20%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7BY%7D%5E1)+%5Chat%7B%5Ctext%7Bvar%7D%7D(%5Chat%7BY%7D%5E0)=(N-2)%5E%7B-2%7D%5Csum_%7Ba%5Cin%5C%7B0,1%5C%7D%7D%5Csum_%7Bi=1%7D%5EN%20%5Cmathbb%7BI%7D(A_i=a)%5Ccdot%20%5Chat%7Bv%7D_i(a)%5E2%5Chat%7Bw%7D_i%5E2(y_i-%5Chat%7BY%7D%5Ea)%5E2%0A">Such variance is naïve in the sense that it is overconfident due to ignoring the covariance between the potential outcomes, and the higher-order contributions of the weighting factors in the total variance. Anyway, using it will get us:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb10-2">sd.PO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit),</span>
<span id="cb10-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s),</span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score),</span>
<span id="cb10-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb10-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb10-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.var =</span> weights<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ( A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.PO[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb10-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sd'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.var))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(N.s<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-2</span>))</span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve confidence interval</span></span>
<span id="cb10-13">naivebounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sd.PO[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb10-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IPW ATE'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE),</span>
<span id="cb10-15">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'naïve LB'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>naivebounds,</span>
<span id="cb10-16">           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'naïve UB'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(est.ATE)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>naivebounds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">IPW.ATE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">naïve.LB</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">naïve.UB</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.678008</td>
<td style="text-align: right;">0.5741569</td>
<td style="text-align: right;">0.7818592</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>As noted, the naïve confidence interval is tighter than those produced by inference on the complete data. This means such confidence interval is not statistically valid, but it can still help us visualize the convergence of IPW estimator.</p>
<p>Now, if we simulate and repeat the DGP and same analysis for different sample sizes, consistency would be visually perceived if we see:</p>
<ul>
<li><p>Point-estimate converging to the true ATE</p></li>
<li><p>Confidence intervals shrinking at a fast (**) rate</p></li>
</ul>
<p>Let us test it. We run 20 simulations with different complete sample sizes, from <img src="https://latex.codecogs.com/png.latex?N=500"> to <img src="https://latex.codecogs.com/png.latex?N=23%5C,000"> [number of complete samples from <img src="https://latex.codecogs.com/png.latex?N_s=250"> to <img src="https://latex.codecogs.com/png.latex?N_s=12%5C,000">]. We repeat the procedure three times and average the results on those three repetitions. Such averages are presented in the following table:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data frame to save results from iterations</span></span>
<span id="cb11-2">rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Ns=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">EST=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LB=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">UB=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All sample sizes to consider</span></span>
<span id="cb11-5">samplesizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>)))</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of repetitions</span></span>
<span id="cb11-8">M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Paramaters are the same as before</span></span>
<span id="cb11-11">param.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> param<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span></span>
<span id="cb11-12"></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Seed</span></span>
<span id="cb11-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>)</span>
<span id="cb11-15"></span>
<span id="cb11-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop</span></span>
<span id="cb11-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(m <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>M){</span>
<span id="cb11-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> samplesizes){</span>
<span id="cb11-19">    </span>
<span id="cb11-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change sample size</span></span>
<span id="cb11-21">    param.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> n</span>
<span id="cb11-22">    </span>
<span id="cb11-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the data (complete and selected)</span></span>
<span id="cb11-24">    dat.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgp</span>(param.iter)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb11-25">    dat.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-26">    </span>
<span id="cb11-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated probability of selection</span></span>
<span id="cb11-28">    N.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.s.iter)</span>
<span id="cb11-29">    prob.s.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> N.s.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n</span>
<span id="cb11-30">    </span>
<span id="cb11-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model for S, with complete data</span></span>
<span id="cb11-32">    mod.S.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probit'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat.iter)</span>
<span id="cb11-33">    prob.s.unit.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod.S.iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span>dat.s.iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>)</span>
<span id="cb11-34">  </span>
<span id="cb11-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Propensity score model</span></span>
<span id="cb11-36">    prop.score.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(dat.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat.iter)</span>
<span id="cb11-37">    </span>
<span id="cb11-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put everything together</span></span>
<span id="cb11-39">    row.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dat.s.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-40">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s.unit =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.unit.iter),</span>
<span id="cb11-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob.s =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prob.s.iter),</span>
<span id="cb11-42">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop.score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(prop.score.iter),</span>
<span id="cb11-43">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pro.weight =</span> (A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prop.score) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop.score),</span>
<span id="cb11-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> pro.weight <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob.s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>prob.s.unit),</span>
<span id="cb11-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.Y =</span> weights <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y) </span>
<span id="cb11-46">    </span>
<span id="cb11-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb11-48">    po.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> row.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-49">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y(A)'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.Y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N.s.iter)</span>
<span id="cb11-50">    </span>
<span id="cb11-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimated ATE</span></span>
<span id="cb11-52">    ATE.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-53">    </span>
<span id="cb11-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve variances</span></span>
<span id="cb11-55">    sd.PO.iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> row.iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-56">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted.var =</span> weights<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ( A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>po.iter[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-57">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-58">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sd'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(weighted.var))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(N.s.iter<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>))</span>
<span id="cb11-59">    </span>
<span id="cb11-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Naïve confidence interval</span></span>
<span id="cb11-61">    naivebounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sd.PO.iter[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-62">    </span>
<span id="cb11-63">    rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind.data.frame</span>(rounds.IPPW,</span>
<span id="cb11-64">                                   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span>n,</span>
<span id="cb11-65">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Ns=</span>N.s.iter,</span>
<span id="cb11-66">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">EST=</span>ATE.iter,</span>
<span id="cb11-67">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LB=</span>ATE.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>naivebounds,</span>
<span id="cb11-68">                                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">UB=</span>ATE.iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>naivebounds))</span>
<span id="cb11-69">  }</span>
<span id="cb11-70">}</span>
<span id="cb11-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print resulted estimates</span></span>
<span id="cb11-72">rounds.IPPW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> rounds.IPPW[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(N) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise_all</span>(mean)</span>
<span id="cb11-75"></span>
<span id="cb11-76"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(rounds.IPPW) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kbl</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable_styling</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_width =</span> F)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Ns</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">EST</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">LB</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">UB</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">500</td>
<td style="text-align: right;">249.6667</td>
<td style="text-align: right;">0.5919352</td>
<td style="text-align: right;">-0.1461034</td>
<td style="text-align: right;">1.3299737</td>
</tr>
<tr class="even">
<td style="text-align: right;">611</td>
<td style="text-align: right;">309.0000</td>
<td style="text-align: right;">0.7701710</td>
<td style="text-align: right;">0.1782066</td>
<td style="text-align: right;">1.3621354</td>
</tr>
<tr class="odd">
<td style="text-align: right;">746</td>
<td style="text-align: right;">379.6667</td>
<td style="text-align: right;">0.8962619</td>
<td style="text-align: right;">0.2991885</td>
<td style="text-align: right;">1.4933353</td>
</tr>
<tr class="even">
<td style="text-align: right;">911</td>
<td style="text-align: right;">453.6667</td>
<td style="text-align: right;">0.7438565</td>
<td style="text-align: right;">0.5811669</td>
<td style="text-align: right;">0.9065460</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1113</td>
<td style="text-align: right;">556.0000</td>
<td style="text-align: right;">0.7817429</td>
<td style="text-align: right;">0.3579693</td>
<td style="text-align: right;">1.2055165</td>
</tr>
<tr class="even">
<td style="text-align: right;">1359</td>
<td style="text-align: right;">679.0000</td>
<td style="text-align: right;">0.6411555</td>
<td style="text-align: right;">0.3223225</td>
<td style="text-align: right;">0.9599884</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>An the following plot:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Plot results from rounds</span></span>
<span id="cb12-2">rounds.IPPW[,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id.vars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ns'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(variable<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N. C.I.'</span>) ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>Ns,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>value,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group=</span>variable)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>type,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(x)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## O(N^0.5) convergence</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Value of estimate / bound'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'number of complete samples'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span>T.ATE, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://johandh2o.github.io/posts/2023-03-01_ipw/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>We can appreciate that the estimator converges to the true ATE [in red], and its uncertainty reduce at a sustained rate; there is <strong>convergence in probability</strong>. In other words, the IPW-based estimator is consistent.</p>
<section id="mathematical-justification-of-consistency" class="level4">
<h4 class="anchored" data-anchor-id="mathematical-justification-of-consistency">Mathematical justification of consistency</h4>
<p>We can prove consistency mathematically for this SCM. However, to avoid measure-theoretic conundrums, let us consider the case for which all variables are discrete. Results are generalizable for mixed discrete-continuous cases with positive distributions (no zero-measure events).</p>
<p>Let us assume <img src="https://latex.codecogs.com/png.latex?Y"> has support on <img src="https://latex.codecogs.com/png.latex?%5C%7By_%7B(c)%7D%5C%7D_%7Bc=1%7D%5EC">, and <img src="https://latex.codecogs.com/png.latex?L"> has support on <img src="https://latex.codecogs.com/png.latex?%5C%7Bl_%7B(k)%7D%5C%7D_%7Bk=1%7D%5EK">, then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Chat%7BY%7D%5Ea%20&amp;=%20N%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a_i,L=l_i)%7D%5Ccdot%20y_i%5Ccdot%20%5Cmathbb%7BI%7D(A_i=a)%20%5C%5C%0A&amp;=%0AN%5E%7B-1%7D%5Csum_%7Bi=1%7D%5EN%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_i)%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20A=a,L=l_i)%7D%5Ccdot%20y_i%5Ccdot%5Cmathbb%7BI%7D(A_i=a,S_i=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bi=1%7D%5EN%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_i)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_i%5Ccdot%5Cmathbb%7BI%7D(A_i=a,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_i,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bi=1%7D%5EN%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7Bi%7D%5Ccdot%5Cmathbb%7BI%7D(A_i=a,L_i=l_%7B(k)%7D,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%5Csum_%7Bi=1%7D%5EN%5Cmathbb%7BI%7D(Y_i=y_%7B(c)%7D,A_i=a,L_i=l_%7B(k)%7D,S_i=1)/N%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%20%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%5Chat%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%5Chat%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>Assuming the propensity scores and the probability of selection are both correctly specified, all finite-sample approximations <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cmathbb%7BP%7D%7D"> converge in the limit to the true distributions <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D">. Then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Bplim%7D_%7BN%5Crightarrow%5Cinfty%7D%0A%5Chat%7BY%7D%5Ea%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%7B%5Cmathbb%7BP%7D%7D(S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(S=1%5Cmid%20L=l_%7B(k)%7D)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%5Cfrac%7B%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D%5Cmid%20S=1)%0A%7D%5Ccdot%0A%5Cfrac%7B%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D,A=a,L=l_%7B(k)%7D%5Cmid%20S=1)%7D%7B%0A%7B%5Cmathbb%7BP%7D%7D(A=a%5Cmid%20L=l_%7B(k)%7D,S=1)%0A%7D%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%5Csum_%7Bc%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Ccdot%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D%5Cmid%20A=a,L=l_%7B(k)%7D%20S=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Csum_%7Bc%7D%0Ay_%7B(c)%7D%5Ccdot%7B%5Cmathbb%7BP%7D%7D(Y=y_%7B(c)%7D%5Cmid%20A=a,L=l_%7B(k)%7D,%20S=1)%5C%5C%0A&amp;=%0A%5Csum_%7Bk%7D%0A%7B%5Cmathbb%7BP%7D%7D(L=l_%7B(k)%7D)%0A%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,%20S=1)%5C%5C%0A&amp;=%0A%5Cmathbb%7BE%7D_L%0A%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,%20S=1)%20=%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a),L,S=1%5D%5C%5C%0A&amp;=%20%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a),L%5D%20=%20%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%0A%5Cend%7Baligned%7D%0A"></p>
<p>This is, the IPW estimator converges to the true counterfactual mean given by intervention <img src="https://latex.codecogs.com/png.latex?do(A=a)">. The last two equalities come from these facts:</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?L"> blocks all non-causal paths from <img src="https://latex.codecogs.com/png.latex?A"> to <img src="https://latex.codecogs.com/png.latex?Y"> when conditioning on <img src="https://latex.codecogs.com/png.latex?S=1"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?Y%5Cperp%20S%5C,%5Cmid%20L"> in the back-door graph: the resulting DAG after removing all arrows coming out of <img src="https://latex.codecogs.com/png.latex?A"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BP%7D(L=l_%7B(k)%7D)"> is the population-distribution of <img src="https://latex.codecogs.com/png.latex?L"></p></li>
</ul>
</section>
</section>
<section id="revisiting-the-regression-approach-generalized-adjustment-criteria" class="level3">
<h3 class="anchored" data-anchor-id="revisiting-the-regression-approach-generalized-adjustment-criteria">Revisiting the regression approach: generalized adjustment criteria</h3>
<p>Notice that, in the convergence proof for the IPW estimator, it was shown that the underlying estimand is algebraically equivalent to a regression-adjusted mean of <img src="https://latex.codecogs.com/png.latex?Y">, averaged over the population distribution of <img src="https://latex.codecogs.com/png.latex?L">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbb%7BE%7D%5BY%5Cmid%20do(A=a)%5D%20=%20%5Cmathbb%7BE%7D_L%5Cmathbb%7BE%7D(Y%5Cmid%20A=a,L,S=1)%0A"></p>
<p>Extensions of this results are covered by three <strong><em>generalized adjustment criteria</em></strong> <span class="citation" data-cites="Correa_Tian_Bareinboim_2018">(Correa, Tian, and Bareinboim 2018)</span>. This is, for this case, a mathematically equivalent result in term of consistency can be achieved via regression adjustment.</p>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Correa_Tian_Bareinboim_2018" class="csl-entry">
Correa, Juan, Jin Tian, and Elias Bareinboim. 2018. <span>“Generalized Adjustment Under Confounding and Selection Biases.”</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 32 (1). <a href="https://doi.org/10.1609/aaai.v32i1.12125">https://doi.org/10.1609/aaai.v32i1.12125</a>.
</div>
<div id="ref-pearl2009" class="csl-entry">
Pearl, Judea. 2009. <span>“Causality,”</span> September. <a href="https://doi.org/10.1017/cbo9780511803161">https://doi.org/10.1017/cbo9780511803161</a>.
</div>
</div></section></div> ]]></description>
  <category>IPW</category>
  <category>selection bias</category>
  <guid>https://johandh2o.github.io/posts/2023-03-01_ipw/index.html</guid>
  <pubDate>Tue, 28 Feb 2023 23:00:00 GMT</pubDate>
  <media:content url="https://johandh2o.github.io/posts/2023-03-01_ipw/logo.png" medium="image" type="image/png" height="145" width="144"/>
</item>
</channel>
</rss>
